<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Quiz Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        /* --- CRITICAL STYLES FOR FOUC PREVENTION --- */
        :root {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #fff; --card-bg: #222; --link-hover: #ffffff;
            --accent-rgb: 255, 255, 255;
        }
        body.theme-cyan {
            --bg-primary: #000; --bg-secondary: #0b0b0b; --text-primary: #e0ffff;
            --accent: #00f6ff; --card-bg: #072a2c; --accent-rgb: 0, 246, 255;
        }
        body.theme-purple {
            --bg-primary: #0d001a; --bg-secondary: #14002b; --text-primary: #ffe6ff;
            --accent: #cc66ff; --card-bg: #1d0036; --accent-rgb: 204, 102, 255;
        }
        body.theme-green {
            --bg-primary: #001a00; --bg-secondary: #002b00; --text-primary: #e6ffe6;
            --accent: #66ff66; --card-bg: #003600; --accent-rgb: 102, 255, 102;
        }
        body.theme-blackwhite {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #e0e0e0; --card-bg: #222; --accent-rgb: 224, 224, 224;
        }
        body.theme-red {
            --bg-primary: #1a0000; --bg-secondary: #2b0000; --text-primary: #ffe6e6;
            --accent: #ff3333; --card-bg: #360000; --accent-rgb: 255, 51, 51;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.6s, color 0.6s;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .particle { position: absolute; border-radius: 50%; background: var(--accent); opacity: 0.7; pointer-events: none; will-change: transform; }

        /* --- Page-Specific Styles --- */
        .main-content { width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        .hero { text-align: center; padding: 50px 20px 30px; position: relative; z-index: 5; }
        .hero h1 { font-size: 3.2rem; text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent); margin-bottom: 20px; }
        .hero p { font-size: 1.2rem; margin: 0 auto 30px; text-shadow: 0 0 8px var(--accent); max-width: 600px; }
        .container {
            max-width: 900px; width: 90%; margin: 20px auto 40px auto; padding: 20px;
            background-color: var(--bg-secondary); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;
            gap: 20px; position: relative;
        }
        .step-content { display: none; flex-direction: column; gap: 10px; animation: fadeIn 0.5s ease-in-out; }
        .step-content.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .step-header .title { flex: 2 1 auto; text-align: center; font-size: 1.25rem; font-weight: 600; margin: 0 1rem; }
        .step-header .btn-container { flex: 1 0 0; }
        
        .nav-button, .button, .generate-button, .clear-button, .start-quiz-button {
            background-color: var(--accent); color: var(--bg-primary); border: none;
            padding: 12px 25px; border-radius: 9999px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(var(--accent-rgb), 0.5);
        }
        .nav-button:hover:not(:disabled), .button:hover, .generate-button:hover, .clear-button:hover, .start-quiz-button:hover {
            transform: translateY(-3px); box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.7);
        }
        .clear-button { background-color: #4a5568; color: var(--text-primary); box-shadow: 0 4px 15px rgba(var(--accent-rgb), 0.2); }
        .clear-button:hover { background-color: #2d3748; box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.3); }
        .nav-button:disabled, .button:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed !important; box-shadow: none !important; transform: none !important; }
        
        textarea {
            width: 100%; padding: 15px; border: 1px solid var(--accent); border-radius: 8px;
            background-color: var(--card-bg); color: var(--text-primary); font-size: 1rem;
            resize: vertical; min-height: 150px; transition: border-color 0.3s, background-color 0.3s;
        }
        textarea:focus { outline: none; border-color: var(--text-primary); box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); }
        .file-upload-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; align-items: center; }
        .file-input-wrapper { position: relative; display: flex; align-items: center; gap: 10px; width: 100%; max-width: 400px; }
        .file-input-label { background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent); padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; white-space: nowrap; z-index: 1; }
        .file-input-label:hover { background: var(--accent); color: var(--bg-primary); }
        #fileInput { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 2; }
        .file-name-display { flex-grow: 1; padding: 8px 10px; border: 1px solid var(--card-bg); border-radius: 8px; background-color: var(--bg-primary); color: rgba(var(--accent-rgb), 0.8); font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-clear-button { background: none; border: none; color: var(--accent); font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-clear-button:hover { color: var(--text-primary); }
        .file-list-container { width: 100%; max-width: 400px; margin-top: 15px; }
        .file-list-toggle-button { background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; margin-bottom: 10px; width: 100%; }
        .file-list-toggle-button:hover { background: var(--accent); color: var(--bg-primary); }
        .file-list { list-style: none; padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; border: 1px solid var(--card-bg); border-radius: 8px; background-color: var(--bg-primary); }
        .file-list.expanded { max-height: 200px; overflow-y: auto; padding: 10px; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid rgba(var(--accent-rgb), 0.2); font-size: 0.9rem; }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item span { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-list-item button { background: none; border: none; color: #ff6666; font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-list-item button:hover { color: #ff0000; }
        .quiz-preview-area, .interactive-quiz-container { margin-top: 30px; text-align: left; width: 100%; }
        .quiz-question { background-color: var(--card-bg); border: 1px solid var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .quiz-question h3 { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 10px; }
        .quiz-question p { margin-bottom: 0.5rem; }
        .quiz-answer { margin-top: 10px; padding: 10px; background-color: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent); }
        .quiz-navigation { display: flex; justify-content: space-between; margin-top: 2rem; }
        .quiz-options-container { display: flex; flex-direction: column; gap: 10px; margin-top: 1rem; }
        .quiz-option-btn { background-color: var(--card-bg); border: 1px solid var(--accent); color: var(--text-primary); padding: 10px 15px; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s; }
        .quiz-option-btn:hover { background-color: rgba(var(--accent-rgb), 0.2); }
        .quiz-option-btn.selected { background-color: var(--accent); color: var(--bg-primary); font-weight: bold; }
        .quiz-results { text-align: left; }
        .quiz-results h2 { font-size: 1.8rem; color: var(--accent); text-align: center; margin-bottom: 1.5rem; }
        .result-item { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--card-bg); }
        .result-item.correct { border-left: 4px solid #4ade80; padding-left: 10px; }
        .result-item.incorrect { border-left: 4px solid #f87171; padding-left: 10px; }
        .start-quiz-area { text-align: center; }
        .message-box { padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem; text-align: left; border: 1px solid; }
        .message-box.info { background-color: rgba(var(--accent-rgb), 0.1); border-color: var(--accent); color: var(--text-primary); }
        .message-box.error { --error-rgb: 239, 68, 68; background-color: rgba(var(--error-rgb), 0.1); border-color: rgb(var(--error-rgb)); color: #fecaca; }
        .loading-bar-container { width: 100%; height: 8px; background-color: var(--card-bg); border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .loading-bar { height: 100%; width: 0%; background-color: var(--accent); border-radius: 4px; transition: width 0.4s ease-in-out; }
        .hidden { display: none; }
        footer.main-footer { width: 100%; text-align: center; padding: 20px; font-size: 0.9rem; background-color: var(--bg-secondary); position: relative; z-index: 10; }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 20px auto; padding: 15px; }
            .hero h1 { font-size: 2.2rem; }
            .generate-button, .clear-button, .nav-button, .start-quiz-button { width: 100%; font-size: 1rem; padding: 10px 20px; }
            .action-buttons, .quiz-navigation { flex-direction: column; gap: 10px; }
        }
    </style>
    <script>
        (function() {
            try {
                const theme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                document.documentElement.className = theme;
            } catch (e) {}
        })();
    </script>
</head>
<body>
  <div class="particles-container" id="particles"></div>
  <div id="header-container"></div>

  <main class="main-content animate-on-load">
    <section class="hero">
        <h1>AI Quiz Builder</h1>
        <p>Instantly generate quizzes from your notes, images, or PDFs.</p>
    </section>

    <div id="generatorContainer" class="container">
        <div id="step1" class="step-content">
            <div class="step-header">
                <div class="btn-container"></div>
                <h2 class="title">Step 1: Provide Material</h2>
                <div class="btn-container text-right"><button class="nav-button" onclick="nextStep()">Next</button></div>
            </div>
            <p class="subtitle">Provide the content from which the quiz questions will be generated.</p>
            <textarea id="inputText" placeholder="Enter text here... or paste an image (Ctrl+V)"></textarea>
            <div class="file-upload-container">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".txt,.md,.pdf,image/*" multiple>
                    <label for="fileInput" class="file-input-label">Upload Files</label>
                    <span id="fileNameDisplay" class="file-name-display">No files chosen</span>
                    <button id="clearFileButton" class="file-clear-button" style="display:none;">&times;</button>
                </div>
                <p class="subtitle">Supported: .txt, .md, images. PDFs extract text only.</p>
                <div class="file-list-container">
                    <button id="toggleFileListButton" class="file-list-toggle-button" style="display:none;">Show Uploaded Files (0)</button>
                    <ul id="fileList" class="file-list"></ul>
                </div>
            </div>
        </div>

        <div id="step2" class="step-content">
            <div class="step-header">
                <div class="btn-container text-left"><button class="nav-button" onclick="prevStep()">Back</button></div>
                <h2 class="title">Step 2: Customize Quiz</h2>
                <div class="btn-container text-right"><button class="nav-button" onclick="nextStep()">Next</button></div>
            </div>
            <p class="subtitle">Guide the AI on the type and difficulty of the quiz.</p>
            <textarea id="customInstructions" placeholder="e.g., 'Generate 10 multiple-choice questions with 4 options each', 'Focus on advanced concepts', 'Use a mix of true/false and short answer.'"></textarea>
        </div>

        <div id="step3" class="step-content">
            <div class="step-header">
                <div class="btn-container text-left"><button class="nav-button" onclick="prevStep()">Back</button></div>
                <h2 class="title">Step 3: Generate & Review</h2>
                <div class="btn-container"></div>
            </div>
            <p class="subtitle">You're all set! Click the button below to generate your quiz.</p>
        </div>

        <div id="action-buttons-container" class="hidden">
            <div class="action-buttons mt-4">
              <button id="generateButton" class="generate-button">Generate Quiz</button>
              <button id="clearButton" class="clear-button">Clear All & Reset</button>
            </div>
        </div>

        <div id="loadingBarContainer" class="loading-bar-container">
            <div id="loadingBar" class="loading-bar"></div>
        </div>
        <div id="messageBox" class="message-box hidden"></div>
        <div id="quizPreviewArea" class="quiz-preview-area hidden"></div>
        <div id="startQuizArea" class="start-quiz-area hidden mt-4">
            <button id="startQuizButton" class="start-quiz-button">Start Interactive Quiz</button>
        </div>
    </div>

    <div id="interactiveQuizContainer" class="container hidden"></div>
  </main>
  
  <footer class="main-footer">
      <p>&copy; 2025 Shkspr. All rights reserved.</p>
  </footer>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

async function loadHeader() {
  try {
    const response = await fetch('../Structure/header.html');
    if (!response.ok) throw new Error('Failed to load header');
    const text = await response.text();
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    
    const headElements = doc.querySelectorAll('head > *');
    headElements.forEach(el => {
        document.head.appendChild(el.cloneNode(true));
    });

    const headerContent = doc.querySelector('header.main-header');
    if (headerContent) {
        document.getElementById('header-container').appendChild(headerContent);
    }

    const scriptElement = doc.querySelector('script');
    if (scriptElement) {
        const newScript = document.createElement('script');
        newScript.textContent = scriptElement.textContent;
        document.body.appendChild(newScript);
    }
    
    if (window.setTheme && window.initParticles) {
        const savedTheme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
        window.setTheme(savedTheme);

        document.getElementById('theme-blackwhite-btn').addEventListener('click', () => window.setTheme('theme-blackwhite'));
        document.getElementById('theme-cyan-btn').addEventListener('click', () => window.setTheme('theme-cyan'));
        document.getElementById('theme-purple-btn').addEventListener('click', () => window.setTheme('theme-purple'));
        document.getElementById('theme-green-btn').addEventListener('click', () => window.setTheme('theme-green'));
        document.getElementById('theme-red-btn').addEventListener('click', () => window.setTheme('theme-red'));
    }
  } catch (error) {
    console.error('Error loading header:', error);
    document.getElementById('header-container').innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error loading header.</p>';
  }
}

function initializeQuizApp() {
    const ALL_GEMINI_MODELS = [
      'gemini-2.5-flash-lite', 'gemini-live-2.5-flash-preview', 'gemini-2.5-flash',
      'gemini-2.0-flash', 'gemini-2.0-flash-lite', 'gemini-1.5-flash', 'gemini-1.5-flash-8b',
    ];
    
    const dom = {
        generatorContainer: document.getElementById('generatorContainer'),
        interactiveQuizContainer: document.getElementById('interactiveQuizContainer'),
        startQuizArea: document.getElementById('startQuizArea'),
        startQuizButton: document.getElementById('startQuizButton'),
        quizPreviewArea: document.getElementById('quizPreviewArea'),
        inputText: document.getElementById('inputText'),
        customInstructions: document.getElementById('customInstructions'),
        generateButton: document.getElementById('generateButton'),
        clearButton: document.getElementById('clearButton'),
        actionButtonsContainer: document.getElementById('action-buttons-container'),
        messageBox: document.getElementById('messageBox'),
        loadingBarContainer: document.getElementById('loadingBarContainer'),
        loadingBar: document.getElementById('loadingBar'),
        steps: [document.getElementById('step1'), document.getElementById('step2'), document.getElementById('step3')],
        fileInput: document.getElementById('fileInput'),
        fileNameDisplay: document.getElementById('fileNameDisplay'),
        clearFileButton: document.getElementById('clearFileButton'),
        fileList: document.getElementById('fileList'),
        toggleFileListButton: document.getElementById('toggleFileListButton'),
    };

    let uploadedFilesData = [];
    let quizData = [];
    let userAnswers = [];
    let currentQuestionIndex = 0;
    let currentStep = 0;

    const shuffleArray = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    };

    const showMessage = (message, type = 'info') => {
        dom.messageBox.textContent = message;
        dom.messageBox.className = `message-box ${type}`;
        dom.messageBox.style.display = 'block';
        setTimeout(() => { dom.messageBox.style.display = 'none'; }, 5000);
    };

    const showStep = (index) => {
        dom.steps.forEach((step, i) => step.classList.toggle('active', i === index));
        currentStep = index;
        dom.actionButtonsContainer.classList.toggle('hidden', index !== dom.steps.length - 1);
    };
    
    window.nextStep = () => { if (currentStep < dom.steps.length - 1) showStep(currentStep + 1); };
    window.prevStep = () => { if (currentStep > 0) showStep(currentStep - 1); };

    const readFileContent = async (file) => {
        return new Promise(async (resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));
            if (file.type.startsWith('image/')) {
                reader.onload = (e) => resolve({ type: file.type, content: e.target.result.split(',')[1] });
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                try {
                    const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n';
                    }
                    resolve({ type: 'text/plain', content: text });
                } catch (e) { reject(e); }
            } else if (file.type.startsWith('text/')) {
                reader.onload = (e) => resolve({ type: 'text/plain', content: e.target.result });
                reader.readAsText(file);
            } else { reject(new Error(`Unsupported file type: ${file.type}`)); }
        });
    };

    const updateFileListDisplay = () => {
        dom.fileList.innerHTML = '';
        const hasFiles = uploadedFilesData.length > 0;
        dom.toggleFileListButton.style.display = hasFiles ? 'block' : 'none';
        dom.fileNameDisplay.textContent = hasFiles ? `${uploadedFilesData.length} file(s) chosen` : 'No files chosen';
        dom.clearFileButton.style.display = hasFiles ? 'inline-block' : 'none';
        dom.toggleFileListButton.textContent = `Show Uploaded Files (${uploadedFilesData.length})`;
        if (!hasFiles) dom.fileList.classList.remove('expanded');

        uploadedFilesData.forEach(file => {
            const li = document.createElement('li');
            li.className = 'file-list-item';
            li.innerHTML = `<span>${file.name}</span><button data-id="${file.id}">&times;</button>`;
            dom.fileList.appendChild(li);
        });
    };
    
    const callApiWithRetries = async (payload) => {
        let modelsToTry = shuffleArray([...ALL_GEMINI_MODELS]);
        let lastError = null;
        for (const model of modelsToTry) {
            console.log(`Attempting API call with model: ${model}`);
            try {
                const response = await fetch('/api/Quiz_API', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...payload, model })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}) with model ${model}: ${errorText}`);
                }
                const result = await response.json();
                if (result.quizQuestions && result.quizQuestions.length > 0) {
                    const validQuestions = result.quizQuestions.filter(q => q.question && q.answer && q.question.trim() !== '' && (typeof q.answer === 'string' ? q.answer.trim() !== '' : q.answer.primary_answer.trim() !== ''));
                    if (validQuestions.length > 0) {
                        return { quizQuestions: validQuestions };
                    }
                }
                lastError = new Error(`Model ${model} returned no valid questions.`);
            } catch (error) {
                console.warn(error.message);
                lastError = error;
            }
        }
        throw lastError || new Error("All API models failed.");
    };

    const generateQuiz = async () => {
        const text = dom.inputText.value.trim();
        const instructions = dom.customInstructions.value.trim();
        if ((!text || text.length < 50) && uploadedFilesData.length === 0) {
            showMessage('Please provide at least 50 characters of text or upload a file.', 'error');
            return;
        }
        quizData = [];
        dom.quizPreviewArea.classList.add('hidden');
        dom.startQuizArea.classList.add('hidden');
        dom.loadingBarContainer.style.display = 'block';
        dom.loadingBar.style.width = '0%';
        
        showMessage('Generating quiz... This may take a moment.', 'info');
        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 90) { progress += 5; dom.loadingBar.style.width = `${progress}%`; }
        }, 200);

        try {
            let promptParts = [];
            const basePrompt = "You are a professional quiz designer. Your task is to create a well-structured and informative quiz from the provided material. The quiz should test key concepts, facts, and understanding. Ensure the questions are clear and the answers are accurate and concise. If the provided material is too short or unsuitable for generating a meaningful quiz, return a single question object explaining the issue.";
            
            promptParts.push({ text: basePrompt });
            if (text) promptParts.push({ text: `\n\nHere is the source text:\n"${text}"` });
            
            uploadedFilesData.forEach(file => {
                if (file.type.startsWith('image/')) {
                    promptParts.push({ text: `\n\nAnalyze the following image (${file.name}):` }, { inlineData: { mimeType: file.type, data: file.content } });
                } else {
                    promptParts.push({ text: `\n\nAnalyze the following text from the file (${file.name}):\n"${file.content}"` });
                }
            });
            
            const instructionPrompt = `\n\nBased on ALL the material provided, generate a quiz. ${instructions ? `Follow these specific instructions: "${instructions}".` : ''} The output MUST be a JSON array of objects, where each object has a 'question', 'answer', and 'type' ('multiple_choice', 'true_false', or 'short_answer'). For 'multiple_choice' questions, include an 'options' array with 4 choices. For 'short_answer', the 'answer' MUST be a JSON STRING representing an object with 'primary_answer' (a human-readable string), 'alternative_answers' (an array of 5-8 different but correct full-sentence answers), 'keywords' (an array of essential keywords extracted from all answers), and 'not_contains' (an array of forbidden keywords that would make an answer incorrect).`;
            promptParts.push({ text: instructionPrompt });
            
            const result = await callApiWithRetries({ contents: [{ role: "user", parts: promptParts }] });
            
            quizData = result.quizQuestions;
            renderQuizPreview(quizData);
            showMessage(`Quiz generated successfully! (${quizData.length} questions)`, 'info');

        } catch (error) {
            console.error('Error:', error);
            showMessage(`Failed to generate quiz: ${error.message}`, 'error');
        } finally {
            clearInterval(interval);
            dom.loadingBar.style.width = '100%';
            setTimeout(() => { dom.loadingBarContainer.style.display = 'none'; dom.loadingBar.style.width = '0%'; }, 500);
        }
    };

    const renderQuizPreview = (questions) => {
        dom.quizPreviewArea.innerHTML = '';
        if (!questions || questions.length === 0) {
            dom.quizPreviewArea.classList.add('hidden');
            dom.startQuizArea.classList.add('hidden');
            return;
        }
        
        questions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'quiz-question';
            
            const questionNumber = document.createElement('h3');
            questionNumber.textContent = `Question ${index + 1}: ${q.question}`;
            questionDiv.appendChild(questionNumber);

            const answerContainer = document.createElement('div');
            answerContainer.className = 'quiz-answer hidden';
            let answerText = q.answer;
            try {
                const answerObj = JSON.parse(q.answer);
                if (answerObj && answerObj.primary_answer) {
                    answerText = answerObj.primary_answer;
                }
            } catch(e) { /* Not a JSON string, display as is */ }
            answerContainer.innerHTML = `<p><strong>Answer:</strong> ${answerText}</p>`;
            
            const toggleButton = document.createElement('button');
            toggleButton.className = 'nav-button mt-2 !py-1 !px-3 !text-sm';
            toggleButton.textContent = 'Show Answer';
            
            toggleButton.addEventListener('click', () => {
                answerContainer.classList.toggle('hidden');
                toggleButton.textContent = answerContainer.classList.contains('hidden') ? 'Show Answer' : 'Hide Answer';
            });

            questionDiv.appendChild(toggleButton);
            questionDiv.appendChild(answerContainer);
            dom.quizPreviewArea.appendChild(questionDiv);
        });
        dom.quizPreviewArea.classList.remove('hidden');
        dom.startQuizArea.classList.remove('hidden');
    };

    const startQuiz = () => {
        userAnswers = new Array(quizData.length).fill(null);
        currentQuestionIndex = 0;
        dom.generatorContainer.classList.add('hidden');
        dom.interactiveQuizContainer.classList.remove('hidden');
        renderInteractiveQuestion(currentQuestionIndex);
    };

    const exitQuiz = () => {
        dom.interactiveQuizContainer.classList.add('hidden');
        dom.interactiveQuizContainer.innerHTML = '';
        dom.generatorContainer.classList.remove('hidden');
        renderQuizPreview(quizData);
    };

    const renderInteractiveQuestion = (index) => {
        dom.interactiveQuizContainer.innerHTML = '';
        const questionData = quizData[index];

        const questionDisplay = document.createElement('div');
        questionDisplay.className = 'quiz-question-display';
        questionDisplay.innerHTML = `<h3>Question ${index + 1} of ${quizData.length}</h3><p>${questionData.question}</p>`;
        
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'quiz-options-container';

        if (questionData.type === 'multiple_choice' || questionData.type === 'true_false') {
            const options = questionData.options || (questionData.type === 'true_false' ? ['True', 'False'] : []);
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option-btn';
                btn.textContent = option;
                if (userAnswers[index] === option) btn.classList.add('selected');
                btn.addEventListener('click', () => {
                    userAnswers[index] = option;
                    optionsContainer.querySelectorAll('.quiz-option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
                optionsContainer.appendChild(btn);
            });
        } else { // short_answer
            const textarea = document.createElement('textarea');
            textarea.placeholder = "Type your answer here...";
            textarea.value = userAnswers[index] || '';
            textarea.addEventListener('input', () => { userAnswers[index] = textarea.value; });
            optionsContainer.appendChild(textarea);
        }

        const navigation = document.createElement('div');
        navigation.className = 'quiz-navigation';
        const prevBtn = document.createElement('button');
        prevBtn.className = 'nav-button';
        prevBtn.textContent = 'Previous';
        prevBtn.disabled = index === 0;
        prevBtn.addEventListener('click', () => renderInteractiveQuestion(index - 1));

        const nextBtn = document.createElement('button');
        nextBtn.className = 'nav-button';
        if (index === quizData.length - 1) {
            nextBtn.textContent = 'Submit Quiz';
            nextBtn.addEventListener('click', submitQuiz);
        } else {
            nextBtn.textContent = 'Next';
            nextBtn.addEventListener('click', () => renderInteractiveQuestion(index + 1));
        }
        
        const exitBtn = document.createElement('button');
        exitBtn.className = 'nav-button';
        exitBtn.id = 'exitButton';
        exitBtn.textContent = 'Exit Quiz';
        exitBtn.addEventListener('click', exitQuiz);

        navigation.append(prevBtn, nextBtn);
        questionDisplay.appendChild(optionsContainer);
        dom.interactiveQuizContainer.append(questionDisplay, navigation, exitBtn);
    };

    const gradeShortAnswer = (userAnswer, correctAnswer) => {
        if (!userAnswer) return false;
        const userAnswerLower = userAnswer.toLowerCase();
        try {
            const answerObj = JSON.parse(correctAnswer);
            
            const requiredKeywords = (answerObj.keywords || []).map(k => k.toLowerCase());
            const forbiddenKeywords = (answerObj.not_contains || []).map(k => k.toLowerCase());

            if (requiredKeywords.length > 0) {
                const hasRequired = requiredKeywords.some(keyword => userAnswerLower.includes(keyword));
                const hasForbidden = forbiddenKeywords.length > 0 ? forbiddenKeywords.some(keyword => userAnswerLower.includes(keyword)) : false;
                if (hasRequired && !hasForbidden) return true;
            }

            const userWords = new Set(userAnswerLower.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(/\s+/));
            const alternativeAnswers = answerObj.alternative_answers || [answerObj.primary_answer];
            
            for (const altAnswer of alternativeAnswers) {
                const altWords = new Set(altAnswer.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(/\s+/));
                let matchCount = 0;
                for (const word of userWords) {
                    if (altWords.has(word)) matchCount++;
                }
                const similarity = (matchCount / userWords.size) * 100;
                if (similarity >= 50) return true;
            }
            
            return false;

        } catch (e) {
            return correctAnswer.toLowerCase().split(',').map(k => k.trim()).some(k => userAnswerLower.includes(k));
        }
    };

    const submitQuiz = () => {
        let score = 0;
        quizData.forEach((q, i) => {
            if (q.type === 'short_answer') {
                if (gradeShortAnswer(userAnswers[i], q.answer)) score++;
            } else {
                if (userAnswers[i] && q.answer && userAnswers[i].toLowerCase() === q.answer.toLowerCase()) {
                    score++;
                }
            }
        });

        dom.interactiveQuizContainer.innerHTML = '';
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'quiz-results';
        resultsDiv.innerHTML = `<h2>Quiz Complete!</h2><p style="text-align: center; font-size: 1.2rem; margin-bottom: 2rem;">You scored ${score} out of ${quizData.length}</p>`;
        
        quizData.forEach((q, i) => {
            const isCorrect = q.type === 'short_answer' ? gradeShortAnswer(userAnswers[i], q.answer) : (userAnswers[i] && q.answer && userAnswers[i].toLowerCase() === q.answer.toLowerCase());
            const item = document.createElement('div');
            item.className = isCorrect ? 'result-item correct' : 'result-item incorrect';
            let correctAnswerText = q.answer;
            try {
                const answerObj = JSON.parse(q.answer);
                if (answerObj && answerObj.primary_answer) {
                    correctAnswerText = answerObj.primary_answer;
                }
            } catch(e) { /* Not a JSON string, display as is */ }
            item.innerHTML = `
                <p><strong>Q:</strong> ${q.question}</p>
                <p><strong>Your Answer:</strong> ${userAnswers[i] || 'No answer'}</p>
                <p><strong>Correct Answer:</strong> ${correctAnswerText}</p>
            `;
            resultsDiv.appendChild(item);
        });

        const exitBtn = document.createElement('button');
        exitBtn.className = 'nav-button mt-4 mx-auto';
        exitBtn.id = 'exitButton';
        exitBtn.textContent = 'Back to Generator';
        exitBtn.addEventListener('click', exitQuiz);
        resultsDiv.appendChild(exitBtn);

        dom.interactiveQuizContainer.appendChild(resultsDiv);
    };

    // --- Event Listeners ---
    dom.fileInput.addEventListener('change', async (e) => {
        for (const file of e.target.files) {
            try {
                const { type, content } = await readFileContent(file);
                uploadedFilesData.push({ id: Date.now() + Math.random(), name: file.name, type, content });
                showMessage(`Loaded "${file.name}"`, 'info');
            } catch (error) { showMessage(`Error loading "${file.name}": ${error.message}`, 'error'); }
        }
        updateFileListDisplay();
        e.target.value = '';
    });

    dom.toggleFileListButton.addEventListener('click', () => dom.fileList.classList.toggle('expanded'));
    dom.fileList.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            uploadedFilesData = uploadedFilesData.filter(f => f.id !== parseFloat(e.target.dataset.id));
            updateFileListDisplay();
        }
    });
    dom.clearFileButton.addEventListener('click', () => { uploadedFilesData = []; updateFileListDisplay(); });
    dom.inputText.addEventListener('paste', (e) => {
        for (const item of e.clipboardData.items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                e.preventDefault();
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedFilesData.push({ id: Date.now(), name: 'Pasted Image', type: blob.type, content: event.target.result.split(',')[1] });
                    updateFileListDisplay();
                    showMessage('Image pasted.', 'info');
                };
                reader.readAsDataURL(blob);
                return;
            }
        }
    });

    dom.generateButton.addEventListener('click', generateQuiz);
    dom.startQuizButton.addEventListener('click', startQuiz);
    dom.clearButton.addEventListener('click', () => {
        dom.inputText.value = '';
        dom.customInstructions.value = '';
        uploadedFilesData = [];
        quizData = [];
        userAnswers = [];
        dom.quizPreviewArea.innerHTML = '';
        dom.quizPreviewArea.classList.add('hidden');
        dom.startQuizArea.classList.add('hidden');
        dom.interactiveQuizContainer.classList.add('hidden');
        dom.generatorContainer.classList.remove('hidden');
        updateFileListDisplay();
        showStep(0);
        showMessage('All content cleared.');
    });

    // Initialization
    showStep(0);
    updateFileListDisplay();
}

document.addEventListener('DOMContentLoaded', () => {
    loadHeader();
    initializeQuizApp();
});
</script>
</body>
</html>
