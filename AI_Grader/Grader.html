<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Assignment Grader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- Marked.js CDN for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- Theme Variables --- */
        :root {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #fff; --card-bg: #222; --link-hover: #ffffff;
            --accent-rgb: 255, 255, 255;
        }
        body.theme-cyan { --bg-primary: #000; --bg-secondary: #0b0b0b; --text-primary: #e0ffff; --accent: #00f6ff; --card-bg: #072a2c; --accent-rgb: 0, 246, 255; }
        body.theme-purple { --bg-primary: #0d001a; --bg-secondary: #14002b; --text-primary: #ffe6ff; --accent: #cc66ff; --card-bg: #1d0036; --accent-rgb: 204, 102, 255; }
        body.theme-green { --bg-primary: #001a00; --bg-secondary: #002b00; --text-primary: #e6ffe6; --accent: #66ff66; --card-bg: #003600; --accent-rgb: 102, 255, 102; }
        body.theme-blackwhite { --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff; --accent: #e0e0e0; --card-bg: #222; --accent-rgb: 224, 224, 224; }
        body.theme-red { --bg-primary: #1a0000; --bg-secondary: #2b0000; --text-primary: #ffe6e6; --accent: #ff3333; --card-bg: #360000; --accent-rgb: 255, 51, 51; }

        /* --- Global Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; font-weight: bold; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; transition: background-color 0.6s, color 0.6s; display: flex; flex-direction: column; overflow-x: hidden; }

        /* --- Styles specific to the Grader page --- */
        .hero { text-align: center; padding: 50px 20px 30px; position: relative; z-index: 5; }
        .hero h1 { font-size: 3.2rem; text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent); margin-bottom: 20px; }
        .hero p { font-size: 1.2rem; margin: 0 auto 30px; max-width: 600px; }
        .grader-container { max-width: 1000px; width: 95%; margin: 0 auto 2rem auto; background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0, 0.5); padding: 1.5rem; position: relative; z-index: 5; color: var(--text-primary); }
        .step-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        textarea { font-family: 'Fira Mono', monospace; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; width: 100%; min-height: 120px; resize: vertical; }
        input[type="text"], input[type="password"], input[type="file"] { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; width: 100%; }
        textarea:focus, input[type="text"]:focus, input[type="password"]:focus { outline: none; box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.5); }
        .grade-level-btn, .rubric-btn { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--text-primary); padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .grade-level-btn.selected, .rubric-btn.selected { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); font-weight: bold; }
        .grade-level-btn:hover, .rubric-btn:hover { opacity: 0.8; }
        input[type="file"] { display: none; }
        .file-input-label { display: inline-block; background: var(--bg-secondary); color: var(--accent); border: 1px solid var(--accent); padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; }
        .file-input-label:hover { background: var(--accent); color: var(--bg-primary); }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 10px; background: var(--bg-secondary); border-radius: 50px; outline: none; opacity: 0.7; transition: opacity .2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 25px; height: 25px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 0 5px var(--accent); }
        input[type="range"]::-moz-range-thumb { width: 25px; height: 25px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 0 5px var(--accent); }
        .nav-button, button#grade-button, .clear-button, .copy-button, #send-chat-button, #clear-chat-button { background: var(--accent); color: var(--bg-primary); padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); border: none; cursor: pointer; }
        .nav-button:hover, button#grade-button:hover, .clear-button:hover, .copy-button:hover, #send-chat-button:hover, #clear-chat-button:hover { box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.8); transform: translateY(-2px); }
        .nav-button:disabled, button#grade-button:disabled, #send-chat-button:disabled { background: #555 !important; color: #999 !important; cursor: not-allowed !important; box-shadow: none !important; transform: none !important; }
        .clear-button, #clear-chat-button { background: #4a5568; color: #fff; }
        .clear-button:hover, #clear-chat-button:hover { background: #2d3748; }
        .copy-button { background: #38a169; color: #fff; }
        .copy-button:hover { background: #2f855a; }
        #error-message, #success-message { padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem; text-align: center; border: 1px solid; }
        #error-message { background-color: rgba(239, 68, 68, 0.1); border-color: rgb(239, 68, 68); color: #fecaca; }
        #success-message { background-color: rgba(var(--accent-rgb), 0.1); border-color: var(--accent); color: var(--text-primary); }
        #grade-result { background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; }
        #grade-result h2 { color: var(--accent); }
        .prose { color: var(--text-primary); word-break: break-word; } .prose h1, .prose h2, .prose h3 { color: var(--accent); } .prose a { color: var(--accent); text-decoration: underline; } .prose strong { color: var(--text-primary); } .prose ul > li::before { background-color: var(--accent); }
        .file-list { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .file-list.expanded { max-height: 200px; overflow-y: auto; margin-top: 0.5rem; }
        .file-list-item { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent); padding: 0.5rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .file-list-item button { background: none; border: none; color: var(--accent); font-size: 1.2rem; cursor: pointer; line-height: 1; padding: 0.2rem; }
        .file-list-item button:hover { color: #ff4d4d; }
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .step-header .btn-container { flex: 1 0 0; }
        .step-header .title { flex: 2 1 auto; text-align: center; font-size: 1.25rem; font-weight: 600; margin: 0 1rem; }
        .description-text { min-height: 80px; line-height: 1.5; font-size: 0.875rem; color: #ccc; }
        .action-area { display: none; }
        footer.main-footer { text-align: center; padding: 20px; font-size: 0.9rem; color: var(--text-primary); background-color: var(--bg-secondary); position: relative; z-index: 10; margin-top: auto; }
        .loading-bar-container { width: 100%; height: 6px; background-color: rgba(var(--accent-rgb), 0.2); margin-top: 1.5rem; border-radius: 3px; position: relative; overflow: hidden; }
        .loading-bar { position: absolute; top: 0; left: 0; bottom: 0; background-color: var(--accent); width: 50%; animation: indeterminate-loading 2s infinite ease-in-out; }
        @keyframes indeterminate-loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
        .rubric-select { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; width: 100%; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%20164.2c-4.4%205.1-10.4%207.9-16.7%207.9s-12.3-2.8-16.7-7.9L146.2%2063.2l-107.4%20101c-4.4%205.1-10.4%207.9-16.7%207.9s-12.3-2.8-16.7-7.9c-9.1-10.4-8.1-26.6%202.3-35.7L130.4%2022.4c4.4-5.1%2010.4-7.9%2016.7-7.9s12.3%202.8%2016.7%207.9l118.8%20111.9c9.2%209.1%209.2%2024.1%200%2033.2z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px; }
        .rubric-select:focus { outline: none; box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.5); }
        .hidden { display: none; }
        .step-indicator-container { display: flex; justify-content: space-between; margin-bottom: 1.5rem; position: relative; }
        .step-indicator-bar { position: absolute; height: 4px; background-color: rgba(var(--accent-rgb), 0.3); top: 50%; transform: translateY(-50%); left: 0; right: 0; z-index: 1; }
        .step-indicator-progress { position: absolute; height: 4px; background-color: var(--accent); top: 50%; transform: translateY(-50%); left: 0; width: 0; z-index: 2; transition: width 0.4s ease-in-out; }
        .step-indicator { width: 30px; height: 30px; border-radius: 50%; background: var(--bg-secondary); border: 2px solid rgba(var(--accent-rgb), 0.3); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; z-index: 3; transition: all 0.4s ease-in-out; }
        .step-indicator.active { border-color: var(--accent); background: var(--accent); color: var(--bg-primary); font-weight: bold; }
        .step-indicator.completed { border-color: var(--accent); }
        .result-section { margin-bottom: 1.5rem; }
        .result-section h3 { color: var(--accent); border-bottom: 1px solid var(--accent); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .final-grade-display { background-color: var(--accent); color: var(--bg-primary); padding: 1rem 1.5rem; border-radius: 8px; text-align: center; margin-bottom: 1.5rem; }
        .final-grade-display p { margin: 0; font-size: 1.2rem; }
        .final-grade-display span { font-size: 2.5rem; font-weight: bold; display: block; }
        .chat-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .chat-modal { background: var(--card-bg); width: 90%; max-width: 700px; height: 80vh; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); display: flex; flex-direction: column; border: 1px solid var(--accent); }
        .chat-modal-header { padding: 1rem; border-bottom: 1px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .chat-modal-header h3 { margin: 0; font-size: 1.25rem; }
        .chat-modal-header-buttons { display: flex; gap: 0.5rem; }
        .chat-modal-close { background: none; border: none; color: var(--text-primary); font-size: 2rem; cursor: pointer; line-height: 1; }
        #chat-history { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .chat-message { margin-bottom: 1rem; display: flex; flex-direction: column; }
        .chat-message .prose { max-width: 100%; }
        .chat-message.user { align-items: flex-end; }
        .chat-message.model { align-items: flex-start; }
        .chat-message-bubble { max-width: 85%; padding: 0.75rem 1rem; border-radius: 12px; }
        .chat-message.user .chat-message-bubble { background: var(--accent); color: var(--bg-primary); }
        .chat-message.model .chat-message-bubble { background: var(--bg-secondary); }
        .chat-input-area { padding: 1rem; border-top: 1px solid var(--accent); display: flex; gap: 1rem; }
        #chat-input { min-height: 50px; height: 50px; }
    </style>
    <script>
        (function() { try { const theme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite'; document.documentElement.className = theme; } catch (e) { console.error("Failed to apply theme from localStorage", e); } })();
    </script>
</head>
<body>
    <div id="header-container"></div>
    <main class="main-content animate-on-load">

    <section class="hero">
        <h1>AI Assignment Grader</h1>
        <p>Leverage generative AI to automate assignment evaluation based on your specific instructions and rubric.</p>
    </section>

    <div class="grader-container">
        <div class="step-indicator-container">
            <div class="step-indicator-bar">
                <div id="step-indicator-progress" class="step-indicator-progress"></div>
            </div>
            <div class="step-indicator active" data-step="0">1</div>
            <div class="step-indicator" data-step="1">2</div>
            <div class="step-indicator" data-step="2">3</div>
            <div class="step-indicator" data-step="3">4</div>
            <div class="step-indicator" data-step="4">5</div>
        </div>

        <div>
            <div id="step-instructions" class="step-content">
                <div class="step-header">
                    <div class="btn-container text-left"><button type="button" class="nav-button opacity-0 pointer-events-none">Back</button></div>
                    <label class="title">1. Assignment Instructions</label>
                    <div class="btn-container text-right"><button type="button" class="nav-button">Next</button></div>
                </div>
                <textarea id="instructions" placeholder="E.g., 'Write a 500-word persuasive essay on renewable energy, with three supporting arguments.'"></textarea>
                <div class="flex items-center justify-between mt-2 space-x-2">
                    <label for="instructions-file" class="file-input-label flex-grow">Upload Files</label>
                    <button type="button" class="toggle-file-list-button nav-button text-sm !px-4 !py-2">Show Files</button>
                </div>
                <input type="file" id="instructions-file" accept=".txt,.md,.pdf,image/*" multiple>
                <ul id="instructions-file-list" class="file-list"></ul>
                <p class="description-text mt-2">Accepted: .txt, .md, .pdf, images. Both text and file content will be used. <strong>Note:</strong> For PDFs, only text is extracted. If instructions are an image, upload it directly.</p>
            </div>

            <div id="step-rubric" class="step-content hidden">
                <div class="step-header">
                    <div class="btn-container text-left"><button type="button" class="nav-button">Back</button></div>
                    <label class="title">2. Grading Rubric</label>
                    <div class="btn-container text-right"><button type="button" class="nav-button">Next</button></div>
                </div>
                <textarea id="rubric" placeholder="E.g., 'Content: 40%. Organization: 30%. Language: 20%. Originality: 10%.'"></textarea>
                <div class="flex items-center justify-between mt-2 space-x-2">
                    <label for="rubric-file" class="file-input-label flex-grow">Upload Files</label>
                    <button type="button" class="toggle-file-list-button nav-button text-sm !px-4 !py-2">Show Files</button>
                </div>
                <input type="file" id="rubric-file" accept=".txt,.md,.pdf,image/*" multiple>
                <ul id="rubric-file-list" class="file-list"></ul>
                <p class="description-text mt-2">Accepted: .txt, .md, .pdf, images. <strong>Note:</strong> For PDFs, only text is extracted. If your rubric is an image, upload it as a JPG/PNG file.</p>
            </div>

            <div id="step-essay" class="step-content hidden">
                <div class="step-header">
                    <div class="btn-container text-left"><button type="button" class="nav-button">Back</button></div>
                    <label class="title">3. Student's Assignment</label>
                    <div class="btn-container text-right"><button type="button" class="nav-button">Next</button></div>
                </div>
                <textarea id="essay" placeholder="Paste the student's assignment text here..."></textarea>
                <div class="flex items-center justify-between mt-2 space-x-2">
                    <label for="essay-file" class="file-input-label flex-grow">Upload Files</label>
                    <button type="button" class="toggle-file-list-button nav-button text-sm !px-4 !py-2">Show Files</button>
                </div>
                <input type="file" id="essay-file" accept=".txt,.md,.pdf,image/*" multiple>
                <ul id="essay-file-list" class="file-list"></ul>
                <p class="description-text mt-2">Accepted: .txt, .md, .pdf, images. <strong>.doc/.docx files cannot be read by the browser.</strong> Please convert to PDF, TXT, or copy-paste the text.</p>
            </div>

            <div id="step-extra-instructions" class="step-content hidden">
                <div class="step-header">
                    <div class="btn-container text-left"><button type="button" class="nav-button">Back</button></div>
                    <label class="title">4. Extra AI Instructions (Optional)</label>
                    <div class="btn-container text-right"><button type="button" class="nav-button">Next</button></div>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-semibold mb-2">Grade</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <button class="grade-level-btn" data-grade="Elementary">Elementary</button>
                        <button class="grade-level-btn" data-grade="Middle School">Middle School</button>
                        <button class="grade-level-btn" data-grade="High School">High School</button>
                        <button class="grade-level-btn" data-grade="AP Courses">AP Courses</button>
                        <button class="grade-level-btn" data-grade="Higher Ed">Higher Ed</button>
                        <button class="grade-level-btn" data-grade="IB">IB</button>
                    </div>
                </div>

                <div id="subject-quick-add" class="hidden mb-6 p-4 bg-[var(--bg-secondary)] rounded-lg">
                    <label for="subject-select" class="block text-lg font-semibold mb-2">Subject (based on selected Grade)</label>
                    <p class="text-sm text-gray-400 mb-4">Pick a subject to add targeted guidance to the prompt below. Subjects change automatically for AP, Higher Ed, and IB.</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <select id="subject-select" class="flex-grow rubric-select">
                            <option value="none" disabled selected>Select a subject...</option>
                        </select>
                        <button id="add-subject-to-prompt-btn" class="nav-button !rounded-full !px-6 !py-3">Add to Prompt</button>
                    </div>
                </div>

                <div id="rubric-quick-add" class="hidden mb-6 p-4 bg-[var(--bg-secondary)] rounded-lg">
                    <label for="rubric-select" class="block text-lg font-semibold mb-2">Rubric Quick-Add</label>
                    <p class="text-sm text-gray-400 mb-4">Choose a pre-defined rubric to add its details to the extra instructions prompt below.</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <select id="rubric-select" class="flex-grow rubric-select">
                            <option value="none" disabled selected>Select a rubric...</option>
                            <option value="IB Internal Assessment">IB Internal Assessment</option>
                            <option value="AP English Argument">AP English Argument</option>
                            <option value="AP Calculus">AP Calculus</option>
                            <option value="Higher Ed General Essay">Higher Ed General Essay</option>
                            <option value="Harvard Biology Lab Report">Harvard Biology Lab Report</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <button id="add-rubric-to-prompt-btn" class="nav-button !rounded-full !px-6 !py-3">Add to Prompt</button>
                    </div>
                </div>

                <textarea id="extra-instructions" placeholder="E.g., 'Pay close attention to originality.' or 'Focus only on grammar and spelling.'"></textarea>
                <p class="description-text mt-2">Provide any final, specific instructions for the AI on how to approach the grading. This step is optional.</p>
            </div>

            <div id="step-strictness" class="step-content hidden">
                <div class="step-header">
                    <div class="btn-container text-left"><button type="button" class="nav-button">Back</button></div>
                    <label class="title">5. Set Strictness & Grade</label>
                    <div class="btn-container text-right"><button type="button" class="nav-button opacity-0 pointer-events-none">Next</button></div>
                </div>
                <div class="mt-4">
                    <label for="strictness-meter" class="block text-lg font-semibold mb-2 text-center">
                        Grading Strictness: <span id="strictness-value" class="font-bold text-xl" style="color: var(--accent);">3</span>
                    </label>
                    <input type="range" id="strictness-meter" min="1" max="5" value="3" step="1" class="w-full">
                    <div class="flex justify-between text-sm mt-2 px-1">
                        <span>Lenient</span><span>Normal</span><span>Strict</span>
                    </div>
                </div>
                
                <div class="advanced-options-container" style="width: 100%; margin-top: 25px;">
                    <button id="toggleAdvancedButton" class="file-input-label" style="width: 100%; border-radius: 8px;">Advanced Options</button>
                    <div id="advancedOptions" class="hidden" style="width: 100%; padding: 15px; border: 1px solid var(--card-bg); border-radius: 8px; margin-top: 10px; background-color: var(--bg-primary);">
                        <label for="customApiKeyInput" style="font-size: 0.9rem; display: block; margin-bottom: 8px;">Custom API Key (optional, not stored)</label>
                        <input type="password" id="customApiKeyInput" placeholder="Enter your key to override the default" style="width: 100%; padding: 10px; background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent); border-radius: 6px;">
                        <button id="saveApiKeyButton" class="nav-button" style="width: auto; padding: 8px 15px; font-size: 0.9rem; margin-top: 10px;">Set Key for Session</button>
                        <p id="apiKeyMessage" style="font-size: 0.8rem; margin-top: 8px; color: var(--accent); height: 1em;"></p>
                    </div>
                </div>
            </div>

            <div id="action-area" class="mt-6 space-y-4">
                <button id="grade-button" class="w-full py-3">Grade Assignment</button>
                <div id="error-message" class="hidden p-4 rounded-lg relative text-center" role="alert"></div>
                <div id="success-message" class="hidden p-4 rounded-lg relative text-center" role="alert"></div>
                <button id="clear-button" class="w-full py-2.5 clear-button">Clear All &amp; Reset</button>
                <div id="loading-bar-container" class="loading-bar-container hidden">
                    <div class="loading-bar"></div>
                </div>
            </div>

            <div id="grade-result" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-center">Grading Results</h2>
                    <div class="flex gap-2">
                        <button id="copy-results-button" class="copy-button text-sm !px-4 !py-2">Copy</button>
                        <button id="start-follow-up-button" class="nav-button text-sm !px-4 !py-2">Ask a Follow-up</button>
                    </div>
                </div>
                <div id="result-content" class="prose max-w-none leading-relaxed"></div>
            </div>
        </div>
    </div>
</main>
    <footer class="main-footer">
        &copy; 2025 Shkspr. All rights reserved.
    </footer>

    <div id="chat-modal-overlay" class="chat-modal-overlay hidden">
        <div class="chat-modal">
            <div class="chat-modal-header">
                <h3>Follow-up Chat</h3>
                <div class="chat-modal-header-buttons">
                    <button id="clear-chat-button" class="nav-button text-sm !px-4 !py-2">Clear Chat</button>
                    <button id="chat-modal-close" class="chat-modal-close">&times;</button>
                </div>
            </div>
            <div id="chat-history"></div>
            <div class="chat-input-area">
                <textarea id="chat-input" placeholder="Ask a question about the feedback..."></textarea>
                <button id="send-chat-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        
        async function loadHeader() {
            try {
                const response = await fetch('../Structure/header.html');
                if (!response.ok) throw new Error('Failed to load header');
                const text = await response.text();
                const container = document.getElementById('header-container');
                container.innerHTML = text;
                const scriptElement = new DOMParser().parseFromString(text, 'text/html').querySelector('script');
                if (scriptElement) {
                    const newScript = document.createElement('script');
                    newScript.textContent = scriptElement.textContent;
                    document.body.appendChild(newScript);
                }
                if (window.setTheme) {
                    const savedTheme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                    window.setTheme(savedTheme);
                    ['blackwhite', 'cyan', 'purple', 'green', 'red'].forEach(theme => {
                        document.getElementById(`theme-${theme}-btn`).addEventListener('click', () => window.setTheme(`theme-${theme}`));
                    });
                }
            } catch (error) { console.error('Error loading header:', error); }
        }

        function initializeGraderApp() {
            // --- CONSTANTS & PRESETS ---
            const ALL_GEMINI_MODELS = ['gemini-1.5-flash', 'gemini-2.5-flash', 'gemini-2.0-flash'];
            const RUBRIC_TEXTS = { 'IB Internal Assessment': `\n- Criterion A: The topic and research question are well-focused and feasible.\n- Criterion B: The methodology is appropriate and ethical considerations are addressed.\n- Criterion C: The quality of the analysis and evaluation of the findings is high.\n- Criterion D: The conclusion is justified by the evidence presented.\n- Criterion E: The communication is clear, well-structured, and includes appropriate citations.\n`, 'AP English Argument': `\nThe AP English Argument essay rubric focuses on three main categories: Thesis, Evidence and Commentary, and Sophistication. The grade is based on a scale of 0-6. The thesis must be defensible and establish a line of reasoning. The evidence must be relevant and sufficient to support the argument. The commentary must explain how the evidence supports the thesis. Sophistication can be earned by demonstrating a complex understanding of the argument, a nuanced position, or by using a vivid and persuasive style.\n`, 'AP Calculus': `\n- For AP Calculus, grade the response based on the College Board's official rubric for a specific Free Response Question (FRQ).\n- Focus on the correct application of calculus concepts (e.g., limits, derivatives, integrals).\n- Check for correct mathematical notation and justification of steps.\n- Ensure the final answer is simplified and correct.\n- Award partial credit for correct setup or minor algebraic errors.\n`, 'Higher Ed General Essay': `\n- Clarity and Coherence: The essay has a clear thesis and logical flow.\n- Argumentation: The arguments are well-supported with credible evidence.\n- Research: The student has used and cited a sufficient number of relevant sources.\n- Style and Tone: The writing is formal, academic, and free of grammatical errors.\n- Originality: The essay demonstrates critical thinking and original insight.\n`, 'Harvard Biology Lab Report': `\n- Introduction: Clearly states the purpose, background, and hypothesis.\n- Methods: Provides a detailed, replicable description of the experimental procedure.\n- Results: Presents data clearly using tables and/or graphs. Data analysis is correct.\n- Discussion: Interprets the results, discusses their significance, addresses limitations, and suggests future research.\n- Conclusion: Summarizes key findings and states whether the hypothesis was supported.\n` };
            const AP_SUBJECTS = [ "AP Art History","AP Biology","AP Calculus AB","AP Calculus BC","AP Chemistry", "AP English Language & Composition","AP English Literature & Composition", "AP Environmental Science","AP European History","AP Human Geography", "AP Macroeconomics","AP Microeconomics", "AP Physics 1","AP Physics C: Mechanics","AP Psychology", "AP Statistics", "AP United States Government & Politics","AP United States History","AP World History: Modern" ];
            const HIGHER_ED_SUBJECTS = [ "Mathematics (Calculus)","Physics (Mechanics)","Chemistry (General)","Biology (Genetics)", "Computer Science (Data Structures)","Data Science","Economics (Micro)","Finance","Psychology (Intro)","Sociology","Political Science","History","Philosophy","English Composition", "Civil Engineering","Mechanical Engineering","Electrical Engineering","Law/Legal Studies","Nursing","Medicine (Premed)" ];
            const IB_SUBJECTS = [ "IB English A: Literature (SL/HL)","IB English A: Language & Literature (SL/HL)", "IB Global Politics (SL/HL)","IB History (SL/HL)","IB Economics (SL/HL)","IB Psychology (SL/HL)", "IB Business Management (SL/HL)","IB Biology (SL/HL)","IB Chemistry (SL/HL)","IB Physics (SL/HL)","IB Computer Science (SL/HL)", "IB Mathematics: Analysis & Approaches (SL/HL)", "IB Mathematics: Applications & Interpretation (SL/HL)","IB Theory of Knowledge (TOK)","IB Extended Essay (EE)" ];
            const SUBJECT_TEMPLATES = { AP: s => `--- Start of Subject Guidance (AP) ---\nSubject: ${s}\nUse AP scoring practices. Emphasize:\n- Content accuracy and correct application of ${s.replace(/^AP\\s*/,'')} concepts.\n- Clear reasoning/justification, proper notation/terminology.\n- Evidence quality, organization, and clarity.\n--- End of Subject Guidance ---`, "Higher Ed": s => `--- Start of Subject Guidance (Higher Ed) ---\nSubject: ${s}\nEvaluate on:\n- Conceptual correctness and methodological rigor for ${s}.\n- Clarity, structure, and academic tone.\n- Use of credible sources (if relevant) and proper citation.\n- Depth of analysis and originality.\n--- End of Subject Guidance ---`, IB: s => `--- Start of Subject Guidance (IB) ---\nSubject: ${s}\nAlign feedback with IB descriptors: knowledge & understanding, application/analysis, synthesis/evaluation, and communication.\n- Reference subject-specific criteria where applicable (SL/HL).\n- Highlight academic honesty and proper citation.\n--- End of Subject Guidance ---` };

            // --- DOM ELEMENT COLLECTION ---
            const dom = {
                steps: Array.from(document.querySelectorAll('.step-content')),
                actionArea: document.getElementById('action-area'),
                gradeButton: document.getElementById('grade-button'),
                clearButton: document.getElementById('clear-button'),
                loadingBarContainer: document.getElementById('loading-bar-container'),
                errorMessageDiv: document.getElementById('error-message'),
                successMessageDiv: document.getElementById('success-message'),
                gradeResultDiv: document.getElementById('grade-result'),
                resultContentDiv: document.getElementById('result-content'),
                strictnessMeter: document.getElementById('strictness-meter'),
                strictnessValueDisplay: document.getElementById('strictness-value'),
                gradeLevelButtons: document.querySelectorAll('.grade-level-btn'),
                rubricQuickAddArea: document.getElementById('rubric-quick-add'),
                rubricSelect: document.getElementById('rubric-select'),
                addRubricBtn: document.getElementById('add-rubric-to-prompt-btn'),
                subjectQuickAddArea: document.getElementById('subject-quick-add'),
                subjectSelect: document.getElementById('subject-select'),
                addSubjectBtn: document.getElementById('add-subject-to-prompt-btn'),
                textareas: { instructions: document.getElementById('instructions'), rubric: document.getElementById('rubric'), essay: document.getElementById('essay'), extra: document.getElementById('extra-instructions') },
                fileInputs: { instructions: document.getElementById('instructions-file'), rubric: document.getElementById('rubric-file'), essay: document.getElementById('essay-file') },
                fileLists: { instructions: document.getElementById('instructions-file-list'), rubric: document.getElementById('rubric-file-list'), essay: document.getElementById('essay-file-list') },
                toggleAdvancedButton: document.getElementById('toggleAdvancedButton'),
                advancedOptions: document.getElementById('advancedOptions'),
                customApiKeyInput: document.getElementById('customApiKeyInput'),
                saveApiKeyButton: document.getElementById('saveApiKeyButton'),
                apiKeyMessage: document.getElementById('apiKeyMessage'),
                stepIndicators: document.querySelectorAll('.step-indicator'),
                stepIndicatorProgress: document.getElementById('step-indicator-progress'),
                copyResultsButton: document.getElementById('copy-results-button'),
                startFollowUpButton: document.getElementById('start-follow-up-button'),
                chatModalOverlay: document.getElementById('chat-modal-overlay'),
                chatModalClose: document.getElementById('chat-modal-close'),
                chatHistory: document.getElementById('chat-history'),
                chatInput: document.getElementById('chat-input'),
                sendChatButton: document.getElementById('send-chat-button'),
                clearChatButton: document.getElementById('clear-chat-button'),
            };

            // --- STATE MANAGEMENT ---
            let currentStep = 0;
            let selectedGrade = 'None';
            let files = { instructions: [], rubric: [], essay: [] };
            let customApiKey = '';
            let conversationHistory = [];

            const saveState = () => {
                localStorage.setItem('graderData', JSON.stringify({
                    texts: { instructions: dom.textareas.instructions.value, rubric: dom.textareas.rubric.value, essay: dom.textareas.essay.value, extra: dom.textareas.extra.value },
                    selectedGrade: selectedGrade, strictness: dom.strictnessMeter.value,
                    resultHTML: dom.gradeResultDiv.classList.contains('hidden') ? null : dom.resultContentDiv.innerHTML,
                    conversationHistory: conversationHistory,
                }));
            };

            const loadState = () => {
                const data = JSON.parse(localStorage.getItem('graderData'));
                if (!data) return;
                dom.textareas.instructions.value = data.texts.instructions || ''; dom.textareas.rubric.value = data.texts.rubric || ''; dom.textareas.essay.value = data.texts.essay || ''; dom.textareas.extra.value = data.texts.extra || '';
                dom.strictnessMeter.value = data.strictness || '3'; dom.strictnessValueDisplay.textContent = data.strictness || '3';
                if (data.selectedGrade && data.selectedGrade !== 'None') {
                    const btn = document.querySelector(`.grade-level-btn[data-grade="${data.selectedGrade}"]`);
                    if (btn) btn.click();
                }
                if (data.resultHTML) {
                    dom.resultContentDiv.innerHTML = data.resultHTML;
                    dom.gradeResultDiv.classList.remove('hidden');
                }
                if (data.conversationHistory && data.conversationHistory.length > 0) {
                    conversationHistory = data.conversationHistory;
                    updateChatDisplay();
                }
            };

            const clearState = () => {
                Object.values(dom.textareas).forEach(ta => ta.value = '');
                files = { instructions: [], rubric: [], essay: [] };
                Object.values(dom.fileInputs).forEach(input => input.value = '');
                updateAllFileListDisplays();
                dom.strictnessMeter.value = 3; dom.strictnessValueDisplay.textContent = '3';
                dom.gradeResultDiv.classList.add('hidden');
                dom.errorMessageDiv.classList.add('hidden'); dom.successMessageDiv.classList.add('hidden');
                dom.gradeLevelButtons.forEach(b => b.classList.remove('selected'));
                selectedGrade = 'None';
                refreshQuickAddAreas();
                customApiKey = '';
                dom.customApiKeyInput.value = '';
                dom.apiKeyMessage.textContent = '';
                dom.advancedOptions.classList.add('hidden');
                localStorage.removeItem('graderData');
                conversationHistory = [];
                dom.chatHistory.innerHTML = '';
                dom.chatModalOverlay.classList.add('hidden');
                showStep(0);
            };

            // --- UI & HELPER FUNCTIONS ---
            const showStep = (index) => {
                if (index < 0 || index >= dom.steps.length) return;
                dom.steps.forEach((step, i) => step.classList.toggle('hidden', i !== index));
                dom.actionArea.style.display = (index === dom.steps.length - 1) ? 'block' : 'none';
                currentStep = index;
                const progressPercentage = (index / (dom.steps.length - 1)) * 100;
                dom.stepIndicatorProgress.style.width = `${progressPercentage}%`;
                dom.stepIndicators.forEach((indicator, i) => {
                    indicator.classList.toggle('active', i === index);
                    indicator.classList.toggle('completed', i < index);
                });
            };
            const nextStep = () => showStep(currentStep + 1);
            const prevStep = () => showStep(currentStep - 1);

            const displayMessage = (element, message, isError = false) => {
                element.innerHTML = message;
                element.classList.remove('hidden');
                setTimeout(() => element.classList.add('hidden'), isError ? 8000 : 5000);
            };

            const toggleLoading = (isLoading) => {
                dom.loadingBarContainer.classList.toggle('hidden', !isLoading);
                dom.gradeButton.disabled = isLoading;
                dom.clearButton.disabled = isLoading;
            };

            const refreshQuickAddAreas = () => {
                const show = ['AP Courses', 'Higher Ed', 'IB'].includes(selectedGrade);
                dom.subjectQuickAddArea.classList.toggle('hidden', !show);
                dom.rubricQuickAddArea.classList.toggle('hidden', !show);
                if (!show) return;
                const subjectList = selectedGrade === 'AP Courses' ? AP_SUBJECTS : selectedGrade === 'Higher Ed' ? HIGHER_ED_SUBJECTS : IB_SUBJECTS;
                dom.subjectSelect.innerHTML = `<option value="none" disabled selected>Select a subject...</option>` + subjectList.map(s => `<option value="${s}">${s}</option>`).join('');
                dom.rubricSelect.value = 'none';
                dom.addSubjectBtn.disabled = true;
            };
            
            const updateAllFileListDisplays = () => {
                for (const key in files) {
                    const listEl = dom.fileLists[key];
                    listEl.innerHTML = '';
                    files[key].forEach((file, index) => {
                        const item = document.createElement('li');
                        item.className = 'file-list-item';
                        item.innerHTML = `<span>${file.name}</span><button data-key="${key}" data-index="${index}">&times;</button>`;
                        listEl.appendChild(item);
                    });
                    listEl.classList.toggle('expanded', files[key].length > 0);
                }
            };

            // --- CORE LOGIC ---
            const readFileContent = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));
                if (file.type.startsWith('image/')) {
                    reader.onload = e => resolve({ type: 'image', imageData: { mimeType: file.type, data: e.target.result.split(',')[1] }, filename: file.name });
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    reader.onload = async e => {
                        try {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                            }
                            resolve({ type: 'text', content: fullText, filename: file.name });
                        } catch (error) { reject(new Error(`PDF Error '${file.name}': ${error.message}`)); }
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file.type.startsWith('text/') || file.name.endsWith('.md')) {
                    reader.onload = e => resolve({ type: 'text', content: e.target.result, filename: file.name });
                    reader.readAsText(file);
                } else {
                    reject(new Error(`Unsupported file: ${file.name}`));
                }
            });

            const getProcessedSectionContent = async (textarea, fileArray) => {
                let combinedText = textarea.value.trim();
                const parts = [];
                const errors = [];
                for (const file of fileArray) {
                    try {
                        const result = await readFileContent(file);
                        if (result.type === 'text') {
                            combinedText += `\n\n--- File: ${result.filename} ---\n${result.content}`;
                        } else if (result.type === 'image') {
                            parts.push({ inlineData: result.imageData });
                        }
                    } catch (error) { errors.push(error.message); }
                }
                if (errors.length > 0) throw new Error(errors.join('\n'));
                if (combinedText) parts.unshift({ text: combinedText });
                return parts;
            };

            const callApiWithRetries = async (payload) => {
                for (const model of ALL_GEMINI_MODELS) {
                    try {
                        const apiPayload = { ...payload, model };
                        if (customApiKey) apiPayload.apiKey = customApiKey;
                        const response = await fetch('/api/Grader_API', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(apiPayload) });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || `Server error (${response.status})`);
                        }
                        const result = await response.json();
                        if (result.text) return result.text;
                    } catch (error) { console.warn(`Model ${model} failed: ${error.message}`); }
                }
                throw new Error("All API models failed.");
            };

            const gradeEssay = async () => {
                dom.errorMessageDiv.classList.add('hidden');
                dom.successMessageDiv.classList.add('hidden');
                dom.gradeResultDiv.classList.add('hidden');
                toggleLoading(true);
                conversationHistory = [];

                let initialUserPromptParts; // Define here to be accessible in catch block

                try {
                    if (!dom.textareas.instructions.value.trim() && files.instructions.length === 0) throw new Error("Please provide Assignment Instructions.");
                    if (!dom.textareas.rubric.value.trim() && files.rubric.length === 0) throw new Error("Please provide a Grading Rubric.");
                    if (!dom.textareas.essay.value.trim() && files.essay.length === 0) throw new Error("Please provide the Student's Assignment.");

                    const [instructionsParts, rubricParts, essayParts] = await Promise.all([
                        getProcessedSectionContent(dom.textareas.instructions, files.instructions),
                        getProcessedSectionContent(dom.textareas.rubric, files.rubric),
                        getProcessedSectionContent(dom.textareas.essay, files.essay)
                    ]);

                    const systemPrompt = `You are an expert AI assignment grader. Evaluate a student's assignment based on the provided instructions and a specific grading rubric.
                    Grading Strictness Level: ${dom.strictnessMeter.value} (1=Lenient, 3=Normal, 5=Strict).
                    Educational Context: ${selectedGrade}
                    Additional Instructions: ${dom.textareas.extra.value.trim() || 'None.'}
                    IMPORTANT: Your final output MUST be a JSON object inside a markdown code block. The JSON object must have the following keys: "finalGrade" (a string, e.g., "B+" or "85/100"), "overallFeedback" (a string in markdown format), "strengths" (a string in markdown format, preferably as a bulleted list), and "areasForImprovement" (a string in markdown format, preferably as a bulleted list).`;
                    
                    initialUserPromptParts = [ { text: systemPrompt }, { text: "\n\n--- ASSIGNMENT INSTRUCTIONS ---\n" }, ...instructionsParts, { text: "\n\n--- GRADING RUBRIC ---\n" }, ...rubricParts, { text: "\n\n--- STUDENT'S SUBMISSION ---\n" }, ...essayParts ];
                    
                    const resultText = await callApiWithRetries({ contents: [{ role: 'user', parts: initialUserPromptParts }] });

                    const jsonMatch = resultText.match(/```json\n([\s\S]*?)\n```/);
                    if (!jsonMatch || !jsonMatch[1]) throw new Error("AI response did not contain a valid JSON code block. Displaying raw output.");

                    const resultData = JSON.parse(jsonMatch[1]);
                    
                    const resultHTML = `
                        <div class="final-grade-display"><p>Final Grade</p><span>${resultData.finalGrade || 'N/A'}</span></div>
                        <div class="result-section"><h3>Overall Feedback</h3><div class="prose max-w-none">${marked.parse(resultData.overallFeedback || '')}</div></div>
                        <div class="result-section"><h3>Strengths</h3><div class="prose max-w-none">${marked.parse(resultData.strengths || '')}</div></div>
                        <div class="result-section"><h3>Areas for Improvement</h3><div class="prose max-w-none">${marked.parse(resultData.areasForImprovement || '')}</div></div>`;

                    dom.resultContentDiv.innerHTML = resultHTML;
                    dom.gradeResultDiv.classList.remove('hidden');
                    displayMessage(dom.successMessageDiv, `Assignment graded successfully!`);
                    dom.gradeResultDiv.scrollIntoView({ behavior: 'smooth' });
                    
                    conversationHistory.push({ role: 'user', parts: initialUserPromptParts });
                    conversationHistory.push({ role: 'model', parts: [{ text: resultText }] });
                    saveState();

                } catch (error) {
                    if (error.message.includes("AI response did not contain a valid JSON") && initialUserPromptParts) {
                        const resultText = await callApiWithRetries({ contents: [{ role: 'user', parts: initialUserPromptParts }] });
                        dom.resultContentDiv.innerHTML = marked.parse(resultText);
                        dom.gradeResultDiv.classList.remove('hidden');
                        displayMessage(dom.errorMessageDiv, `<strong>Warning:</strong> Could not parse structured response. Displaying raw AI output.`, true);
                    } else {
                        displayMessage(dom.errorMessageDiv, `<strong>Error:</strong> ${error.message}`, true);
                    }
                } finally {
                    toggleLoading(false);
                }
            };

            const updateChatDisplay = () => {
                dom.chatHistory.innerHTML = '';
                const displayableHistory = conversationHistory.slice(1); 
                displayableHistory.forEach(msg => {
                    let currentMsg = msg;
                    if (msg.role === 'model' && msg.parts[0].text.includes('```json')) {
                        currentMsg = { role: 'model', parts: [{ text: "I have finished grading the assignment. How can I help you further?" }] };
                    }
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = `chat-message ${currentMsg.role}`;
                    const messageBubble = document.createElement('div');
                    messageBubble.className = 'chat-message-bubble prose max-w-none';
                    // FIXED: Correctly access the text property
                    messageBubble.innerHTML = marked.parse(currentMsg.parts.text);
                    messageWrapper.appendChild(messageBubble);
                    dom.chatHistory.appendChild(messageWrapper);
                });
                dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight;
            };

            const handleFollowUp = async () => {
                const userInput = dom.chatInput.value.trim();
                if (!userInput || conversationHistory.length === 0) return;

                dom.chatInput.value = '';
                dom.sendChatButton.disabled = true;

                conversationHistory.push({ role: 'user', parts: [{ text: userInput }] });
                updateChatDisplay();
                saveState();

                try {
                    const resultText = await callApiWithRetries({ contents: conversationHistory });
                    conversationHistory.push({ role: 'model', parts: [{ text: resultText }] });
                    updateChatDisplay();
                    saveState();
                } catch (error) {
                    const errorMsg = { role: 'model', parts: [{ text: `Sorry, I encountered an error: ${error.message}` }] };
                    conversationHistory.push(errorMsg);
                    updateChatDisplay();
                    saveState();
                } finally {
                    dom.sendChatButton.disabled = false;
                    dom.chatInput.focus();
                }
            };

            const clearChatHistory = () => {
                if (conversationHistory.length > 2) {
                    conversationHistory = conversationHistory.slice(0, 2);
                }
                updateChatDisplay();
                saveState();
            };

            // --- EVENT LISTENERS ---
            dom.steps.forEach(step => {
                const backBtn = step.querySelector('.step-header .btn-container.text-left .nav-button');
                const nextBtn = step.querySelector('.step-header .btn-container.text-right .nav-button');
                if (backBtn && !backBtn.classList.contains('opacity-0')) backBtn.addEventListener('click', prevStep);
                if (nextBtn && !nextBtn.classList.contains('opacity-0')) nextBtn.addEventListener('click', nextStep);
            });

            dom.gradeButton.addEventListener('click', gradeEssay);
            dom.clearButton.addEventListener('click', clearState);
            Object.values(dom.textareas).forEach(ta => ta.addEventListener('input', saveState));
            dom.strictnessMeter.addEventListener('input', e => { dom.strictnessValueDisplay.textContent = e.target.value; saveState(); });

            const setupFileInput = (key) => {
                dom.fileInputs[key].addEventListener('change', e => { files[key].push(...Array.from(e.target.files)); updateAllFileListDisplays(); e.target.value = ''; });
                dom.fileLists[key].addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { files[e.target.dataset.key].splice(e.target.dataset.index, 1); updateAllFileListDisplays(); } });
                const toggleBtn = dom.fileInputs[key].closest('.step-content').querySelector('.toggle-file-list-button');
                toggleBtn.addEventListener('click', () => { dom.fileLists[key].classList.toggle('expanded'); toggleBtn.textContent = dom.fileLists[key].classList.contains('expanded') ? 'Hide Files' : 'Show Files'; });
            };
            Object.keys(files).forEach(setupFileInput);

            const addPasteListener = (textarea, filesArrayKey) => {
                textarea.addEventListener('paste', (e) => {
                    for (const item of e.clipboardData.items) {
                        if (item.kind === 'file' && item.type.startsWith('image/')) {
                            e.preventDefault();
                            const blob = item.getAsFile();
                            blob.name = `Pasted Image ${Date.now()}`;
                            files[filesArrayKey].push(blob);
                            updateAllFileListDisplays();
                            displayMessage(dom.successMessageDiv, 'Image pasted successfully!');
                            return;
                        }
                    }
                });
            };
            addPasteListener(dom.textareas.instructions, 'instructions');
            addPasteListener(dom.textareas.rubric, 'rubric');
            addPasteListener(dom.textareas.essay, 'essay');

            dom.gradeLevelButtons.forEach(btn => btn.addEventListener('click', () => {
                const isAlreadySelected = btn.classList.contains('selected');
                dom.gradeLevelButtons.forEach(b => b.classList.remove('selected'));
                if (isAlreadySelected) { selectedGrade = 'None'; } 
                else { btn.classList.add('selected'); selectedGrade = btn.dataset.grade; }
                refreshQuickAddAreas();
                saveState();
            }));

            dom.subjectSelect.addEventListener('change', () => { dom.addSubjectBtn.disabled = (dom.subjectSelect.value === 'none'); });
            dom.addSubjectBtn.addEventListener('click', () => {
                const subject = dom.subjectSelect.value;
                if (!subject || subject === 'none') return;
                const tmpl = selectedGrade === 'AP Courses' ? SUBJECT_TEMPLATES.AP(subject) : selectedGrade === 'Higher Ed' ? SUBJECT_TEMPLATES["Higher Ed"](subject) : SUBJECT_TEMPLATES.IB(subject);
                if (tmpl) { dom.textareas.extra.value += (dom.textareas.extra.value ? '\n\n' : '') + tmpl; displayMessage(dom.successMessageDiv, `Added "${subject}" guidance.`); saveState(); }
            });

            dom.addRubricBtn.addEventListener('click', () => {
                const selectedValue = dom.rubricSelect.value;
                if (selectedValue && selectedValue !== 'none' && selectedValue !== 'Custom') {
                    const rubricText = RUBRIC_TEXTS[selectedValue];
                    if (rubricText) { dom.textareas.extra.value += `\n\n--- Rubric: ${selectedValue} ---${rubricText}--- End Rubric ---`; displayMessage(dom.successMessageDiv, `Added "${selectedValue}" rubric.`); saveState(); }
                }
            });

            dom.toggleAdvancedButton.addEventListener('click', (e) => { e.preventDefault(); dom.advancedOptions.classList.toggle('hidden'); });
            dom.saveApiKeyButton.addEventListener('click', (e) => {
                e.preventDefault();
                customApiKey = dom.customApiKeyInput.value.trim();
                dom.apiKeyMessage.textContent = customApiKey ? 'API Key has been set for this session.' : 'API Key cleared.';
                if (customApiKey) dom.customApiKeyInput.value = '';
                setTimeout(() => { dom.apiKeyMessage.textContent = ''; }, 3000);
            });

            dom.copyResultsButton.addEventListener('click', (e) => {
                const grade = dom.resultContentDiv.querySelector('.final-grade-display span')?.innerText || 'N/A';
                const feedback = dom.resultContentDiv.querySelector('.result-section:nth-of-type(1) .prose')?.innerText || '';
                const strengths = dom.resultContentDiv.querySelector('.result-section:nth-of-type(2) .prose')?.innerText || '';
                const improvements = dom.resultContentDiv.querySelector('.result-section:nth-of-type(3) .prose')?.innerText || '';
                const textToCopy = `Final Grade: ${grade}\n\n--- OVERALL FEEDBACK ---\n${feedback}\n\n--- STRENGTHS ---\n${strengths}\n\n--- AREAS FOR IMPROVEMENT ---\n${improvements}`;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const button = e.target;
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => button.textContent = originalText, 2000);
                }).catch(err => { displayMessage(dom.errorMessageDiv, 'Failed to copy results.', true); });
            });

            dom.startFollowUpButton.addEventListener('click', () => {
                dom.chatModalOverlay.classList.remove('hidden');
                dom.chatInput.focus();
            });
            dom.chatModalClose.addEventListener('click', () => dom.chatModalOverlay.classList.add('hidden'));
            dom.sendChatButton.addEventListener('click', handleFollowUp);
            dom.chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleFollowUp();
                }
            });
            dom.clearChatButton.addEventListener('click', clearChatHistory);

            // --- INITIALIZATION ---
            showStep(0);
            loadState();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHeader();
            initializeGraderApp();
        });
    </script>

  <!-- Vercel Analytics -->
  <script>
    window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    window.va('set', 'mode', 'auto');
  </script>
  <script defer src="/_vercel/insights/script.js"></script>


  <!-- iFrame -->
  <script src="/iframe-messenger.js" defer></script>
    
</body>
</html>
