<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Flashcard Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        /* --- CRITICAL STYLES FOR FOUC PREVENTION --- */
        /* --- Theme Variables --- */
        :root {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #fff; --card-bg: #222; --link-hover: #ffffff;
            --accent-rgb: 255, 255, 255;
        }
        body.theme-cyan {
            --bg-primary: #000; --bg-secondary: #0b0b0b; --text-primary: #e0ffff;
            --accent: #00f6ff; --card-bg: #072a2c; --accent-rgb: 0, 246, 255;
        }
        body.theme-purple {
            --bg-primary: #0d001a; --bg-secondary: #14002b; --text-primary: #ffe6ff;
            --accent: #cc66ff; --card-bg: #1d0036; --accent-rgb: 204, 102, 255;
        }
        body.theme-green {
            --bg-primary: #001a00; --bg-secondary: #002b00; --text-primary: #e6ffe6;
            --accent: #66ff66; --card-bg: #003600; --accent-rgb: 102, 255, 102;
        }
        body.theme-blackwhite {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #e0e0e0; --card-bg: #222; --accent-rgb: 224, 224, 224;
        }
        body.theme-red {
            --bg-primary: #1a0000; --bg-secondary: #2b0000; --text-primary: #ffe6e6;
            --accent: #ff3333; --card-bg: #360000; --accent-rgb: 255, 51, 51;
        }
        /* --- Global Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.6s, color 0.6s;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Page-Specific Styles --- */
        .main-content { width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        .hero { text-align: center; padding: 50px 20px 30px; position: relative; z-index: 5; }
        .hero h1 { font-size: 3.2rem; text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent); margin-bottom: 20px; }
        .hero p { font-size: 1.2rem; margin: 0 auto 30px; max-width: 600px; }
        .container {
            max-width: 900px; width: 90%; margin: 20px auto 40px auto; padding: 20px;
            background-color: var(--bg-secondary); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;
            gap: 20px; position: relative;
        }
        .container h2 { font-size: 1.5rem; color: var(--text-primary); text-align: center; margin-bottom: 5px; }
        .input-step-container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        .input-step { width: 100%; display: none; flex-direction: column; gap: 10px; }
        .input-step.active { display: flex; }
        .input-step p.subtitle { font-size: 0.9rem; text-align: center; margin-bottom: 15px; }
        textarea {
            width: 100%; padding: 15px; border: 1px solid var(--accent); border-radius: 8px;
            background-color: var(--card-bg); color: var(--text-primary); font-size: 1rem;
            resize: vertical; min-height: 150px; transition: border-color 0.3s, background-color 0.3s;
        }
        textarea:focus { outline: none; border-color: var(--text-primary); box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); }
        .file-upload-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; align-items: center; }
        .file-input-wrapper { position: relative; display: flex; align-items: center; gap: 10px; width: 100%; max-width: 400px; }
        .file-input-label {
            background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent);
            padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s; white-space: nowrap; z-index: 1;
        }
        .file-input-label:hover { background: var(--accent); color: var(--bg-primary); }
        #fileInput { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 2; }
        .file-name-display {
            flex-grow: 1; padding: 8px 10px; border: 1px solid var(--card-bg); border-radius: 8px;
            background-color: var(--bg-primary); color: rgba(var(--accent-rgb), 0.8); font-size: 0.9rem;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .file-clear-button { background: none; border: none; color: var(--accent); font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-clear-button:hover { color: var(--text-primary); }
        .file-list-container { width: 100%; max-width: 400px; margin-top: 15px; }
        .file-list-toggle-button {
            background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s; margin-bottom: 10px; width: 100%;
        }
        .file-list-toggle-button:hover { background: var(--accent); color: var(--bg-primary); }
        .file-list {
            list-style: none; padding: 0; max-height: 0; overflow: hidden;
            transition: max-height 0.5s ease-in-out; border: 1px solid var(--card-bg);
            border-radius: 8px; background-color: var(--bg-primary);
        }
        .file-list.expanded { max-height: 200px; overflow-y: auto; padding: 10px; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid rgba(var(--accent-rgb), 0.2); font-size: 0.9rem; }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item span { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-list-item button { background: none; border: none; color: #ff6666; font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-list-item button:hover { color: #ff0000; }
        .input-navigation-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        .action-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        
        /* --- UPDATED: Added .copy-button to the main button style group --- */
        .generate-button, .clear-button, .nav-button, .copy-button {
            background-color: var(--accent); color: var(--bg-primary); border: none;
            padding: 12px 25px; border-radius: 25px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(var(--accent-rgb), 0.4);
        }
        .generate-button:hover, .clear-button:hover, .nav-button:hover:not(:disabled), .copy-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(var(--accent-rgb), 0.6); }
        .generate-button:active, .clear-button:active, .nav-button:active:not(:disabled), .copy-button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(var(--accent-rgb), 0.3); }
        .nav-button:disabled { background-color: var(--card-bg); color: rgba(var(--accent-rgb), 0.5); cursor: not-allowed; box-shadow: none; }
        
        .flashcard-display-area { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 30px; }
        .flashcard-wrapper {
            width: 100%;
            display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
        }
        .flashcard {
            width: 100%; max-width: 400px; perspective: 1000px; height: 250px;
            background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer; position: relative;
        }
        .flashcard-inner {
            position: absolute; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        
        .flashcard-front, .flashcard-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; 
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-size: 1.1rem; font-weight: 500; color: var(--text-primary);
            word-wrap: break-word; overflow-y: auto; box-sizing: border-box; border-radius: 12px;
            text-align: center;
        }
        .flashcard-front { background-color: var(--card-bg); border: 2px solid var(--accent); }
        .flashcard-back { background-color: var(--accent); color: var(--bg-primary); transform: rotateY(180deg); border: 2px solid var(--accent); }
        
        .flashcard-front::-webkit-scrollbar, .flashcard-back::-webkit-scrollbar { width: 8px; }
        .flashcard-front::-webkit-scrollbar-track, .flashcard-back::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 4px; }
        .flashcard-front::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        .flashcard-back::-webkit-scrollbar-thumb { background-color: var(--bg-primary); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }

        .flashcard-counter {
            font-size: 1rem; font-weight: 600;
            margin-bottom: -5px;
            text-align: center;
        }

        .message-box {
            background-color: rgba(var(--accent-rgb), 0.1); border: 1px solid var(--accent);
            color: var(--text-primary); padding: 15px; border-radius: 8px;
            text-align: center; margin-top: 20px; font-size: 1rem; display: none;
        }
        .loading-bar-container { width: 100%; height: 8px; background-color: var(--card-bg); border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .loading-bar { height: 100%; width: 0%; background-color: var(--accent); border-radius: 4px; transition: width 0.4s ease-in-out; }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 20px auto; padding: 15px; }
            .hero h1 { font-size: 2.2rem; }
            .generate-button, .clear-button, .nav-button, .copy-button { width: 100%; font-size: 1rem; padding: 10px 20px; }
            .action-buttons, .input-navigation-buttons, .flashcard-navigation { flex-direction: column;}
            .flashcard { height: 200px; }
            .flashcard-front, .flashcard-back { font-size: 1rem; }
        }

        .flashcard-navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;    
        }
    </style>
    <script>
        (function() {
            try {
                const theme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                document.documentElement.className = theme;
            } catch (e) {}
        })();
    </script>
</head>
<body>
  <div id="header-container"></div>

  <main class="main-content animate-on-load">
    <section class="hero">
        <h1>AI Flashcard Generator</h1>
        <p>Instantly convert your notes, images, or PDFs into interactive study cards.</p>
    </section>

    <div class="container">
        <div class="input-step-container">
            <div id="inputStep1" class="input-step active">
                <h2>Step 1: Enter Your Text</h2>
                <p class="subtitle">Provide the main content from which flashcards will be generated.</p>
                <textarea id="inputText" placeholder="Enter text here... or paste an image (Ctrl+V)"></textarea>
                <div class="file-upload-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".txt,.md,.pdf,image/*" multiple>
                        <label for="fileInput" class="file-input-label">Upload Files</label>
                        <span id="fileNameDisplay" class="file-name-display">No files chosen</span>
                        <button id="clearFileButton" class="file-clear-button" style="display:none;">&times;</button>
                    </div>
                    <p class="subtitle">Supported: .txt, .md, images. PDFs extract text only.</p>
                    <div class="file-list-container">
                        <button id="toggleFileListButton" class="file-list-toggle-button" style="display:none;">Show Uploaded Files (0)</button>
                        <ul id="fileList" class="file-list"></ul>
                    </div>
                </div>
            </div>

            <div id="inputStep2" class="input-step">
                <h2>Step 2: Add Custom Instructions (Optional)</h2>
                <p class="subtitle">Guide the AI on how to create your flashcards.</p>
                <textarea id="customInstructions" placeholder="e.g., 'Focus on key terms only', 'Generate 3 flashcards'"></textarea>
            </div>

            <div class="input-navigation-buttons">
                <button id="inputPrevButton" class="nav-button" disabled>Back</button>
                <button id="inputNextButton" class="nav-button">Next</button>
            </div>
        </div>

        <div class="action-buttons">
          <button id="generateButton" class="generate-button">Generate Flashcards</button>
          <button id="clearButton" class="clear-button">Clear All</button>
        </div>
        <div id="loadingBarContainer" class="loading-bar-container">
            <div id="loadingBar" class="loading-bar"></div>
        </div>
        <div id="messageBox" class="message-box"></div>

        <div id="flashcardDisplayArea" class="flashcard-display-area">
            <div id="flashcardCounter" class="flashcard-counter" style="display: none;"></div>
            <div id="flashcardWrapper" class="flashcard-wrapper"></div>
            <div id="flashcardNavigation" class="flashcard-navigation" style="display: none;">
                <button id="prevButton" class="nav-button" disabled>Previous</button>
                <!-- NEW: Copy button added here -->
                <button id="copyButton" class="copy-button">Copy All</button>
                <button id="nextButton" class="nav-button" disabled>Next</button>
            </div>
        </div>
    </div>
  </main>
  
  <footer class="main-footer" style="width: 100%; text-align: center; padding: 20px; font-size: 0.9rem; background-color: var(--bg-secondary); position: relative; z-index: 10;">
      <p>&copy; 2025 Shkspr. All rights reserved.</p>
  </footer>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

async function loadHeader() {
  try {
    const response = await fetch('../Structure/header.html');
    if (!response.ok) throw new Error('Failed to load header');
    const text = await response.text();
    
    document.getElementById('header-container').innerHTML = text;

    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    const scriptElement = doc.querySelector('script');
    if (scriptElement) {
        const newScript = document.createElement('script');
        newScript.textContent = scriptElement.textContent;
        document.body.appendChild(newScript);
    }
    
    if (window.setTheme && window.initParticles) {
        const savedTheme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
        window.setTheme(savedTheme);

        document.getElementById('theme-blackwhite-btn').addEventListener('click', () => window.setTheme('theme-blackwhite'));
        document.getElementById('theme-cyan-btn').addEventListener('click', () => window.setTheme('theme-cyan'));
        document.getElementById('theme-purple-btn').addEventListener('click', () => window.setTheme('theme-purple'));
        document.getElementById('theme-green-btn').addEventListener('click', () => window.setTheme('theme-green'));
        document.getElementById('theme-red-btn').addEventListener('click', () => window.setTheme('theme-red'));
    }
  } catch (error) {
    console.error('Error loading header:', error);
    document.getElementById('header-container').innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error loading header.</p>';
  }
}

function initializeFlashcardApp() {
    // --- FIX: Use the proven, reliable model list ---
    const ALL_GEMINI_MODELS = [
      'gemini-1.5-flash-latest',
      'gemini-1.5-pro-latest'
    ];
    
    const dom = {
        inputText: document.getElementById('inputText'),
        customInstructions: document.getElementById('customInstructions'),
        generateButton: document.getElementById('generateButton'),
        clearButton: document.getElementById('clearButton'),
        flashcardWrapper: document.getElementById('flashcardWrapper'),
        flashcardCounter: document.getElementById('flashcardCounter'),
        messageBox: document.getElementById('messageBox'),
        loadingBarContainer: document.getElementById('loadingBarContainer'),
        loadingBar: document.getElementById('loadingBar'),
        prevButton: document.getElementById('prevButton'),
        nextButton: document.getElementById('nextButton'),
        flashcardNavigation: document.getElementById('flashcardNavigation'),
        inputSteps: [document.getElementById('inputStep1'), document.getElementById('inputStep2')],
        inputPrevButton: document.getElementById('inputPrevButton'),
        inputNextButton: document.getElementById('inputNextButton'),
        fileInput: document.getElementById('fileInput'),
        fileNameDisplay: document.getElementById('fileNameDisplay'),
        clearFileButton: document.getElementById('clearFileButton'),
        fileList: document.getElementById('fileList'),
        toggleFileListButton: document.getElementById('toggleFileListButton'),
        // --- NEW: Add copy button to DOM object ---
        copyButton: document.getElementById('copyButton'),
    };

    let uploadedFilesData = [];
    let flashcardsData = [];
    let currentFlashcardIndex = 0;
    let currentInputStepIndex = 0;

    const saveState = () => {
        localStorage.setItem('flashcardInput', dom.inputText.value);
        localStorage.setItem('flashcardInstructions', dom.customInstructions.value);
        if (flashcardsData && flashcardsData.length > 0) {
            localStorage.setItem('flashcardsData', JSON.stringify(flashcardsData));
        } else {
            localStorage.removeItem('flashcardsData');
        }
    };

    const loadState = () => {
        const savedInput = localStorage.getItem('flashcardInput');
        const savedInstructions = localStorage.getItem('flashcardInstructions');
        const savedFlashcards = localStorage.getItem('flashcardsData');

        if (savedInput) dom.inputText.value = savedInput;
        if (savedInstructions) dom.customInstructions.value = savedInstructions;
        if (savedFlashcards) {
            try {
                flashcardsData = JSON.parse(savedFlashcards);
                if (Array.isArray(flashcardsData) && flashcardsData.length > 0) {
                    displayFlashcard(0);
                } else { flashcardsData = []; }
            } catch (e) {
                console.error("Failed to parse saved flashcards:", e);
                flashcardsData = [];
            }
        }
    };

    const clearState = () => {
        dom.inputText.value = '';
        dom.customInstructions.value = '';
        uploadedFilesData = [];
        flashcardsData = [];
        localStorage.removeItem('flashcardInput');
        localStorage.removeItem('flashcardInstructions');
        localStorage.removeItem('flashcardsData');
        updateFileListDisplay();
        displayFlashcard(0);
        showInputStep(0);
        showMessage('All content cleared.');
    };

    const shuffleArray = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    };

    const showMessage = (message, type = 'info') => {
        dom.messageBox.textContent = message;
        dom.messageBox.className = `message-box ${type}`;
        dom.messageBox.style.display = 'block';
        setTimeout(() => { dom.messageBox.style.display = 'none'; }, 5000);
    };

    const createFlashcardElement = (frontText, backText) => {
        const flashcard = document.createElement('div');
        flashcard.className = 'flashcard';
        const inner = document.createElement('div');
        inner.className = 'flashcard-inner';
        const front = document.createElement('div');
        front.className = 'flashcard-front';
        front.textContent = frontText;
        const back = document.createElement('div');
        back.className = 'flashcard-back';
        back.textContent = backText;
        inner.append(front, back);
        flashcard.appendChild(inner);
        flashcard.addEventListener('click', () => inner.parentElement.classList.toggle('flipped'));
        return flashcard;
    };
    
    const displayFlashcard = (index) => {
        dom.flashcardWrapper.innerHTML = '';
        if (flashcardsData.length > 0) {
            currentFlashcardIndex = index;
            const card = flashcardsData[currentFlashcardIndex];
            dom.flashcardWrapper.appendChild(createFlashcardElement(card.front, card.back));
            dom.flashcardNavigation.style.display = 'flex';
            dom.flashcardCounter.textContent = `Flashcard ${currentFlashcardIndex + 1} of ${flashcardsData.length}`;
            dom.flashcardCounter.style.display = 'block';
        } else {
             dom.flashcardNavigation.style.display = 'none';
             dom.flashcardCounter.style.display = 'none';
        }
        dom.prevButton.disabled = currentFlashcardIndex === 0;
        dom.nextButton.disabled = currentFlashcardIndex === flashcardsData.length - 1;
    };

    const showInputStep = (index) => {
        dom.inputSteps.forEach((step, i) => step.classList.toggle('active', i === index));
        currentInputStepIndex = index;
        dom.inputPrevButton.disabled = currentInputStepIndex === 0;
        dom.inputNextButton.disabled = currentInputStepIndex === dom.inputSteps.length - 1;
        dom.generateButton.style.display = (currentInputStepIndex === dom.inputSteps.length - 1) ? 'block' : 'none';
    };

    const readFileContent = async (file) => {
        return new Promise(async (resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));
            if (file.type.startsWith('image/')) {
                reader.onload = (e) => resolve({ type: file.type, content: e.target.result.split(',')[1] });
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                try {
                    const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n';
                    }
                    resolve({ type: 'text/plain', content: text });
                } catch (e) { reject(e); }
            } else if (file.type.startsWith('text/')) {
                reader.onload = (e) => resolve({ type: 'text/plain', content: e.target.result });
                reader.readAsText(file);
            } else { reject(new Error(`Unsupported file type: ${file.type}`)); }
        });
    };

    const updateFileListDisplay = () => {
        dom.fileList.innerHTML = '';
        const hasFiles = uploadedFilesData.length > 0;
        dom.toggleFileListButton.style.display = hasFiles ? 'block' : 'none';
        dom.fileNameDisplay.textContent = hasFiles ? `${uploadedFilesData.length} file(s) chosen` : 'No files chosen';
        dom.clearFileButton.style.display = hasFiles ? 'inline-block' : 'none';
        dom.toggleFileListButton.textContent = `Show Uploaded Files (${uploadedFilesData.length})`;
        if (!hasFiles) dom.fileList.classList.remove('expanded');

        uploadedFilesData.forEach(file => {
            const li = document.createElement('li');
            li.className = 'file-list-item';
            li.innerHTML = `<span>${file.name}</span><button data-id="${file.id}">&times;</button>`;
            dom.fileList.appendChild(li);
        });
    };
    
    // --- FIX: Use the efficient API call method ---
    const callApiWithRetries = async (payload) => {
        let modelsToTry = shuffleArray([...ALL_GEMINI_MODELS]);
        let lastError = null;
        for (const model of modelsToTry) {
            console.log(`Attempting API call with model: ${model}`);
            try {
                const response = await fetch('/api/Flashcard_API', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...payload, model })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error || `Server error (${response.status}) with model ${model}`);
                }
                const result = await response.json();
                if (result.flashcards && result.flashcards.length > 0) {
                    const validFlashcards = result.flashcards.filter(card =>
                        card && card.front && card.back && card.front.trim() !== '' && card.back.trim() !== ''
                    );
                    if (validFlashcards.length > 0) {
                        return { flashcards: validFlashcards };
                    }
                }
                lastError = new Error(`Model ${model} returned no valid flashcards.`);
            } catch (error) {
                console.warn(error.message);
                lastError = error;
            }
        }
        throw lastError || new Error("All API models failed.");
    };

    const generateFlashcards = async () => {
        const text = dom.inputText.value.trim();
        const instructions = dom.customInstructions.value.trim();
        if (!text && uploadedFilesData.length === 0) {
            showMessage('Please enter text or upload a file.', 'error');
            return;
        }
        flashcardsData = [];
        displayFlashcard(0);
        dom.loadingBarContainer.style.display = 'block';
        dom.loadingBar.style.width = '0%';
        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 90) { progress += 5; dom.loadingBar.style.width = `${progress}%`; }
        }, 200);

        try {
            let promptParts = [];
            if (text) promptParts.push({ text: `From this text: "${text}"` });
            uploadedFilesData.forEach(file => {
                if (file.type.startsWith('image/')) {
                    promptParts.push({ text: `From image (${file.name}):` }, { inlineData: { mimeType: file.type, data: file.content } });
                } else {
                    promptParts.push({ text: `From text file (${file.name}): "${file.content}"` });
                }
            });
            promptParts.push({ text: `\n\nGenerate a list of flashcards from ALL provided content. The output MUST be a JSON object with a single key "flashcards" which contains an array of objects. Each object must have a 'front' (question/term) and a 'back' (answer/definition).` });
            if (instructions) promptParts.push({ text: `\n\nFollow these instructions: "${instructions}"` });
            
            const result = await callApiWithRetries({ contents: [{ role: "user", parts: promptParts }] });
            
            flashcardsData = result.flashcards;
            displayFlashcard(0);
            showMessage('Flashcards generated successfully!', 'success');
            
            saveState();

        } catch (error) {
            console.error('Error:', error);
            showMessage(`Failed to generate flashcards: ${error.message}`, 'error');
        } finally {
            clearInterval(interval);
            dom.loadingBar.style.width = '100%';
            setTimeout(() => { dom.loadingBarContainer.style.display = 'none'; dom.loadingBar.style.width = '0%'; }, 500);
        }
    };

    // --- NEW: Function to format and copy flashcards ---
    const copyFlashcards = async (event) => {
        if (!flashcardsData || flashcardsData.length === 0) return;
        
        let flashcardText = "Flashcards\n====================\n\n";
        flashcardsData.forEach((card, index) => {
            flashcardText += `Card ${index + 1}\n`;
            flashcardText += `Front: ${card.front}\n`;
            flashcardText += `Back: ${card.back}\n`;
            flashcardText += "--------------------\n\n";
        });

        try {
            await navigator.clipboard.writeText(flashcardText);
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => button.textContent = originalText, 2000);
        } catch (err) {
            showMessage('Failed to copy flashcards.', 'error');
        }
    };

    dom.inputText.addEventListener('input', saveState);
    dom.customInstructions.addEventListener('input', saveState);

    dom.fileInput.addEventListener('change', async (e) => {
        for (const file of e.target.files) {
            try {
                const { type, content } = await readFileContent(file);
                uploadedFilesData.push({ id: Date.now() + Math.random(), name: file.name, type, content });
                showMessage(`Loaded "${file.name}"`, 'success');
            } catch (error) { showMessage(`Error loading "${file.name}": ${error.message}`, 'error'); }
        }
        updateFileListDisplay();
        e.target.value = '';
    });

    dom.toggleFileListButton.addEventListener('click', () => dom.fileList.classList.toggle('expanded'));
    dom.fileList.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            uploadedFilesData = uploadedFilesData.filter(f => f.id !== parseFloat(e.target.dataset.id));
            updateFileListDisplay();
        }
    });
    dom.clearFileButton.addEventListener('click', () => { uploadedFilesData = []; updateFileListDisplay(); });

    dom.inputText.addEventListener('paste', (e) => {
        for (const item of e.clipboardData.items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                e.preventDefault();
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedFilesData.push({ id: Date.now(), name: 'Pasted Image', type: blob.type, content: event.target.result.split(',')[1] });
                    updateFileListDisplay();
                    showMessage('Image pasted.', 'info');
                };
                reader.readAsDataURL(blob);
                return;
            }
        }
    });

    dom.inputPrevButton.addEventListener('click', () => showInputStep(currentInputStepIndex - 1));
    dom.inputNextButton.addEventListener('click', () => showInputStep(currentInputStepIndex + 1));
    dom.prevButton.addEventListener('click', () => displayFlashcard(currentFlashcardIndex - 1));
    dom.nextButton.addEventListener('click', () => displayFlashcard(currentFlashcardIndex + 1));
    dom.generateButton.addEventListener('click', generateFlashcards);
    
    dom.clearButton.addEventListener('click', clearState);
    
    // --- NEW: Add event listener for the copy button ---
    dom.copyButton.addEventListener('click', copyFlashcards);

    showInputStep(0);
    dom.generateButton.style.display = 'none';
    updateFileListDisplay();
    
    loadState();
}

document.addEventListener('DOMContentLoaded', () => {
    loadHeader();
    initializeFlashcardApp();
});
</script>


<!-- Vercel Analytics -->
<script>
  window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
  window.va('set', 'mode', 'auto');
</script>
<script defer src="/_vercel/insights/script.js"></script>
    
    
</body>
</html>
