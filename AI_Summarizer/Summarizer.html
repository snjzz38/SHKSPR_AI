<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>AI Media Summarizer</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- Marked.js CDN for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- CRITICAL STYLES FOR FOUC PREVENTION --- */
        :root {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #fff; --card-bg: #222; --link-hover: #ffffff;
            --accent-rgb: 255, 255, 255;
        }
        body.theme-cyan {
            --bg-primary: #000; --bg-secondary: #0b0b0b; --text-primary: #e0ffff;
            --accent: #00f6ff; --card-bg: #072a2c; --accent-rgb: 0, 246, 255;
        }
        body.theme-purple {
            --bg-primary: #0d001a; --bg-secondary: #14002b; --text-primary: #ffe6ff;
            --accent: #cc66ff; --card-bg: #1d0036; --accent-rgb: 204, 102, 255;
        }
        body.theme-green {
            --bg-primary: #001a00; --bg-secondary: #002b00; --text-primary: #e6ffe6;
            --accent: #66ff66; --card-bg: #003600; --accent-rgb: 102, 255, 102;
        }
        body.theme-blackwhite {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #e0e0e0; --card-bg: #222; --accent-rgb: 224, 224, 224;
        }
        body.theme-red {
            --bg-primary: #1a0000; --bg-secondary: #2b0000; --text-primary: #ffe6e6;
            --accent: #ff3333; --card-bg: #360000; --accent-rgb: 255, 51, 51;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Page-Specific Styles --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .hero { text-align: center; padding: 50px 20px 30px; position: relative; z-index: 5; }
        .hero h1 {
            font-size: 3.2rem;
            text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent);
            margin-bottom: 20px;
        }
        .hero p { font-size: 1.2rem; margin: 0 auto 30px; text-shadow: 0 0 8px var(--accent); max-width: 600px; }
        .container {
            max-width: 800px; width: 95%; margin: 2rem auto;
            background-color: var(--card-bg); border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .step-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .step-header .title { flex: 2 1 auto; text-align: center; font-size: 1.25rem; font-weight: 600; margin: 0 1rem; }
        .step-header .btn-container { flex: 1 0 0; }
        
        .nav-button, .button {
            background-color: var(--accent); color: var(--bg-primary); padding: 0.8rem 1.75rem;
            border-radius: 9999px; font-weight: bold; font-size: 1rem; cursor: pointer; border: none;
            transition: all 0.3s ease; box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.7);
        }
        .nav-button:hover, .button:hover {
            box-shadow: 0 0 25px rgba(var(--accent-rgb), 1), 0 0 35px rgba(var(--accent-rgb), 0.5);
            transform: translateY(-3px);
        }
        .nav-button:disabled, .button:disabled {
            background-color: #555 !important; color: #999 !important; cursor: not-allowed !important;
            box-shadow: none !important; transform: none !important;
        }
        .clear-button {
            background-color: #4a5568; color: var(--text-primary); padding: 0.8rem 1.75rem;
            border-radius: 9999px; font-weight: bold; font-size: 1rem; cursor: pointer; border: none;
            transition: all 0.3s ease; box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.2);
        }
        .clear-button:hover {
            background-color: #2d3748; transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.4);
        }

        .mode-toggle-btn {
            background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--text-primary);
            padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center;
        }
        .mode-toggle-btn.active {
            background: var(--accent); color: var(--bg-primary); border-color: var(--accent);
            box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); font-weight: bold;
        }
        .input-wrapper { position: relative; }
        .input-clear-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--accent); font-size: 1.5rem; cursor: pointer; line-height: 1; opacity: 0.6; transition: opacity 0.2s; }
        .input-clear-btn:hover { opacity: 1; }
        textarea, .youtube-input { width: 100%; padding: 0.75rem; border: 1px solid var(--accent); border-radius: 0.5rem; background-color: var(--bg-secondary); color: var(--text-primary); resize: vertical; }
        textarea { min-height: 150px; }
        textarea:focus, .youtube-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.5); }
        .file-upload-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; align-items: center; }
        .file-input-wrapper { position: relative; display: flex; align-items: center; gap: 10px; width: 100%; max-width: 400px; }
        .file-input-label { background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent); padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; white-space: nowrap; z-index: 1; }
        .file-input-label:hover { background: var(--accent); color: var(--bg-primary); }
        .file-input-wrapper input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 2; }
        .file-name-display { flex-grow: 1; padding: 8px 10px; border: 1px solid var(--card-bg); border-radius: 8px; background-color: var(--bg-primary); color: rgba(var(--accent-rgb), 0.8); font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-clear-button { background: none; border: none; color: var(--accent); font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-clear-button:hover { color: var(--text-primary); }
        .file-list-container { width: 100%; max-width: 400px; margin-top: 15px; }
        .file-list-toggle-button { background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; margin-bottom: 10px; width: 100%; }
        .file-list-toggle-button:hover { background: var(--accent); color: var(--bg-primary); }
        .file-list { list-style: none; padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; border: 1px solid var(--card-bg); border-radius: 8px; background-color: var(--bg-primary); }
        .file-list.expanded { max-height: 200px; overflow-y: auto; padding: 10px; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid rgba(var(--accent-rgb), 0.2); font-size: 0.9rem; }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item span { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-list-item button { background: none; border: none; color: #ff6666; font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-list-item button:hover { color: #ff0000; }
        .slider-group { margin-top: 1rem; text-align: center; }
        .slider-group label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
        .slider-group input[type="range"] { width: 80%; -webkit-appearance: none; height: 8px; background: var(--bg-secondary); border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
        .slider-group input[type="range"]:hover { opacity: 1; }
        .slider-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 2px 4px rgba(var(--accent-rgb), 0.5); }
        .slider-group input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 2px 4px rgba(var(--accent-rgb), 0.5); }
        .slider-value { margin-top: 0.5rem; font-weight: 500; }
        .hidden { display: none; }
        .prompt-input-group .label-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .prompt-input-group .label-header label { font-weight: 600; margin-bottom: 0; }
        .prompt-input-group .copy-btn { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent); padding: 4px 10px; font-size: 0.8rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .prompt-input-group .copy-btn:hover { background-color: var(--accent); color: var(--bg-primary); }
        .prompt-input-group .copy-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; }
        .output-content { background: var(--bg-primary); border: 1px solid var(--accent); border-radius: 8px; padding: 1rem; min-height: 250px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
        .prose { color: var(--text-primary); }
        .prose h1, .prose h2, .prose h3 { color: var(--accent); }
        .prose a { color: var(--accent); text-decoration: underline; }
        .prose strong { color: var(--text-primary); }
        .prose ul > li::before { background-color: var(--accent); }
        footer.main-footer { text-align: center; padding: 20px; font-size: 0.9rem; color: var(--text-primary); background-color: var(--bg-secondary); position: relative; z-index: 10; margin-top: auto; }
    </style>
    <script>
        (function() {
            try {
                const theme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                document.documentElement.className = theme;
            } catch (e) {}
        })();
    </script>
</head>
<body>
    <div id="header-container"></div>

    <main class="main-content animate-on-load">
        <section class="hero">
            <h1>AI Media Summarizer</h1>
            <p>Provide text, an image, an audio file, or a YouTube link and the AI will summarize its contents.</p>
        </section>

        <div class="container" style="transform: translateY(-50px);">
            
            <div id="step1" class="step-content">
                <div class="step-header">
                    <div class="btn-container"></div>
                    <h2 class="title">Step 1: Choose Content Type</h2>
                    <div class="btn-container"></div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <button id="modeTextBtn" class="mode-toggle-btn">Text</button>
                    <button id="modeImageBtn" class="mode-toggle-btn">Image</button>
                    <button id="modeAudioBtn" class="mode-toggle-btn">Audio</button>
                    <button id="modeYoutubeBtn" class="mode-toggle-btn">YouTube Video</button>
                </div>
            </div>

            <div id="step2" class="step-content hidden">
                <div class="step-header">
                    <div class="btn-container text-left"><button class="nav-button" onclick="prevStep()">Back</button></div>
                    <h2 id="step2-title" class="title">Step 2: Provide Content</h2>
                    <div class="btn-container text-right"><button class="nav-button" onclick="nextStep()">Next</button></div>
                </div>
                
                <div id="textInputContainer" class="hidden">
                    <div class="input-wrapper">
                        <textarea id="textInput" rows="8" placeholder="Paste your text here..."></textarea>
                        <button id="clearTextInput" class="input-clear-btn">&times;</button>
                    </div>
                </div>
                <div id="youtubeInputContainer" class="hidden">
                    <div class="input-wrapper">
                        <input type="text" id="youtubeUrlInput" class="youtube-input" placeholder="Enter YouTube Video URL...">
                        <button id="clearYoutubeInput" class="input-clear-btn">&times;</button>
                    </div>
                </div>
                <div id="fileUploadContainer" class="file-upload-container hidden">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" multiple>
                        <label for="fileInput" id="fileInputLabel" class="file-input-label">Upload Files</label>
                        <span id="fileNameDisplay" class="file-name-display">No files chosen</span>
                        <button id="fileClearButton" class="file-clear-button" style="display:none;">&times;</button>
                    </div>
                    <div class="file-list-container">
                        <button id="toggleFileListButton" class="file-list-toggle-button" style="display:none;">Show Uploaded Files (0)</button>
                        <ul id="fileList" class="file-list"></ul>
                    </div>
                </div>
            </div>

            <div id="step3" class="step-content hidden">
                <div class="step-header">
                    <div class="btn-container text-left"><button class="nav-button" onclick="prevStep()">Back</button></div>
                    <h2 class="title">Step 3: Customize & Summarize</h2>
                    <div class="btn-container"></div>
                </div>
                <div class="slider-group">
                    <label for="concisenessSlider">Conciseness (1-10):</label>
                    <input type="range" id="concisenessSlider" min="1" max="10" value="5">
                    <span id="concisenessValue" class="slider-value">5</span>
                </div>
                <div class="prompt-input-group">
                    <div class="label-header">
                        <label for="summarizationPrompt">Summarization Prompt (Customizable):</label>
                    </div>
                    <textarea id="summarizationPrompt" rows="5"></textarea>
                </div>
            </div>

            <div id="action-buttons-container" class="hidden">
                <div class="mt-6 space-y-4">
                    <button id="processBtn" class="button w-full flex items-center justify-center" disabled>
                        Process Content
                        <span id="processLoadingIndicator" class="loading-spinner hidden"></span>
                    </button>
                    <button id="clearButton" class="w-full clear-button">Clear All & Reset</button>
                </div>
            </div>
            
            <div id="processMessageDiv" class="message-box hidden"></div>
            
            <div id="transcribedTextContainer" class="prompt-input-group hidden mt-8">
                <div class="label-header">
                    <label>Source Content / Description:</label>
                    <button id="copyTranscriptBtn" class="copy-btn">Copy</button>
                </div>
                <div id="transcribedTextOutput" class="output-content prose"></div>
            </div>
            
            <div id="summaryContainer" class="prompt-input-group hidden mt-8">
                <div class="label-header">
                    <label>Summary:</label>
                    <button id="copySummaryBtn" class="copy-btn">Copy</button>
                </div>
                <div id="summaryOutput" class="output-content prose"></div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <p>&copy; 2025 Shkspr. All rights reserved.</p>
    </footer>

    <script>
        let GEMINI_API_KEY = null;
        const ALL_GEMINI_MODELS = [
            'gemini-1.5-flash', 'gemini-1.5-pro',
            'gemini-2.5-flash-preview-05-20', 'gemini-2.5-flash',
            'gemini-2.5-flash-lite-preview-06-17', 'gemini-2.0-flash',
        ];
        
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        
        async function loadHeader() {
          try {
            const response = await fetch('../Structure/header.html');
            if (!response.ok) throw new Error('Failed to load header');
            const text = await response.text();
            
            document.getElementById('header-container').innerHTML = text;

            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const scriptElement = doc.querySelector('script');
            if (scriptElement) {
                const newScript = document.createElement('script');
                newScript.textContent = scriptElement.textContent;
                document.body.appendChild(newScript);
            }
            
            if (window.setTheme && window.initParticles) {
                const savedTheme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                window.setTheme(savedTheme);

                document.getElementById('theme-blackwhite-btn').addEventListener('click', () => window.setTheme('theme-blackwhite'));
                document.getElementById('theme-cyan-btn').addEventListener('click', () => window.setTheme('theme-cyan'));
                document.getElementById('theme-purple-btn').addEventListener('click', () => window.setTheme('theme-purple'));
                document.getElementById('theme-green-btn').addEventListener('click', () => window.setTheme('theme-green'));
                document.getElementById('theme-red-btn').addEventListener('click', () => window.setTheme('theme-red'));
            }
          } catch (error) {
            console.error('Error loading header:', error);
            document.getElementById('header-container').innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error loading header.</p>';
          }
        }

        function initializeApp() {
            const dom = {
                steps: [document.getElementById('step1'), document.getElementById('step2'), document.getElementById('step3')],
                step2Title: document.getElementById('step2-title'),
                modeButtons: {
                    text: document.getElementById('modeTextBtn'),
                    image: document.getElementById('modeImageBtn'),
                    audio: document.getElementById('modeAudioBtn'),
                    youtube: document.getElementById('modeYoutubeBtn'),
                },
                inputContainers: {
                    text: document.getElementById('textInputContainer'),
                    youtube: document.getElementById('youtubeInputContainer'),
                    file: document.getElementById('fileUploadContainer'),
                },
                inputs: {
                    text: document.getElementById('textInput'),
                    file: document.getElementById('fileInput'),
                    youtube: document.getElementById('youtubeUrlInput'),
                },
                clearInputs: {
                    text: document.getElementById('clearTextInput'),
                    youtube: document.getElementById('clearYoutubeInput'),
                },
                fileInputLabel: document.getElementById('fileInputLabel'),
                fileNameDisplay: document.getElementById('fileNameDisplay'),
                fileClearButton: document.getElementById('fileClearButton'),
                fileList: document.getElementById('fileList'),
                toggleFileListButton: document.getElementById('toggleFileListButton'),
                processBtn: document.getElementById('processBtn'),
                clearButton: document.getElementById('clearButton'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                processLoadingIndicator: document.getElementById('processLoadingIndicator'),
                processMessageDiv: document.getElementById('processMessageDiv'),
                transcribedTextContainer: document.getElementById('transcribedTextContainer'),
                transcribedTextOutput: document.getElementById('transcribedTextOutput'),
                summaryContainer: document.getElementById('summaryContainer'),
                summaryOutput: document.getElementById('summaryOutput'),
                summarizationPromptInput: document.getElementById('summarizationPrompt'),
                concisenessSlider: document.getElementById('concisenessSlider'),
                concisenessValueSpan: document.getElementById('concisenessValue'),
                copyTranscriptBtn: document.getElementById('copyTranscriptBtn'),
                copySummaryBtn: document.getElementById('copySummaryBtn'),
            };
            
            let currentStep = 0;
            let currentMode = 'text';
            let uploadedFilesData = [];

            const hideElement = (el) => el.classList.add('hidden');
            const showElement = (el) => el.classList.remove('hidden');
            
            function displayMessage(message, isError = false) {
                dom.processMessageDiv.textContent = message;
                dom.processMessageDiv.className = 'message-box';
                dom.processMessageDiv.classList.add(isError ? 'error' : 'info');
                showElement(dom.processMessageDiv);
            }
            function clearMessages() { hideElement(dom.processMessageDiv); }

            async function readFileContent(file) {
                return new Promise(async (resolve, reject) => {
                    const reader = new FileReader();
                    reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));

                    if (file.type.startsWith('image/') || file.type.startsWith('audio/')) {
                        reader.onload = (e) => resolve({ type: file.type, content: e.target.result.split(',')[1] });
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        try {
                            const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                text += content.items.map(item => item.str).join(' ') + '\n';
                            }
                            resolve({ type: 'text/plain', content: text });
                        } catch (e) { reject(e); }
                    } else if (file.type.startsWith('text/') || file.name.endsWith('.md')) {
                        reader.onload = (e) => resolve({ type: 'text/plain', content: e.target.result });
                        reader.readAsText(file);
                    } else {
                        reject(new Error(`Unsupported file type: ${file.type}`));
                    }
                });
            };
            
            function generateSummarizationInstruction(level) {
                const basePrompt = "You are an expert summarization engine. Your task is to analyze the provided text, which is a transcript of an audio recording or video. Your goal is to distill the core information into a clear, accurate, and easy-to-understand format. Adhere strictly to the specific summarization instruction that follows.";
                let specificInstruction = '';

                switch (level) {
                    case 1:
                        specificInstruction = "Identify the single most important keyword or concept from the text. Output only that single word or short phrase.";
                        break;
                    case 2:
                        specificInstruction = "Generate a compelling, clickbait-style headline (6-12 words) for the text. It should be intriguing and capture the main point.";
                        break;
                    case 3:
                        specificInstruction = "Condense the entire text into a single, concise sentence (a logline or elevator pitch).";
                        break;
                    case 4:
                        specificInstruction = "Provide a concise executive summary (2-3 sentences). Focus on the main conclusion and the most critical supporting points.";
                        break;
                    case 5:
                        specificInstruction = "Summarize the text into 3-5 key bullet points using Markdown. Each bullet point should clearly state a main argument or finding.";
                        break;
                    case 6:
                        specificInstruction = "Create a list of 'Expanded Bullet Points'. For each of the 3-4 main points, provide the point as a bolded title, followed by a 1-2 sentence explanation.";
                        break;
                    case 7:
                        specificInstruction = "Create a detailed summary with two sections using Markdown. First, a summary paragraph (4-6 sentences). Second, a bulleted list of 'Key Takeaways'.";
                        break;
                    case 8:
                        specificInstruction = "Generate a summary in a 'Frequently Asked Questions' (FAQ) format. Create 3-5 relevant questions that the text answers, and provide concise answers for each.";
                        break;
                    case 9:
                        specificInstruction = "Provide a 'Detailed Analysis' of the text using Markdown. Include three sections: **Main Arguments**, **Supporting Evidence**, and **Overall Conclusion**.";
                        break;
                    case 10:
                        specificInstruction = "Generate a comprehensive briefing document from the text, formatted in Markdown. It must include the following sections:\n- **Headline:** A compelling title.\n- **Abstract:** A one-paragraph (4-5 sentences) summary.\n- **Key Points:** A detailed bulleted list covering all significant arguments and conclusions.\n- **Action Items:** (If applicable) A bulleted list of any tasks or recommendations mentioned.";
                        break;
                    default:
                        specificInstruction = "Summarize the text into 3-5 key bullet points using Markdown.";
                }
                return `${basePrompt}\n\n--- SPECIFIC INSTRUCTION ---\n${specificInstruction}`;
            }

            function updateSummarizationPrompt() {
                const level = parseInt(dom.concisenessSlider.value, 10);
                dom.concisenessValueSpan.textContent = level;
                dom.summarizationPromptInput.value = generateSummarizationInstruction(level);
            }
            
            async function getApiKeyFromFile() {
                try {
                    const response = await fetch('Grok4.txt');
                    if (!response.ok) throw new Error(`Network response was not ok`);
                    const apiKey = (await response.text()).trim();
                    let output = "";
                    for (let i = 0; i < apiKey.length; i++) {
                        if ((i + 1) % 5 === 1) output += apiKey[i];
                    }
                    return output;
                } catch (error) {
                    console.error("Failed to load API key:", error);
                    return null;
                }
            }
            
            async function callGeminiApi(payload) {
                if (!GEMINI_API_KEY) throw new Error("API Key is not configured.");
                let modelsToTry = shuffleArray([...ALL_GEMINI_MODELS]);
                let lastError = null;
                for (const currentModel of modelsToTry) {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${GEMINI_API_KEY}`;
                    console.log(`Attempting API call with model: ${currentModel}`);
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            const errorMessage = errorData.error?.message || response.statusText;
                            throw new Error(`API call with ${currentModel} failed (Status: ${response.status}): ${errorMessage}`);
                        }
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text && text.trim() !== '') {
                            console.log(`Success with model: ${currentModel}`);
                            return result;
                        } else {
                            throw new Error(`Model ${currentModel} returned an empty or invalid response.`);
                        }
                    } catch (error) {
                        console.warn(error.message);
                        lastError = error;
                    }
                }
                throw lastError || new Error("All available models have been tried and failed.");
            }

            function extractVideoId(url) {
                const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                const matches = url.match(regex);
                return matches ? matches[1] : null;
            }

            async function fetchYouTubeTranscript(videoId) {
                const response = await fetch(`/api/youtube_transcript?video_id=${videoId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch YouTube transcript.');
                }
                const data = await response.json();
                return data.transcript;
            }
            
            async function processContent() {
                clearAllResults();
                showElement(dom.processLoadingIndicator);
                dom.processBtn.disabled = true;

                try {
                    let sourceContent = '';
                    let promptParts = [];

                    if (currentMode === 'text') {
                        sourceContent = dom.inputs.text.value.trim();
                        for (const file of uploadedFilesData) {
                            sourceContent += `\n\n--- From File: ${file.name} ---\n${file.content}`;
                        }
                        sourceContent = sourceContent.trim();
                        if (!sourceContent) throw new Error('Please enter text or upload a text file.');
                        displayMessage("Summarizing text...", false);
                        dom.transcribedTextOutput.innerHTML = marked.parse("N/A - Direct text/file input was used.");
                        showElement(dom.transcribedTextContainer);
                        promptParts.push({ text: sourceContent });
                    } else if (currentMode === 'youtube') {
                        const url = dom.inputs.youtube.value;
                        if (!url) throw new Error('Please enter a YouTube URL.');
                        const videoId = extractVideoId(url);
                        if (!videoId) throw new Error('Invalid YouTube URL.');
                        displayMessage("Fetching YouTube transcript...", false);
                        sourceContent = await fetchYouTubeTranscript(videoId);
                        if (!sourceContent || sourceContent.trim() === '') throw new Error("Could not fetch transcript for this video.");
                        dom.transcribedTextOutput.innerHTML = marked.parse(sourceContent);
                        showElement(dom.transcribedTextContainer);
                        localStorage.setItem('summarizerTranscript', sourceContent);
                        promptParts.push({ text: sourceContent });
                    } else { // Image or Audio
                        if (uploadedFilesData.length === 0) throw new Error(`Please select one or more ${currentMode} files.`);
                        
                        const message = currentMode === 'image' ? 'Analyzing image(s)...' : 'Transcribing audio...';
                        displayMessage(message, false);

                        for (const file of uploadedFilesData) {
                            const promptText = currentMode === 'image' ? `Describe this image in detail, capturing all text, objects, and the overall context. The file is named "${file.name}":` : `Transcribe the following audio file accurately. Provide only the text of the transcription. The file is named "${file.name}":`;
                            promptParts.push({ text: promptText });
                            promptParts.push({ inlineData: { mimeType: file.type, data: file.content } });
                        }
                        
                        const firstStepPayload = { contents: [{ parts: promptParts }] };
                        const result = await callGeminiApi(firstStepPayload);
                        sourceContent = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!sourceContent || sourceContent.trim() === '') throw new Error("Failed to process the file(s). They might be empty or unsupported.");
                        
                        dom.transcribedTextOutput.innerHTML = marked.parse(sourceContent);
                        showElement(dom.transcribedTextContainer);
                        localStorage.setItem('summarizerTranscript', sourceContent);
                    }

                    displayMessage("Processing complete. Now summarizing...", false);
                    const summarizationPrompt = dom.summarizationPromptInput.value;
                    const summaryPayload = {
                        contents: [{ parts: [{ text: `${summarizationPrompt}\n\n---\n\n${sourceContent}` }] }]
                    };
                    const summaryResult = await callGeminiApi(summaryPayload);
                    const summary = summaryResult.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!summary || summary.trim() === '') throw new Error("Summarization failed or returned empty.");

                    dom.summaryOutput.innerHTML = marked.parse(summary);
                    showElement(dom.summaryContainer);
                    localStorage.setItem('summarizerSummary', summary);
                    clearMessages();

                } catch (error) {
                    displayMessage(error.message, true);
                } finally {
                    hideElement(dom.processLoadingIndicator);
                    dom.processBtn.disabled = false;
                }
            }

            function updateButtonState() {
                let isReady = false;
                if (currentMode === 'text') {
                    isReady = dom.inputs.text.value.trim() !== '' || uploadedFilesData.length > 0;
                } else if (currentMode === 'image' || currentMode === 'audio') {
                    isReady = uploadedFilesData.length > 0;
                } else if (currentMode === 'youtube') {
                    isReady = dom.inputs.youtube.value.trim() !== '';
                }
                dom.processBtn.disabled = !GEMINI_API_KEY || !isReady;
            }
            
            function showStep(index) {
                dom.steps.forEach((step, i) => step.classList.toggle('hidden', i !== index));
                currentStep = index;
                dom.actionButtonsContainer.classList.toggle('hidden', index !== dom.steps.length - 1);
            }

            window.nextStep = () => { if (currentStep < dom.steps.length - 1) showStep(currentStep + 1); };
            window.prevStep = () => { if (currentStep > 0) showStep(currentStep - 1); };

            function setMode(mode) {
                currentMode = mode;
                clearMessages();
                uploadedFilesData = [];
                updateFileListDisplay();
                
                Object.values(dom.modeButtons).forEach(btn => btn.classList.remove('active'));
                dom.modeButtons[mode].classList.add('active');
                
                hideElement(dom.inputContainers.text);
                hideElement(dom.inputContainers.youtube);
                hideElement(dom.inputContainers.file);

                if (mode === 'text') {
                    showElement(dom.inputContainers.text);
                    showElement(dom.inputContainers.file);
                    dom.step2Title.textContent = "Step 2: Provide Text";
                } else if (mode === 'youtube') {
                    showElement(dom.inputContainers.youtube);
                    dom.step2Title.textContent = "Step 2: Provide YouTube URL";
                } else {
                    showElement(dom.inputContainers.file);
                    dom.step2Title.textContent = `Step 2: Upload ${mode.charAt(0).toUpperCase() + mode.slice(1)}(s)`;
                }
                
                const fileInput = dom.inputs.file;
                if (mode === 'text') { fileInput.accept = ".txt,.pdf,.md"; dom.fileInputLabel.textContent = "Upload Text File(s)"; }
                else if (mode === 'image') { fileInput.accept = "image/*"; dom.fileInputLabel.textContent = "Upload Image File(s)"; }
                else if (mode === 'audio') { fileInput.accept = "audio/*"; dom.fileInputLabel.textContent = "Upload Audio File(s)"; }
                
                nextStep();
            }

            function updateFileListDisplay() {
                dom.fileNameDisplay.textContent = uploadedFilesData.length > 0 ? `${uploadedFilesData.length} file(s) chosen` : 'No files chosen';
                dom.fileClearButton.style.display = uploadedFilesData.length > 0 ? 'inline-block' : 'none';
                dom.toggleFileListButton.style.display = uploadedFilesData.length > 0 ? 'block' : 'none';
                dom.toggleFileListButton.textContent = `Show Uploaded Files (${uploadedFilesData.length})`;
                
                dom.fileList.innerHTML = '';
                uploadedFilesData.forEach(file => {
                    const item = document.createElement('li');
                    item.className = 'file-list-item';
                    item.innerHTML = `<span>${file.name}</span><button data-id="${file.id}">&times;</button>`;
                    dom.fileList.appendChild(item);
                });
                dom.fileList.classList.toggle('expanded', uploadedFilesData.length > 0 && dom.fileList.classList.contains('expanded'));
            }

            function clearState() {
                dom.inputs.text.value = '';
                dom.inputs.youtube.value = '';
                uploadedFilesData = [];
                updateFileListDisplay();
                clearAllResults();
                localStorage.removeItem('summarizerTextInput');
                localStorage.removeItem('summarizerYoutubeInput');
                localStorage.removeItem('summarizerTranscript');
                localStorage.removeItem('summarizerSummary');
                showStep(0);
            }

            function clearAllResults() {
                hideElement(dom.transcribedTextContainer);
                hideElement(dom.summaryContainer);
                dom.transcribedTextOutput.innerHTML = '';
                dom.summaryOutput.innerHTML = '';
            }

            function loadSavedResults() {
                dom.inputs.text.value = localStorage.getItem('summarizerTextInput') || '';
                dom.inputs.youtube.value = localStorage.getItem('summarizerYoutubeInput') || '';
                const savedTranscript = localStorage.getItem('summarizerTranscript');
                const savedSummary = localStorage.getItem('summarizerSummary');

                if (savedTranscript) {
                    dom.transcribedTextOutput.innerHTML = marked.parse(savedTranscript);
                    showElement(dom.transcribedTextContainer);
                }
                if (savedSummary) {
                    dom.summaryOutput.innerHTML = marked.parse(savedSummary);
                    showElement(dom.summaryContainer);
                }
            }

            // --- ADDED THIS FUNCTION ---
            function copyToClipboard(text, buttonElement) {
                if (!navigator.clipboard) {
                    console.error('Clipboard API not available.');
                    alert('Copying to clipboard is not supported on your browser.');
                    return;
                }
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = 'Copied!';
                    buttonElement.disabled = true;
                    setTimeout(() => {
                        buttonElement.textContent = originalText;
                        buttonElement.disabled = false;
                    }, 2000); // Revert after 2 seconds
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy text.');
                });
            }

            // Event Listeners
            dom.inputs.text.addEventListener('input', () => { updateButtonState(); localStorage.setItem('summarizerTextInput', dom.inputs.text.value); });
            dom.inputs.youtube.addEventListener('input', () => { updateButtonState(); localStorage.setItem('summarizerYoutubeInput', dom.inputs.youtube.value); });
            dom.clearInputs.text.addEventListener('click', () => { dom.inputs.text.value = ''; updateButtonState(); localStorage.setItem('summarizerTextInput', ''); });
            dom.clearInputs.youtube.addEventListener('click', () => { dom.inputs.youtube.value = ''; updateButtonState(); localStorage.setItem('summarizerYoutubeInput', ''); });
            dom.inputs.file.addEventListener('change', async (e) => {
                for (const file of e.target.files) {
                    try {
                        const { type, content } = await readFileContent(file);
                        uploadedFilesData.push({ id: Date.now() + Math.random(), name: file.name, type, content });
                    } catch (error) { displayMessage(error.message, true); }
                }
                updateFileListDisplay(); updateButtonState(); e.target.value = '';
            });
            dom.fileClearButton.addEventListener('click', () => { uploadedFilesData = []; updateFileListDisplay(); updateButtonState(); });
            dom.fileList.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const idToRemove = parseFloat(e.target.dataset.id);
                    uploadedFilesData = uploadedFilesData.filter(f => f.id !== idToRemove);
                    updateFileListDisplay(); updateButtonState();
                }
            });
            dom.toggleFileListButton.addEventListener('click', () => dom.fileList.classList.toggle('expanded'));
            dom.concisenessSlider.addEventListener('input', updateSummarizationPrompt);
            dom.processBtn.addEventListener('click', processContent);
            dom.clearButton.addEventListener('click', clearState);
            Object.entries(dom.modeButtons).forEach(([mode, button]) => { button.addEventListener('click', () => setMode(mode)); });
            dom.copyTranscriptBtn.addEventListener('click', () => copyToClipboard(dom.transcribedTextOutput.textContent, dom.copyTranscriptBtn));
            dom.copySummaryBtn.addEventListener('click', () => copyToClipboard(dom.summaryOutput.textContent, dom.copySummaryBtn));

            // Initial setup
            updateSummarizationPrompt();
            showStep(0);
            loadSavedResults();
            (async () => {
                displayMessage("Loading API key...");
                GEMINI_API_KEY = await getApiKeyFromFile();
                if (GEMINI_API_KEY) { clearMessages(); updateButtonState(); }
                else { displayMessage("Failed to load API key. Application cannot function.", true); }
            })();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHeader();
            initializeApp();
        });
    </script>
</body>
</html>
```
