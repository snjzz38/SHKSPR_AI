<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Multi-Modal Summarization</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- CRITICAL STYLES FOR FOUC PREVENTION --- */
        :root {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #fff; --card-bg: #222; --link-hover: #ffffff;
            --accent-rgb: 255, 255, 255;
        }
        body.theme-cyan {
            --bg-primary: #000; --bg-secondary: #0b0b0b; --text-primary: #e0ffff;
            --accent: #00f6ff; --card-bg: #072a2c; --accent-rgb: 0, 246, 255;
        }
        body.theme-purple {
            --bg-primary: #0d001a; --bg-secondary: #14002b; --text-primary: #ffe6ff;
            --accent: #cc66ff; --card-bg: #1d0036; --accent-rgb: 204, 102, 255;
        }
        body.theme-green {
            --bg-primary: #001a00; --bg-secondary: #002b00; --text-primary: #e6ffe6;
            --accent: #66ff66; --card-bg: #003600; --accent-rgb: 102, 255, 102;
        }
        body.theme-blackwhite {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #e0e0e0; --card-bg: #222; --accent-rgb: 224, 224, 224;
        }
        body.theme-red {
            --bg-primary: #1a0000; --bg-secondary: #2b0000; --text-primary: #ffe6e6;
            --accent: #ff3333; --card-bg: #360000; --accent-rgb: 255, 51, 51;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Page-Specific Styles --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .hero { text-align: center; padding: 50px 20px 30px; position: relative; z-index: 5; }
        .hero h1 {
            font-size: 3.2rem;
            text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent), 0 0 40px var(--accent), 0 0 50px var(--accent), 0 0 60px var(--accent);
            margin-bottom: 20px;
        }
        .hero p { font-size: 1.2rem; margin: 0 auto 30px; text-shadow: 0 0 8px var(--accent); max-width: 600px; }
        .container {
            max-width: 800px; width: 95%; margin: 2rem auto;
            background-color: var(--card-bg); border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem; text-align: center;
        }
        .button {
            background-color: var(--accent); color: var(--bg-primary); padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none;
            transition: background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
        }
        .button:hover {
            background-color: var(--text-primary);
            color: var(--bg-primary);
            box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.7);
        }
        .button:disabled { background-color: #666; cursor: not-allowed; box-shadow: none; }
        .loading-spinner {
            border: 4px solid rgba(var(--accent-rgb), 0.3); border-left-color: var(--accent);
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite; display: inline-block;
            vertical-align: middle; margin-left: 0.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .message-box {
            padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem;
            text-align: left; border: 1px solid;
        }
        .message-box.info {
            background-color: rgba(var(--accent-rgb), 0.1);
            border-color: var(--accent);
            color: var(--text-primary);
        }
        .message-box.error {
            --error-rgb: 239, 68, 68;
            background-color: rgba(var(--error-rgb), 0.1);
            border-color: rgb(var(--error-rgb));
            color: #fecaca;
        }
        .prompt-input-group { margin-top: 1rem; text-align: left; }
        .prompt-input-group .label-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .prompt-input-group .label-header label { font-weight: 600; margin-bottom: 0; }
        .prompt-input-group .copy-btn {
            background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent);
            padding: 4px 10px; font-size: 0.8rem; border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .prompt-input-group .copy-btn:hover { background-color: var(--accent); color: var(--bg-primary); }
        .prompt-input-group textarea, .youtube-input {
            width: 100%; padding: 0.75rem; border: 1px solid var(--accent);
            border-radius: 0.5rem; background-color: var(--bg-secondary);
            color: var(--text-primary); resize: vertical;
        }
        .prompt-input-group textarea { min-height: 120px; }
        .prompt-input-group textarea[readonly] {
            min-height: 250px;
            background-color: var(--bg-primary);
        }
        .prompt-input-group textarea:focus, .youtube-input:focus {
            outline: none; border-color: var(--text-primary); box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.5);
        }
        .slider-group { margin-top: 1rem; text-align: center; }
        .slider-group label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
        .slider-group input[type="range"] {
            width: 80%; -webkit-appearance: none; height: 8px; background: var(--bg-secondary);
            border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s;
        }
        .slider-group input[type="range"]:hover { opacity: 1; }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: var(--accent); cursor: pointer;
            box-shadow: 0 2px 4px rgba(var(--accent-rgb), 0.5);
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%; background: var(--accent); cursor: pointer;
            box-shadow: 0 2px 4px rgba(var(--accent-rgb), 0.5);
        }
        .slider-value { margin-top: 0.5rem; font-weight: 500; }
        .hidden { display: none; }
        .mode-toggle-btn {
            background-color: transparent; border: 1px solid var(--accent);
            color: var(--text-primary); padding: 0.5rem 1rem; border-radius: 0.5rem;
            cursor: pointer; transition: all 0.3s;
        }
        .mode-toggle-btn.active {
            background-color: var(--accent); color: var(--bg-primary);
            box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
        }
        footer.main-footer {
            text-align: center; padding: 20px; font-size: 0.9rem; color: var(--text-primary);
            background-color: var(--bg-secondary); position: relative; z-index: 10; margin-top: auto;
        }
        /* --- NEW: Consistent File Upload Styles --- */
        .file-upload-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; align-items: center; }
        .file-input-wrapper { position: relative; display: flex; align-items: center; gap: 10px; width: 100%; max-width: 400px; }
        .file-input-label {
            background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent);
            padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s; white-space: nowrap; z-index: 1;
        }
        .file-input-label:hover { background: var(--accent); color: var(--bg-primary); }
        .file-input-wrapper input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 2; }
        .file-name-display {
            flex-grow: 1; padding: 8px 10px; border: 1px solid var(--card-bg); border-radius: 8px;
            background-color: var(--bg-primary); color: rgba(var(--accent-rgb), 0.8); font-size: 0.9rem;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
    </style>
    <script>
        // DEFINITIVE FOUC FIX: Inline script to apply theme before rendering
        (function() {
            try {
                const theme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                document.documentElement.className = theme;
            } catch (e) {}
        })();
    </script>
</head>
<body>
    <!-- Container for the dynamically loaded header -->
    <div id="header-container"></div>

    <main class="main-content animate-on-load">
        <section class="hero">
            <h1>Gemini Multi-Modal Summarization</h1>
            <p>Provide text, an image, an audio file, or a YouTube link to transcribe and summarize it using the Gemini AI model.</p>
        </section>

        <div class="container" style="transform: translateY(-50px);">
            <h2 class="text-2xl font-semibold mb-4">Summarize Content</h2>

            <div class="flex justify-center gap-4 mb-6 flex-wrap">
                <button id="modeTextBtn" class="mode-toggle-btn active">Text</button>
                <button id="modeImageBtn" class="mode-toggle-btn">Image</button>
                <button id="modeAudioBtn" class="mode-toggle-btn">Audio</button>
                <button id="modeYoutubeBtn" class="mode-toggle-btn">YouTube Video</button>
            </div>
            
            <!-- Text Input Section -->
            <div id="textInputContainer">
                <div class="prompt-input-group">
                    <textarea id="textInput" rows="8" placeholder="Paste your text here..."></textarea>
                </div>
                <div class="file-upload-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="textFileInput" accept=".txt,.pdf,.md">
                        <label for="textFileInput" class="file-input-label">Upload Text File</label>
                        <span id="textFileNameDisplay" class="file-name-display">No file chosen</span>
                    </div>
                </div>
            </div>

            <!-- Image Input Section -->
            <div id="imageInputContainer" class="hidden">
                <div class="file-upload-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageFileInput" accept="image/*">
                        <label for="imageFileInput" class="file-input-label">Upload Image File</label>
                        <span id="imageFileNameDisplay" class="file-name-display">No file chosen</span>
                    </div>
                </div>
            </div>

            <!-- Audio Input Section -->
            <div id="audioInputContainer" class="hidden">
                <div class="file-upload-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="audioFileInput" accept="audio/mp3, audio/m4a">
                        <label for="audioFileInput" class="file-input-label">Upload Audio File</label>
                        <span id="audioFileNameDisplay" class="file-name-display">No file chosen</span>
                    </div>
                </div>
            </div>

            <!-- YouTube Input Section -->
            <div id="youtubeInputContainer" class="hidden">
                <input type="text" id="youtubeUrlInput" class="youtube-input" placeholder="Enter YouTube Video URL...">
            </div>
            
            <div class="slider-group">
                <label for="concisenessSlider">Conciseness (1-10):</label>
                <input type="range" id="concisenessSlider" min="1" max="10" value="5">
                <span id="concisenessValue" class="slider-value">5</span>
            </div>

            <div class="prompt-input-group">
                <div class="label-header">
                    <label for="summarizationPrompt">Summarization Prompt (Customizable):</label>
                </div>
                <textarea id="summarizationPrompt" rows="5"></textarea>
            </div>

            <button id="processBtn" class="button flex items-center justify-center mx-auto mt-4" disabled>
                Process Content
                <span id="processLoadingIndicator" class="loading-spinner hidden"></span>
            </button>
            
            <div id="processMessageDiv" class="message-box hidden"></div>
            
            <!-- Transcribed Text Output Section -->
            <div id="transcribedTextContainer" class="prompt-input-group hidden">
                <div class="label-header">
                    <label for="transcribedTextOutput">Source Content / Description:</label>
                    <button id="copyTranscriptBtn" class="copy-btn">Copy</button>
                </div>
                <textarea id="transcribedTextOutput" readonly></textarea>
            </div>
            
            <!-- Summary Output Section -->
            <div id="summaryContainer" class="prompt-input-group hidden">
                <div class="label-header">
                    <label for="summaryOutput">Summary:</label>
                    <button id="copySummaryBtn" class="copy-btn">Copy</button>
                </div>
                <textarea id="summaryOutput" readonly></textarea>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <p>&copy; 2025 Shkspr. All rights reserved.</p>
    </footer>

    <script>
        let GEMINI_API_KEY = null;
        const ALL_GEMINI_MODELS = [
            'gemini-1.5-flash', 'gemini-1.5-pro',
            'gemini-2.5-flash-preview-05-20', 'gemini-2.5-flash',
            'gemini-2.5-flash-lite-preview-06-17', 'gemini-2.0-flash',
        ];
        const MAX_RETRIES = ALL_GEMINI_MODELS.length;
        
        async function loadHeader() {
          try {
            const response = await fetch('../Structure/header.html');
            if (!response.ok) throw new Error('Failed to load header');
            const text = await response.text();
            
            document.getElementById('header-container').innerHTML = text;

            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const scriptElement = doc.querySelector('script');
            if (scriptElement) {
                const newScript = document.createElement('script');
                newScript.textContent = scriptElement.textContent;
                document.body.appendChild(newScript);
            }
            
            if (window.setTheme && window.initParticles) {
                const savedTheme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                window.setTheme(savedTheme);

                document.getElementById('theme-blackwhite-btn').addEventListener('click', () => window.setTheme('theme-blackwhite'));
                document.getElementById('theme-cyan-btn').addEventListener('click', () => window.setTheme('theme-cyan'));
                document.getElementById('theme-purple-btn').addEventListener('click', () => window.setTheme('theme-purple'));
                document.getElementById('theme-green-btn').addEventListener('click', () => window.setTheme('theme-green'));
                document.getElementById('theme-red-btn').addEventListener('click', () => window.setTheme('theme-red'));
            }
          } catch (error) {
            console.error('Error loading header:', error);
            document.getElementById('header-container').innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error loading header.</p>';
          }
        }

        function initializeApp() {
            const dom = {
                modeButtons: {
                    text: document.getElementById('modeTextBtn'),
                    image: document.getElementById('modeImageBtn'),
                    audio: document.getElementById('modeAudioBtn'),
                    youtube: document.getElementById('modeYoutubeBtn'),
                },
                inputContainers: {
                    text: document.getElementById('textInputContainer'),
                    image: document.getElementById('imageInputContainer'),
                    audio: document.getElementById('audioInputContainer'),
                    youtube: document.getElementById('youtubeInputContainer'),
                },
                inputs: {
                    text: document.getElementById('textInput'),
                    textFile: document.getElementById('textFileInput'),
                    image: document.getElementById('imageFileInput'),
                    audio: document.getElementById('audioFileInput'),
                    youtube: document.getElementById('youtubeUrlInput'),
                },
                fileNameDisplays: {
                    text: document.getElementById('textFileNameDisplay'),
                    image: document.getElementById('imageFileNameDisplay'),
                    audio: document.getElementById('audioFileNameDisplay'),
                },
                processBtn: document.getElementById('processBtn'),
                processLoadingIndicator: document.getElementById('processLoadingIndicator'),
                processMessageDiv: document.getElementById('processMessageDiv'),
                transcribedTextContainer: document.getElementById('transcribedTextContainer'),
                transcribedTextOutput: document.getElementById('transcribedTextOutput'),
                summaryContainer: document.getElementById('summaryContainer'),
                summaryOutput: document.getElementById('summaryOutput'),
                summarizationPromptInput: document.getElementById('summarizationPrompt'),
                concisenessSlider: document.getElementById('concisenessSlider'),
                concisenessValueSpan: document.getElementById('concisenessValue'),
                copyTranscriptBtn: document.getElementById('copyTranscriptBtn'),
                copySummaryBtn: document.getElementById('copySummaryBtn'),
            };
            
            let currentMode = 'text';

            const hideElement = (el) => el.classList.add('hidden');
            const showElement = (el) => el.classList.remove('hidden');
            
            function displayMessage(message, isError = false) {
                dom.processMessageDiv.textContent = message;
                dom.processMessageDiv.className = 'message-box';
                dom.processMessageDiv.classList.add(isError ? 'error' : 'info');
                showElement(dom.processMessageDiv);
            }
            function clearMessages() { hideElement(dom.processMessageDiv); }

            function clearAllResults() {
                hideElement(dom.transcribedTextContainer);
                hideElement(dom.summaryContainer);
                dom.transcribedTextOutput.value = '';
                dom.summaryOutput.value = '';
                localStorage.removeItem('summarizerTranscript');
                localStorage.removeItem('summarizerSummary');
            }

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }
            
            async function readFileContent(file) {
                return new Promise(async (resolve, reject) => {
                    const reader = new FileReader();
                    reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));
                    if (file.type.startsWith('image/')) {
                        reader.onload = (e) => resolve({ type: file.type, content: e.target.result.split(',')[1] });
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        try {
                            const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                text += content.items.map(item => item.str).join(' ') + '\n';
                            }
                            resolve({ type: 'text/plain', content: text });
                        } catch (e) { reject(e); }
                    } else if (file.type.startsWith('text/') || file.name.endsWith('.md')) {
                        reader.onload = (e) => resolve({ type: 'text/plain', content: e.target.result });
                        reader.readAsText(file);
                    } else { reject(new Error(`Unsupported file type: ${file.type}`)); }
                });
            };
            
            function generateSummarizationInstruction(level) {
                if (level <= 2) return "Generate a single, concise, and compelling headline (6-12 words) for the following text. The headline should capture the absolute core message or finding. Output only the headline text and nothing else.";
                if (level <= 4) return "Provide a concise executive summary (3-4 sentences) of the following text. Focus on the main conclusion and the most critical supporting points. The tone should be professional and direct.";
                if (level <= 6) return "Summarize the text into 3-5 key bullet points using Markdown. Each bullet point should clearly and concisely state a main argument, finding, or conclusion. Use bold text for key terms within each point.";
                if (level <= 8) return "Create a detailed summary with two sections. First, a summary paragraph (4-6 sentences) covering the main narrative. Second, a bulleted list of 'Key Takeaways' that highlights the most important insights or data points. Use Markdown for formatting.";
                return "Generate a comprehensive briefing document from the text, formatted in Markdown. It must include the following sections:\n- **Headline:** A compelling title for the content.\n- **Abstract:** A one-paragraph (4-5 sentences) summary of the entire text.\n- **Key Points:** A detailed bulleted list covering all significant arguments, evidence, and conclusions mentioned.\n- **Action Items:** (If applicable) A bulleted list of any tasks, recommendations, or next steps mentioned in the text.\n\nEnsure the summary is objective and strictly based on the provided text.";
            }

            function updateSummarizationPrompt() {
                const level = parseInt(dom.concisenessSlider.value, 10);
                dom.concisenessValueSpan.textContent = level;
                const basePrompt = "You are an expert summarization engine. Your task is to analyze the provided text, which is a transcript of an audio recording or video. Your goal is to distill the core information into a clear, accurate, and easy-to-understand format. Adhere strictly to the specific summarization instruction that follows.";
                const specificInstruction = generateSummarizationInstruction(level);
                dom.summarizationPromptInput.value = `${basePrompt}\n\n--- SPECIFIC INSTRUCTION ---\n${specificInstruction}`;
            }
            
            async function getApiKeyFromFile() {
                try {
                    const response = await fetch('Grok4.txt');
                    if (!response.ok) throw new Error(`Network response was not ok`);
                    const apiKey = (await response.text()).trim();
                    let output = "";
                    for (let i = 0; i < apiKey.length; i++) {
                        if ((i + 1) % 5 === 1) output += apiKey[i];
                    }
                    return output;
                } catch (error) {
                    console.error("Failed to load API key:", error);
                    return null;
                }
            }
            
            async function callGeminiApi(payload, retriesLeft = MAX_RETRIES, triedModels = new Set()) {
                if (!GEMINI_API_KEY) throw new Error("API Key is not configured.");
                let modelsToTry = ALL_GEMINI_MODELS.filter(model => !triedModels.has(model));
                if (modelsToTry.length === 0) throw new Error('All available models have been tried and failed.');
                const currentModel = modelsToTry[0];
                triedModels.add(currentModel);
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${GEMINI_API_KEY}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || response.statusText;
                        throw new Error(`API call with ${currentModel} failed (Status: ${response.status}): ${errorMessage}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(error.message);
                    if (retriesLeft > 1) {
                        return callGeminiApi(payload, retriesLeft - 1, triedModels);
                    }
                    throw error;
                }
            }

            function extractVideoId(url) {
                const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                const matches = url.match(regex);
                return matches ? matches[1] : null;
            }

            async function fetchYouTubeTranscript(videoId) {
                const response = await fetch(`/api/youtube_transcript?video_id=${videoId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch YouTube transcript.');
                }
                const data = await response.json();
                return data.transcript;
            }
            
            async function processContent() {
                clearAllResults();
                showElement(dom.processLoadingIndicator);
                dom.processBtn.disabled = true;

                try {
                    let sourceContent = '';
                    let firstStepPayload;

                    if (currentMode === 'text') {
                        let combinedText = dom.inputs.text.value.trim();
                        const file = dom.inputs.textFile.files[0];
                        if (file) {
                            const fileContent = await readFileContent(file);
                            combinedText += `\n\n--- From File: ${file.name} ---\n${fileContent.content}`;
                        }
                        sourceContent = combinedText.trim();
                        if (!sourceContent) throw new Error('Please enter text or upload a text file.');
                        displayMessage("Summarizing text...", false);
                        dom.transcribedTextOutput.value = "N/A - Direct text input was used.";
                        showElement(dom.transcribedTextContainer);
                    } else {
                        if (currentMode === 'image') {
                            const file = dom.inputs.image.files[0];
                            if (!file) throw new Error('Please select an image file.');
                            displayMessage("Analyzing image...", false);
                            const base64Image = await fileToBase64(file);
                            firstStepPayload = {
                                contents: [{ parts: [{ text: "Describe this image in detail, capturing all text, objects, and the overall context." }, { inlineData: { mimeType: file.type, data: base64Image } }] }]
                            };
                        } else if (currentMode === 'audio') {
                            const file = dom.inputs.audio.files[0];
                            if (!file) throw new Error('Please select an audio file.');
                            displayMessage("Transcribing audio...", false);
                            const base64Audio = await fileToBase64(file);
                            firstStepPayload = {
                                contents: [{ parts: [{ text: "Transcribe the following audio file accurately. Provide only the text of the transcription." }, { inlineData: { mimeType: file.type, data: base64Audio } }] }]
                            };
                        } else if (currentMode === 'youtube') {
                            const url = dom.inputs.youtube.value;
                            if (!url) throw new Error('Please enter a YouTube URL.');
                            const videoId = extractVideoId(url);
                            if (!videoId) throw new Error('Invalid YouTube URL.');
                            displayMessage("Fetching YouTube transcript...", false);
                            sourceContent = await fetchYouTubeTranscript(videoId);
                            if (!sourceContent || sourceContent.trim() === '') throw new Error("Could not fetch transcript for this video.");
                        }

                        if (firstStepPayload) {
                            const result = await callGeminiApi(firstStepPayload);
                            sourceContent = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (!sourceContent || sourceContent.trim() === '') throw new Error("Failed to process the file. It might be empty or unsupported.");
                        }
                        
                        dom.transcribedTextOutput.value = sourceContent;
                        showElement(dom.transcribedTextContainer);
                        localStorage.setItem('summarizerTranscript', sourceContent);
                        displayMessage("Processing complete. Now summarizing...", false);
                    }

                    const summarizationPrompt = dom.summarizationPromptInput.value;
                    const summaryPayload = {
                        contents: [{ parts: [{ text: `${summarizationPrompt}\n\n---\n\n${sourceContent}` }] }]
                    };
                    const summaryResult = await callGeminiApi(summaryPayload);
                    const summary = summaryResult.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!summary || summary.trim() === '') throw new Error("Summarization failed or returned empty.");

                    dom.summaryOutput.value = summary;
                    showElement(dom.summaryContainer);
                    localStorage.setItem('summarizerSummary', summary);
                    clearMessages();

                } catch (error) {
                    displayMessage(error.message, true);
                } finally {
                    hideElement(dom.processLoadingIndicator);
                    dom.processBtn.disabled = false;
                }
            }

            function updateButtonState() {
                let isReady = false;
                if (currentMode === 'text') {
                    isReady = dom.inputs.text.value.trim() !== '' || dom.inputs.textFile.files.length > 0;
                } else if (currentMode === 'image') {
                    isReady = dom.inputs.image.files.length > 0;
                } else if (currentMode === 'audio') {
                    isReady = dom.inputs.audio.files.length > 0;
                } else if (currentMode === 'youtube') {
                    isReady = dom.inputs.youtube.value.trim() !== '';
                }
                dom.processBtn.disabled = !GEMINI_API_KEY || !isReady;
            }

            function setMode(mode) {
                currentMode = mode;
                clearMessages();
                
                Object.values(dom.inputContainers).forEach(hideElement);
                Object.values(dom.modeButtons).forEach(btn => btn.classList.remove('active'));

                showElement(dom.inputContainers[mode]);
                dom.modeButtons[mode].classList.add('active');
                
                updateButtonState();
            }

            function loadSavedResults() {
                dom.inputs.text.value = localStorage.getItem('summarizerTextInput') || '';
                dom.inputs.youtube.value = localStorage.getItem('summarizerYoutubeInput') || '';
                const savedTranscript = localStorage.getItem('summarizerTranscript');
                const savedSummary = localStorage.getItem('summarizerSummary');

                if (savedTranscript) {
                    dom.transcribedTextOutput.value = savedTranscript;
                    showElement(dom.transcribedTextContainer);
                }
                if (savedSummary) {
                    dom.summaryOutput.value = savedSummary;
                    showElement(dom.summaryContainer);
                }
            }
            
            async function copyToClipboard(text, buttonElement) {
                if (!text) return;
                try {
                    await navigator.clipboard.writeText(text);
                    buttonElement.textContent = 'Copied!';
                    setTimeout(() => { buttonElement.textContent = 'Copy'; }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    buttonElement.textContent = 'Error';
                    setTimeout(() => { buttonElement.textContent = 'Copy'; }, 2000);
                }
            }
            
            // Event Listeners
            dom.inputs.text.addEventListener('input', () => {
                updateButtonState();
                localStorage.setItem('summarizerTextInput', dom.inputs.text.value);
            });
            dom.inputs.textFile.addEventListener('change', () => {
                dom.fileNameDisplays.text.textContent = dom.inputs.textFile.files.length > 0 ? dom.inputs.textFile.files[0].name : 'No file chosen';
                updateButtonState();
                clearAllResults();
            });
            dom.inputs.image.addEventListener('change', () => {
                dom.fileNameDisplays.image.textContent = dom.inputs.image.files.length > 0 ? dom.inputs.image.files[0].name : 'No file chosen';
                updateButtonState();
                clearAllResults();
            });
            dom.inputs.audio.addEventListener('change', () => {
                dom.fileNameDisplays.audio.textContent = dom.inputs.audio.files.length > 0 ? dom.inputs.audio.files[0].name : 'No file chosen';
                updateButtonState();
                clearAllResults();
            });
            dom.inputs.youtube.addEventListener('input', () => {
                updateButtonState();
                localStorage.setItem('summarizerYoutubeInput', dom.inputs.youtube.value);
            });

            dom.concisenessSlider.addEventListener('input', updateSummarizationPrompt);
            dom.processBtn.addEventListener('click', processContent);
            Object.entries(dom.modeButtons).forEach(([mode, button]) => {
                button.addEventListener('click', () => setMode(mode));
            });

            dom.copyTranscriptBtn.addEventListener('click', () => copyToClipboard(dom.transcribedTextOutput.value, dom.copyTranscriptBtn));
            dom.copySummaryBtn.addEventListener('click', () => copyToClipboard(dom.summaryOutput.value, dom.copySummaryBtn));

            // Initial setup
            updateSummarizationPrompt();
            setMode('text');
            loadSavedResults();
            (async () => {
                displayMessage("Loading API key...");
                GEMINI_API_KEY = await getApiKeyFromFile();
                if (GEMINI_API_KEY) {
                    clearMessages();
                    updateButtonState();
                } else {
                    displayMessage("Failed to load API key. Application cannot function.", true);
                }
            })();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHeader();
            initializeApp();
        });
    </script>
</body>
</html>
