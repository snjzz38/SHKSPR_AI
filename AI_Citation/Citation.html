<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Citation Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        /* --- THEME VARIABLES & GLOBAL STYLES --- */
        :root {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #fff; --card-bg: #222; --link-hover: #ffffff;
            --accent-rgb: 255, 255, 255;
        }
        body.theme-cyan {
            --bg-primary: #000; --bg-secondary: #0b0b0b; --text-primary: #e0ffff;
            --accent: #00f6ff; --card-bg: #072a2c; --accent-rgb: 0, 246, 255;
        }
        body.theme-purple {
            --bg-primary: #0d001a; --bg-secondary: #14002b; --text-primary: #ffe6ff;
            --accent: #cc66ff; --card-bg: #1d0036; --accent-rgb: 204, 102, 255;
        }
        body.theme-green {
            --bg-primary: #001a00; --bg-secondary: #002b00; --text-primary: #e6ffe6;
            --accent: #66ff66; --card-bg: #003600; --accent-rgb: 102, 255, 102;
        }
        body.theme-blackwhite {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #e0e0e0; --card-bg: #222; --accent-rgb: 224, 224, 224;
        }
        body.theme-red {
            --bg-primary: #1a0000; --bg-secondary: #2b0000; --text-primary: #ffe6e6;
            --accent: #ff3333; --card-bg: #360000; --accent-rgb: 255, 51, 51;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.6s, color 0.6s;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- LAYOUT & HERO STYLES --- */
        .main-content { width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        .hero { text-align: center; padding: 50px 20px 30px; position: relative; z-index: 5; }
        .hero h1 { font-size: 3.2rem; text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent); margin-bottom: 20px; }
        .hero p { font-size: 1.2rem; margin: 0 auto 30px; max-width: 600px; }
        .container {
            max-width: 900px; width: 90%; margin: 20px auto 40px auto; padding: 20px;
            background-color: var(--bg-secondary); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;
            gap: 20px; position: relative;
        }
        .container h2 { font-size: 1.5rem; color: var(--text-primary); text-align: center; margin-bottom: 5px; }
        
        /* --- FORM & INPUT STYLES --- */
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; }
        .form-group { flex: 1 1 200px; display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 0.9rem; font-weight: bold; }
        
        textarea, select, input[type="number"] {
            width: 100%; padding: 15px; border: 1px solid var(--accent); border-radius: 8px;
            background-color: var(--card-bg); color: var(--text-primary); font-size: 1rem;
            resize: vertical; min-height: 54px; transition: border-color 0.3s, background-color 0.3s;
        }
        textarea { min-height: 150px; }
        textarea:focus, select:focus, input[type="number"]:focus { outline: none; border-color: var(--text-primary); box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); }
        
        .radio-group {
            display: flex; gap: 15px; background-color: var(--card-bg); border: 1px solid var(--accent);
            padding: 10px 15px; border-radius: 8px; align-items: center; height: 54px;
        }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* --- BUTTON STYLES --- */
        .action-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .generate-button, .secondary-button {
            background-color: var(--accent); color: var(--bg-primary); border: none;
            padding: 12px 25px; border-radius: 25px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(var(--accent-rgb), 0.4);
        }
        .generate-button:hover, .secondary-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(var(--accent-rgb), 0.6); }
        .generate-button:active, .secondary-button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(var(--accent-rgb), 0.3); }
        .generate-button:disabled { background-color: var(--card-bg); color: rgba(var(--accent-rgb), 0.5); cursor: not-allowed; box-shadow: none; }
        
        .secondary-button {
            background-color: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
            box-shadow: none;
        }
        .secondary-button:hover {
            background-color: var(--accent);
            color: var(--bg-primary);
            box-shadow: 0 6px 15px rgba(var(--accent-rgb), 0.6);
        }

        /* --- OUTPUT & STATUS STYLES --- */
        .message-box {
            background-color: rgba(var(--accent-rgb), 0.1); border: 1px solid var(--accent);
            color: var(--text-primary); padding: 15px; border-radius: 8px;
            text-align: center; margin-top: 20px; font-size: 1rem; display: none;
        }
        .loading-bar-container { width: 100%; height: 8px; background-color: var(--card-bg); border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .loading-bar { height: 100%; width: 0%; background-color: var(--accent); border-radius: 4px; transition: width 0.4s ease-in-out; }
        
        #output-section { margin-top: 20px; display: none; }
        #output-area {
            list-style: none;
            padding: 0;
        }
        .citation-item {
            background-color: var(--card-bg);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .citation-item p {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .citation-item a {
            font-size: 0.9rem;
            color: var(--accent);
            text-decoration: none;
            word-break: break-all;
        }
        .citation-item a:hover {
            text-decoration: underline;
        }

        /* --- FOOTER --- */
        footer.main-footer { width: 100%; text-align: center; padding: 20px; font-size: 0.9rem; background-color: var(--bg-secondary); position: relative; z-index: 10; }

        @media (max-width: 768px) {
            .container { width: 95%; padding: 15px; }
            .hero h1 { font-size: 2.2rem; }
            .generate-button, .secondary-button { width: 100%; font-size: 1rem; padding: 10px 20px; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>

    <main class="main-content animate-on-load">
        <section class="hero">
            <h1>AI Citation Generator</h1>
            <p>Paste your essay, and this tool will find sources and generate citations for you.</p>
        </section>

        <div class="container">
            <div class="form-row">
                <div class="form-group" style="flex: 2 1 200px;">
                    <label for="citation-style">Citation Style</label>
                    <select id="citation-style">
                        <option value="apa7">APA 7th Edition</option>
                        <option value="mla9">MLA 9th Edition</option>
                        <option value="chicago">Chicago (Author-Date)</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1 1 150px;">
                    <label for="citation-count">Max Citations</label>
                    <select id="citation-count">
                        <option value="auto">Auto</option>
                        <option value="custom">Custom...</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 2 1 200px;">
                    <label>Output Type</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="output-type" value="bibliography" checked>
                            <span>Bibliography</span>
                        </label>
                        <label>
                            <input type="radio" name="output-type" value="in-text">
                            <span>In-text</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="custom-count-container" style="display: none; margin-top: -10px;">
                <div class="form-group" id="custom-count-group">
                    <label for="custom-citation-count">Custom Number of Citations</label>
                    <input type="number" id="custom-citation-count" min="1" value="3" placeholder="Enter number...">
                </div>
            </div>

            <div class="form-group">
                <label for="essay-input">Paste your essay here</label>
                <textarea id="essay-input" rows="10" placeholder="Paste your text here..."></textarea>
            </div>

            <div class="action-buttons">
                <button id="generate-btn" class="generate-button">Generate Citations</button>
                <button id="example-btn" class="secondary-button">Load Example</button>
            </div>

            <div id="loading-bar-container" class="loading-bar-container">
                <div id="loading-bar" class="loading-bar"></div>
            </div>
            <div id="messageBox" class="message-box"></div>

            <div id="output-section">
                <h2>Bibliography</h2>
                <ul id="output-area"></ul>
                <div class="action-buttons" style="margin-top: 20px;">
                    <button id="copy-btn" class="generate-button">Copy to Clipboard</button>
                    <button id="download-btn" class="secondary-button">Download as .txt</button>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="main-footer">
        <p>&copy; 2025 Shkspr. All rights reserved.</p>
    </footer>

    <script>
        async function loadHeader() {
            try {
                const response = await fetch('../Structure/header.html');
                if (!response.ok) throw new Error('Failed to load header');
                const text = await response.text();
                
                document.getElementById('header-container').innerHTML = text;

                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const scriptElement = doc.querySelector('script');
                if (scriptElement) {
                    const newScript = document.createElement('script');
                    newScript.textContent = scriptElement.textContent;
                    document.body.appendChild(newScript);
                }
                
                if (window.setTheme && window.initParticles) {
                    const savedTheme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                    window.setTheme(savedTheme);

                    document.getElementById('theme-blackwhite-btn').addEventListener('click', () => window.setTheme('theme-blackwhite'));
                    document.getElementById('theme-cyan-btn').addEventListener('click', () => window.setTheme('theme-cyan'));
                    document.getElementById('theme-purple-btn').addEventListener('click', () => window.setTheme('theme-purple'));
                    document.getElementById('theme-green-btn').addEventListener('click', () => window.setTheme('theme-green'));
                    document.getElementById('theme-red-btn').addEventListener('click', () => window.setTheme('theme-red'));
                }
            } catch (error) {
                console.error('Error loading header:', error);
                document.getElementById('header-container').innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error loading header.</p>';
            }
        }

        function initializeCitationApp() {
            const ALL_GEMINI_MODELS = [ 'gemini-1.5-pro-latest', 'gemini-1.5-flash-latest' ];

            const essayInput = document.getElementById('essay-input');
            const citationStyleSelect = document.getElementById('citation-style');
            const citationCountSelect = document.getElementById('citation-count');
            const customCountContainer = document.getElementById('custom-count-container');
            const customCitationCountInput = document.getElementById('custom-citation-count');
            const generateBtn = document.getElementById('generate-btn');
            const exampleBtn = document.getElementById('example-btn');
            const outputSection = document.getElementById('output-section');
            const outputArea = document.getElementById('output-area');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            const loadingBarContainer = document.getElementById('loading-bar-container');
            const loadingBar = document.getElementById('loading-bar');
            const messageBox = document.getElementById('messageBox');
            const outputHeading = outputSection.querySelector('h2');

            const citationFormatter = {
                apa7: (source) => {
                    const author = source.author || 'N.A.';
                    const year = source.year || 'n.d.';
                    const title = source.title || 'Untitled';
                    const journal = source.journal ? `<em>${source.journal}</em>` : '';
                    const publisher = source.publisher || '';
                    return `${author}. (${year}). ${title}. ${journal ? journal + '.' : ''} ${publisher ? publisher + '.' : ''}`;
                },
                mla9: (source) => {
                    const author = source.author || 'N.A.';
                    const title = source.title ? `"${source.title}."` : 'Untitled.';
                    const journal = source.journal ? `<em>${source.journal}</em>,` : '';
                    const publisher = source.publisher ? `${source.publisher},` : '';
                    const year = source.year || 'n.d.';
                    return `${author}. ${title} ${journal} ${publisher} ${year}.`;
                },
                chicago: (source) => {
                    const author = source.author || 'N.A.';
                    const year = source.year || 'n.d.';
                    const title = source.title ? `"${source.title}."` : 'Untitled.';
                    const journal = source.journal ? `<em>${source.journal}</em>` : '';
                    return `${author}. ${year}. ${title} ${journal}.`;
                }
            };

            const sortCitations = (citations, style) => {
                if (style === 'apa7' || style === 'mla9' || style === 'chicago') {
                    return citations.sort((a, b) => {
                        const authorA = (a.author || 'Z').toLowerCase();
                        const authorB = (b.author || 'Z').toLowerCase();
                        return authorA.localeCompare(authorB);
                    });
                }
                return citations; // Default: return in order of appearance
            };

            const saveState = () => {
                const state = {
                    essay: essayInput.value,
                    style: citationStyleSelect.value,
                    count: citationCountSelect.value,
                    customCount: customCitationCountInput.value,
                    outputType: document.querySelector('input[name="output-type"]:checked').value,
                    citations: JSON.parse(localStorage.getItem('citationOutput')) || null
                };
                localStorage.setItem('citationState', JSON.stringify(state));
            };

            const loadState = () => {
                const state = JSON.parse(localStorage.getItem('citationState'));
                if (!state) return;

                essayInput.value = state.essay || '';
                citationStyleSelect.value = state.style || 'apa7';
                citationCountSelect.value = state.count || 'auto';
                customCitationCountInput.value = state.customCount || '3';
                document.querySelector(`input[name="output-type"][value="${state.outputType || 'bibliography'}"]`).checked = true;

                if (state.count === 'custom') {
                    customCountContainer.style.display = 'block';
                }

                if (state.citations) {
                    renderCitations(state.citations, state.style, state.outputType);
                }
            };

            const clearState = () => {
                localStorage.removeItem('citationState');
                localStorage.removeItem('citationOutput');
                essayInput.value = '';
                citationStyleSelect.value = 'apa7';
                citationCountSelect.value = 'auto';
                customCitationCountInput.value = '3';
                document.querySelector('input[name="output-type"][value="bibliography"]').checked = true;
                outputSection.style.display = 'none';
                messageBox.style.display = 'none';
                customCountContainer.style.display = 'none';
            };

            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.style.borderColor = type === 'error' ? '#ff3333' : 'var(--accent)';
                messageBox.style.display = 'block';
            }

            function startLoadingBar() {
                loadingBarContainer.style.display = 'block';
                loadingBar.style.width = '0%';
                setTimeout(() => { loadingBar.style.width = '90%'; }, 100);
            }

            function stopLoadingBar(success = true) {
                loadingBar.style.width = '100%';
                if (!success) loadingBar.style.backgroundColor = '#ff3333';
                setTimeout(() => {
                    loadingBarContainer.style.display = 'none';
                    loadingBar.style.backgroundColor = 'var(--accent)';
                }, 500);
            }

            async function callApiWithRetries(payload) {
                let modelsToTry = shuffleArray([...ALL_GEMINI_MODELS]);
                let lastError = null;

                for (const model of modelsToTry) {
                    try {
                        const response = await fetch('/api/citation', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model, ...payload })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.details || errorData.error || `Server error with model ${model}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.warn(`Error with model ${model}:`, error.message);
                        lastError = error;
                    }
                }
                throw lastError || new Error("All AI models failed.");
            }

            function renderCitations(citations, style, outputType) {
                outputArea.innerHTML = '';
                outputHeading.textContent = (outputType === 'in-text') ? 'In-Text Citations' : 'Bibliography';
                
                const validCitations = citations.filter(c => c.title && c.url);
                if (validCitations.length === 0) {
                    showMessage('No valid citable claims were found in the provided text.');
                    return;
                }

                const sortedCitations = sortCitations(validCitations, style);
                const formatter = citationFormatter[style] || citationFormatter.apa7;

                sortedCitations.forEach(source => {
                    const listItem = document.createElement('li');
                    listItem.className = 'citation-item';
                    
                    const citationText = document.createElement('p');
                    citationText.innerHTML = (outputType === 'in-text') 
                        ? `(${source.author || 'N.A.'}, ${source.year || 'n.d.'})`
                        : formatter(source);
                    
                    const citationLink = document.createElement('a');
                    citationLink.href = source.url;
                    citationLink.textContent = source.title || 'View Source';
                    citationLink.target = '_blank';
                    
                    listItem.appendChild(citationText);
                    listItem.appendChild(citationLink);
                    outputArea.appendChild(listItem);
                });
                outputSection.style.display = 'block';
                showMessage('Citations generated successfully!');
            }

            async function processAndGenerate(essayText, citationStyle, outputType, citationCount) {
                try {
                    const countInstruction = (citationCount === 'auto')
                        ? `Extract the most important and citable topics or key phrases from the text.`
                        : `Extract the ${citationCount} most important and citable topics or key phrases from the text.`;

                    const prompt = `Analyze the following text. ${countInstruction} Return them as a simple JSON array of strings. For example: ["Intergovernmental Panel on Climate Change reports", "rising global temperatures effects", "Paris Agreement goals"]. Text: "${essayText}"`;
                    
                    const contents = [{ role: 'user', parts: [{ text: prompt }] }];
                    const result = await callApiWithRetries({ contents });
                    
                    localStorage.setItem('citationOutput', JSON.stringify(result.citations));
                    renderCitations(result.citations, citationStyle, outputType);
                    
                    stopLoadingBar(true);
                } catch (error) {
                    console.error('An error occurred:', error);
                    showMessage(`Error: ${error.message}`, 'error');
                    stopLoadingBar(false);
                } finally {
                    generateBtn.disabled = false;
                }
            }

            citationCountSelect.addEventListener('change', () => {
                customCountContainer.style.display = (citationCountSelect.value === 'custom') ? 'block' : 'none';
                saveState();
            });

            generateBtn.addEventListener('click', () => {
                const essayText = essayInput.value.trim();
                if (!essayText) {
                    showMessage('Please paste an essay into the input area.', 'error');
                    return;
                }
                const citationStyle = citationStyleSelect.value;
                const outputType = document.querySelector('input[name="output-type"]:checked').value;
                let citationCount = citationCountSelect.value;
                if (citationCount === 'custom') {
                    citationCount = customCitationCountInput.value || 1;
                }
                
                outputSection.style.display = 'none';
                messageBox.style.display = 'none';
                generateBtn.disabled = true;
                startLoadingBar();
                saveState(); // Save inputs before generating

                processAndGenerate(essayText, citationStyle, outputType, citationCount);
            });

            exampleBtn.addEventListener('click', () => {
                essayInput.value = `Climate change is largely driven by anthropogenic activities, particularly the emission of greenhouse gases from industrial processes, transportation, and deforestation. The Intergovernmental Panel on Climate Change (IPCC) reports that global COâ‚‚ levels have reached their highest concentration in over 800,000 years. Rising global temperatures have led to more frequent and intense heatwaves, droughts, and extreme weather events like hurricanes and floods.`;
            });

            copyBtn.addEventListener('click', () => {
                const citations = Array.from(outputArea.querySelectorAll('.citation-item p'));
                const textToCopy = citations.map(p => p.textContent).join('\n\n');
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showMessage('Citations copied to clipboard!');
                }).catch(err => {
                    showMessage('Failed to copy text.', 'error');
                });
            });

            downloadBtn.addEventListener('click', () => {
                const citations = Array.from(outputArea.querySelectorAll('.citation-item p'));
                const outputText = citations.map(p => p.textContent).join('\n\n');
                if (!outputText) {
                    showMessage('Nothing to download.', 'error');
                    return;
                }
                const blob = new Blob([outputText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'citations.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // Add event listeners for auto-saving
            essayInput.addEventListener('input', saveState);
            citationStyleSelect.addEventListener('change', saveState);
            citationCountSelect.addEventListener('change', saveState);
            customCitationCountInput.addEventListener('input', saveState);
            document.querySelectorAll('input[name="output-type"]').forEach(radio => {
                radio.addEventListener('change', saveState);
            });
            document.getElementById('clear-btn').addEventListener('click', clearState); // Assuming you have a clear button

        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHeader();
            initializeCitationApp();
        });
    </script>
</body>
</html>
