<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Study Guide Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- For rendering Markdown -->
    <style>
        /* --- CRITICAL STYLES FOR FOUC PREVENTION --- */
        :root {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #fff; --card-bg: #222; --link-hover: #ffffff;
            --accent-rgb: 255, 255, 255;
            --destructive-bg: #7f1d1d; --destructive-text: #fecaca; --destructive-glow-rgb: 239, 68, 68;
        }
        body.theme-cyan {
            --bg-primary: #000; --bg-secondary: #0b0b0b; --text-primary: #e0ffff;
            --accent: #00f6ff; --card-bg: #072a2c; --accent-rgb: 0, 246, 255;
        }
        body.theme-purple {
            --bg-primary: #0d001a; --bg-secondary: #14002b; --text-primary: #ffe6ff;
            --accent: #cc66ff; --card-bg: #1d0036; --accent-rgb: 204, 102, 255;
        }
        body.theme-green {
            --bg-primary: #001a00; --bg-secondary: #002b00; --text-primary: #e6ffe6;
            --accent: #66ff66; --card-bg: #003600; --accent-rgb: 102, 255, 102;
        }
        body.theme-blackwhite {
            --bg-primary: #000; --bg-secondary: #111; --text-primary: #fff;
            --accent: #e0e0e0; --card-bg: #222; --accent-rgb: 224, 224, 224;
        }
        body.theme-red {
            --bg-primary: #1a0000; --bg-secondary: #2b0000; --text-primary: #ffe6e6;
            --accent: #ff3333; --card-bg: #360000; --accent-rgb: 255, 51, 51;
            --destructive-bg: #991b1b; --destructive-text: #fca5a5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.6s, color 0.6s;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Page-Specific Styles --- */
        .main-content { width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        .hero { text-align: center; padding: 50px 20px 30px; position: relative; z-index: 5; }
        .hero h1 { font-size: 3.2rem; text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent), 0 0 40px var(--accent), 0 0 50px var(--accent), 0 0 60px var(--accent); margin-bottom: 20px; }
        .hero p { font-size: 1.2rem; margin: 0 auto 30px; text-shadow: 0 0 8px var(--accent); max-width: 600px; }
        .container {
            max-width: 900px; width: 90%; margin: 20px auto 40px auto; padding: 20px;
            background-color: var(--bg-secondary); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;
            gap: 20px; position: relative;
        }
        .container h2 { font-size: 1.5rem; color: var(--text-primary); text-align: center; margin-bottom: 5px; }
        .input-step-container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        .input-step { width: 100%; display: none; flex-direction: column; gap: 10px; }
        .input-step.active { display: flex; }
        .input-step p.subtitle { font-size: 0.9rem; color: rgba(var(--accent-rgb), 0.7); text-align: center; margin-bottom: 15px; }
        textarea {
            width: 100%; padding: 15px; border: 1px solid var(--accent); border-radius: 8px;
            background-color: var(--card-bg); color: var(--text-primary); font-size: 1rem;
            resize: vertical; min-height: 150px; transition: border-color 0.3s, background-color 0.3s;
        }
        textarea:focus { outline: none; border-color: var(--text-primary); box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); }
        .file-upload-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; align-items: center; }
        .file-input-wrapper { position: relative; display: flex; align-items: center; gap: 10px; width: 100%; max-width: 400px; }
        .file-input-label {
            background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent);
            padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s; white-space: nowrap; z-index: 1;
        }
        .file-input-label:hover { background: var(--accent); color: var(--bg-primary); }
        #fileInput { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 2; }
        .file-name-display {
            flex-grow: 1; padding: 8px 10px; border: 1px solid var(--card-bg); border-radius: 8px;
            background-color: var(--bg-primary); color: rgba(var(--accent-rgb), 0.8); font-size: 0.9rem;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .file-clear-button { background: none; border: none; color: var(--accent); font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-clear-button:hover { color: var(--text-primary); }
        .file-list-container { width: 100%; max-width: 400px; margin-top: 15px; }
        .file-list-toggle-button {
            background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--accent);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s; margin-bottom: 10px; width: 100%;
        }
        .file-list-toggle-button:hover { background: var(--accent); color: var(--bg-primary); }
        .file-list {
            list-style: none; padding: 0; max-height: 0; overflow: hidden;
            transition: max-height 0.5s ease-in-out; border: 1px solid var(--card-bg);
            border-radius: 8px; background-color: var(--bg-primary);
        }
        .file-list.expanded { max-height: 200px; overflow-y: auto; padding: 10px; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid rgba(var(--accent-rgb), 0.2); font-size: 0.9rem; }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item span { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-list-item button { background: none; border: none; color: #ff6666; font-size: 1.2rem; cursor: pointer; transition: color 0.3s; }
        .file-list-item button:hover { color: #ff0000; }
        .input-navigation-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        .action-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .generate-button, .clear-button, .nav-button, .start-quiz-button, .exit-quiz-button, .copy-button {
            background-color: var(--accent); color: var(--bg-primary); border: none;
            padding: 12px 25px; border-radius: 25px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(var(--accent-rgb), 0.4);
        }
        .generate-button:hover, .clear-button:hover, .nav-button:hover:not(:disabled), .start-quiz-button:hover, .exit-quiz-button:hover, .copy-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(var(--accent-rgb), 0.6); }
        .generate-button:active, .clear-button:active, .nav-button:active:not(:disabled), .start-quiz-button:active, .exit-quiz-button:active, .copy-button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(var(--accent-rgb), 0.3); }
        .nav-button:disabled { background-color: var(--card-bg); color: rgba(var(--accent-rgb), 0.5); cursor: not-allowed; box-shadow: none; }
        .exit-quiz-button {
            background-color: var(--accent); color: var(--bg-primary);
            width: 100%; margin-top: 1rem;
            box-shadow: 0 4px 15px rgba(var(--destructive-glow-rgb), 0.4);
        }
        .exit-quiz-button:hover { box-shadow: 0 6px 20px rgba(var(--destructive-glow-rgb), 0.6); }
        .study-guide-area, .interactive-quiz-container { margin-top: 30px; text-align: left; width: 100%; }
        
        /* --- NEW: Styles for the study guide header --- */
        .study-guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .study-guide-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        .copy-button.small {
            padding: 6px 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .study-guide-content { 
            padding: 1rem; 
            border: 1px solid var(--accent); 
            border-radius: 8px; 
            background-color: var(--card-bg); 
            overflow-wrap: break-word;
        }
        
        .study-guide-content h1, .study-guide-content h2, .study-guide-content h3 { 
            color: var(--accent); 
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .study-guide-content p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .study-guide-content ul, .study-guide-content ol { 
            list-style-position: inside; 
            padding-left: 1rem; 
            margin-bottom: 1rem;
        }
        .study-guide-content li {
            margin-bottom: 0.5rem;
        }
        .study-guide-content li:last-child {
            margin-bottom: 0;
        }

        .quiz-question {
            background-color: var(--card-bg);
            border: 1px solid var(--accent);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .quiz-question h3 { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 10px; }
        .quiz-question p { margin-bottom: 0.5rem; }
        .quiz-navigation { display: flex; justify-content: space-between; margin-top: 2rem; }
        .quiz-options-container { display: flex; flex-direction: column; gap: 10px; margin-top: 1rem; }
        .quiz-option-btn {
            background-color: var(--card-bg); border: 1px solid var(--accent); color: var(--text-primary);
            padding: 10px 15px; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s;
        }
        .quiz-option-btn:hover { background-color: rgba(var(--accent-rgb), 0.2); }
        .quiz-option-btn.selected { background-color: var(--accent); color: var(--bg-primary); font-weight: bold; }
        .quiz-results { text-align: left; }
        .quiz-results h2 { font-size: 1.8rem; color: var(--accent); text-align: center; margin-bottom: 1.5rem; }
        .result-item { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--card-bg); }
        .result-item p { 
            margin-bottom: 0.5rem; 
            overflow-wrap: break-word;
        }
        .result-item.correct { border-left: 4px solid #4ade80; padding-left: 10px; }
        .result-item.incorrect { border-left: 4px solid #f87171; padding-left: 10px; }
        .start-quiz-area { text-align: center; }
        .message-box {
            padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem;
            text-align: left; border: 1px solid;
        }
        .message-box.info {
            background-color: rgba(var(--accent-rgb), 0.1);
            border-color: var(--accent);
            color: var(--text-primary);
        }
        .message-box.error {
            --error-rgb: 239, 68, 68;
            background-color: rgba(var(--error-rgb), 0.1);
            border-color: rgb(var(--error-rgb));
            color: #fecaca;
        }
        .loading-bar-container { width: 100%; height: 8px; background-color: var(--card-bg); border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .loading-bar { height: 100%; width: 0%; background-color: var(--accent); border-radius: 4px; transition: width 0.4s ease-in-out; }
        .hidden { display: none; }
        footer.main-footer {
            width: 100%; text-align: center; padding: 20px; font-size: 0.9rem;
            background-color: var(--bg-secondary); position: relative; z-index: 10;
        }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 20px auto; padding: 15px; }
            .hero h1 { font-size: 2.2rem; }
            .generate-button, .clear-button, .nav-button, .start-quiz-button, .exit-quiz-button, .copy-button { width: 100%; font-size: 1rem; padding: 10px 20px; }
            .action-buttons, .input-navigation-buttons, .quiz-navigation { flex-direction: column; }
        }
    </style>
    <script>
        (function() {
            try {
                const theme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
                document.documentElement.className = theme;
            } catch (e) {}
        })();
    </script>
</head>
<body>
  <div id="header-container"></div>

  <main class="main-content animate-on-load">
    <section class="hero">
        <h1>AI Study Guide Generator</h1>
        <p>Transform your notes, documents, or images into a structured study guide with an interactive quiz.</p>
    </section>

    <div id="generatorContainer" class="container">
        <div class="input-step-container">
            <div id="inputStep1" class="input-step active">
                <h2>Step 1: Upload Material</h2>
                <p class="subtitle">Provide the content to be turned into a study guide.</p>
                <textarea id="inputText" placeholder="Enter text here... or paste an image (Ctrl+V)"></textarea>
                <div class="file-upload-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".txt,.md,.pdf,image/*" multiple>
                        <label for="fileInput" class="file-input-label">Upload Files</label>
                        <span id="fileNameDisplay" class="file-name-display">No files chosen</span>
                        <button id="clearFileButton" class="file-clear-button" style="display:none;">&times;</button>
                    </div>
                    <p class="subtitle">Supported: .txt, .md, images. PDFs extract text only.</p>
                    <div class="file-list-container">
                        <button id="toggleFileListButton" class="file-list-toggle-button" style="display:none;">Show Uploaded Files (0)</button>
                        <ul id="fileList" class="file-list"></ul>
                    </div>
                </div>
            </div>

            <div id="inputStep2" class="input-step">
                <h2>Step 2: Custom Instructions (Optional)</h2>
                <p class="subtitle">Guide the AI on how to create your study guide and quiz.</p>
                <textarea id="customInstructions" placeholder="e.g., 'Focus on the key historical dates.', 'Create a 10-question multiple-choice quiz.'"></textarea>
            </div>

            <div class="input-navigation-buttons">
                <button id="inputPrevButton" class="nav-button" disabled>Back</button>
                <button id="inputNextButton" class="nav-button">Next</button>
            </div>
        </div>

        <div class="action-buttons">
          <button id="generateButton" class="generate-button">Generate Study Guide</button>
          <button id="clearButton" class="clear-button">Clear All</button>
        </div>
        <div id="loadingBarContainer" class="loading-bar-container">
            <div id="loadingBar" class="loading-bar"></div>
        </div>
        <div id="messageBox" class="message-box"></div>
        <div id="studyGuideArea" class="study-guide-area hidden">
            <!-- NEW: Header for the study guide with a copy button -->
            <div class="study-guide-header">
                <h2>Your Study Guide</h2>
                <button id="copyGuideButton" class="copy-button small">Copy Guide</button>
            </div>
            <div id="studyGuideContent" class="study-guide-content"></div>
        </div>
        <div id="startQuizArea" class="start-quiz-area hidden mt-4">
            <button id="startQuizButton" class="start-quiz-button">Quiz Me!</button>
        </div>
    </div>

    <div id="interactiveQuizContainer" class="container hidden">
        <!-- Interactive quiz content will be rendered here -->
    </div>
  </main>
  
  <footer class="main-footer">
      <p>&copy; 2025 Shkspr. All rights reserved.</p>
  </footer>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

async function loadHeader() {
  try {
    const response = await fetch('../Structure/header.html');
    if (!response.ok) throw new Error('Failed to load header');
    const text = await response.text();
    
    document.getElementById('header-container').innerHTML = text;

    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    const scriptElement = doc.querySelector('script');
    if (scriptElement) {
        const newScript = document.createElement('script');
        newScript.textContent = scriptElement.textContent;
        document.body.appendChild(newScript);
    }
    
    if (window.setTheme && window.initParticles) {
        const savedTheme = localStorage.getItem('shkspr-theme') || 'theme-blackwhite';
        window.setTheme(savedTheme);

        document.getElementById('theme-blackwhite-btn').addEventListener('click', () => window.setTheme('theme-blackwhite'));
        document.getElementById('theme-cyan-btn').addEventListener('click', () => window.setTheme('theme-cyan'));
        document.getElementById('theme-purple-btn').addEventListener('click', () => window.setTheme('theme-purple'));
        document.getElementById('theme-green-btn').addEventListener('click', () => window.setTheme('theme-green'));
        document.getElementById('theme-red-btn').addEventListener('click', () => window.setTheme('theme-red'));
    }
  } catch (error) {
    console.error('Error loading header:', error);
    document.getElementById('header-container').innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error loading header. Make sure ../Structure/header.html exists.</p>';
  }
}

function initializeStudyGuideApp() {
    const ALL_GEMINI_MODELS = [
      'gemini-2.5-flash-lite',
      'gemini-2.5-flash',
      'gemini-2.0-flash',
      'gemini-2.0-flash-lite',
      'gemini-1.5-flash',
      'gemini-1.5-flash-8b',
    ];
    
    const dom = {
        generatorContainer: document.getElementById('generatorContainer'),
        interactiveQuizContainer: document.getElementById('interactiveQuizContainer'),
        startQuizArea: document.getElementById('startQuizArea'),
        startQuizButton: document.getElementById('startQuizButton'),
        studyGuideArea: document.getElementById('studyGuideArea'),
        studyGuideContent: document.getElementById('studyGuideContent'),
        inputText: document.getElementById('inputText'),
        customInstructions: document.getElementById('customInstructions'),
        generateButton: document.getElementById('generateButton'),
        clearButton: document.getElementById('clearButton'),
        messageBox: document.getElementById('messageBox'),
        loadingBarContainer: document.getElementById('loadingBarContainer'),
        loadingBar: document.getElementById('loadingBar'),
        inputSteps: [document.getElementById('inputStep1'), document.getElementById('inputStep2')],
        inputPrevButton: document.getElementById('inputPrevButton'),
        inputNextButton: document.getElementById('inputNextButton'),
        fileInput: document.getElementById('fileInput'),
        fileNameDisplay: document.getElementById('fileNameDisplay'),
        clearFileButton: document.getElementById('clearFileButton'),
        fileList: document.getElementById('fileList'),
        toggleFileListButton: document.getElementById('toggleFileListButton'),
        // --- NEW: Add copy button to DOM object ---
        copyGuideButton: document.getElementById('copyGuideButton'),
    };

    let uploadedFilesData = [];
    let quizData = [];
    let userAnswers = [];
    let currentQuestionIndex = 0;
    let currentInputStepIndex = 0;
    let studyGuideMarkdown = '';

    const saveState = () => {
        localStorage.setItem('studyGuideInput', dom.inputText.value);
        localStorage.setItem('studyGuideInstructions', dom.customInstructions.value);
        if (quizData && quizData.length > 0) {
            localStorage.setItem('studyGuideMarkdown', studyGuideMarkdown);
            localStorage.setItem('studyGuideQuizData', JSON.stringify(quizData));
        } else {
            localStorage.removeItem('studyGuideMarkdown');
            localStorage.removeItem('studyGuideQuizData');
        }
    };

    const loadState = () => {
        const savedInput = localStorage.getItem('studyGuideInput');
        const savedInstructions = localStorage.getItem('studyGuideInstructions');
        const savedMarkdown = localStorage.getItem('studyGuideMarkdown');
        const savedQuizData = localStorage.getItem('studyGuideQuizData');

        if (savedInput) dom.inputText.value = savedInput;
        if (savedInstructions) dom.customInstructions.value = savedInstructions;

        if (savedMarkdown !== null && savedQuizData) {
            try {
                quizData = JSON.parse(savedQuizData);
                studyGuideMarkdown = savedMarkdown;
                if (Array.isArray(quizData) && quizData.length > 0) {
                    if (studyGuideMarkdown && studyGuideMarkdown.trim() !== '') {
                        dom.studyGuideContent.innerHTML = marked.parse(studyGuideMarkdown);
                    } else {
                        dom.studyGuideContent.innerHTML = `<p>A study guide could not be generated from the previous content, but a quiz is available.</p>`;
                    }
                    dom.studyGuideArea.classList.remove('hidden');
                    dom.startQuizArea.classList.remove('hidden');
                }
            } catch (e) {
                console.error("Failed to parse saved data:", e);
                quizData = [];
                studyGuideMarkdown = '';
            }
        }
    };

    const clearState = () => {
        dom.inputText.value = '';
        dom.customInstructions.value = '';
        uploadedFilesData = [];
        quizData = [];
        userAnswers = [];
        studyGuideMarkdown = '';
        
        localStorage.removeItem('studyGuideInput');
        localStorage.removeItem('studyGuideInstructions');
        localStorage.removeItem('studyGuideMarkdown');
        localStorage.removeItem('studyGuideQuizData');

        dom.studyGuideContent.innerHTML = '';
        dom.studyGuideArea.classList.add('hidden');
        dom.startQuizArea.classList.add('hidden');
        
        dom.interactiveQuizContainer.innerHTML = '';
        dom.interactiveQuizContainer.classList.add('hidden');
        dom.generatorContainer.classList.remove('hidden');
        
        updateFileListDisplay();
        showInputStep(0);
        showMessage('All content cleared.');
    };

    const shuffleArray = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    };

    const showMessage = (message, type = 'info') => {
        dom.messageBox.textContent = message;
        dom.messageBox.className = `message-box ${type}`;
        dom.messageBox.style.display = 'block';
        setTimeout(() => { dom.messageBox.style.display = 'none'; }, 5000);
    };

    const showInputStep = (index) => {
        dom.inputSteps.forEach((step, i) => step.classList.toggle('active', i === index));
        currentInputStepIndex = index;
        dom.inputPrevButton.disabled = currentInputStepIndex === 0;
        dom.inputNextButton.disabled = currentInputStepIndex === dom.inputSteps.length - 1;
        dom.generateButton.style.display = (currentInputStepIndex === dom.inputSteps.length - 1) ? 'block' : 'none';
    };

    const readFileContent = async (file) => {
        return new Promise(async (resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));
            if (file.type.startsWith('image/')) {
                reader.onload = (e) => resolve({ type: file.type, content: e.target.result.split(',')[1] });
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                try {
                    const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n';
                    }
                    resolve({ type: 'text/plain', content: text });
                } catch (e) { reject(e); }
            } else if (file.type.startsWith('text/')) {
                reader.onload = (e) => resolve({ type: 'text/plain', content: e.target.result });
                reader.readAsText(file);
            } else { reject(new Error(`Unsupported file type: ${file.type}`)); }
        });
    };

    const updateFileListDisplay = () => {
        dom.fileList.innerHTML = '';
        const hasFiles = uploadedFilesData.length > 0;
        dom.toggleFileListButton.style.display = hasFiles ? 'block' : 'none';
        dom.fileNameDisplay.textContent = hasFiles ? `${uploadedFilesData.length} file(s) chosen` : 'No files chosen';
        dom.clearFileButton.style.display = hasFiles ? 'inline-block' : 'none';
        dom.toggleFileListButton.textContent = `Show Uploaded Files (${uploadedFilesData.length})`;
        if (!hasFiles) dom.fileList.classList.remove('expanded');

        uploadedFilesData.forEach(file => {
            const li = document.createElement('li');
            li.className = 'file-list-item';
            li.innerHTML = `<span>${file.name}</span><button data-id="${file.id}">&times;</button>`;
            dom.fileList.appendChild(li);
        });
    };
    
    const callApiWithRetries = async (payload) => {
        let modelsToTry = shuffleArray([...ALL_GEMINI_MODELS]);
        let lastError = null;

        for (const model of modelsToTry) {
            console.log(`Attempting API call with model: ${model}`);
            try {
                const response = await fetch('/api/Study_Guide_API', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...payload, model })
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error || `Server error (${response.status}) with model ${model}`);
                }

                const result = await response.json();
                
                if (result.studyGuide !== null && result.quizQuestions) {
                    return result;
                }
                
                lastError = new Error(`Model ${model} returned an unexpected structure.`);
            } catch (error) {
                console.warn(`Error with model ${model}:`, error.message);
                lastError = error;
            }
        }
        throw lastError || new Error("All API models failed to return a valid response.");
    };

    const generateStudyGuide = async () => {
        const text = dom.inputText.value.trim();
        const instructions = dom.customInstructions.value.trim();
        if ((!text || text.length < 50) && uploadedFilesData.length === 0) {
            showMessage('Please provide at least 50 characters of text or upload a file.', 'error');
            return;
        }
        quizData = [];
        dom.studyGuideArea.classList.add('hidden');
        dom.startQuizArea.classList.add('hidden');
        dom.loadingBarContainer.style.display = 'block';
        dom.loadingBar.style.width = '0%';
        
        showMessage('Generating study guide... This may take a moment.', 'info');
        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 90) { progress += 5; dom.loadingBar.style.width = `${progress}%`; }
        }, 200);

        try {
            let promptParts = [];
            const basePrompt = "You are an expert tutor and quiz designer. Your task is to perform two actions: First, create a well-structured study guide from the provided material using Markdown. It should include sections like 'Key Concepts', 'Important Definitions', and 'Core Principles'. Second, based ONLY on the study guide you just generated, create a quiz.";
            
            promptParts.push({ text: basePrompt });
            if (text) promptParts.push({ text: `\n\nHere is the source text:\n"${text}"` });
            
            uploadedFilesData.forEach(file => {
                if (file.type.startsWith('image/')) {
                    promptParts.push({ text: `\n\nAnalyze the following image (${file.name}):` }, { inlineData: { mimeType: file.type, data: file.content } });
                } else {
                    promptParts.push({ text: `\n\nAnalyze the following text from the file (${file.name}):\n"${file.content}"` });
                }
            });
            
            const instructionPrompt = `\n\n${instructions ? `Follow these specific instructions for both the guide and the quiz: "${instructions}".` : ''} The final output MUST be a single JSON object with two keys: "studyGuide" (containing the Markdown text of the guide) and "quizQuestions" (containing a JSON array of quiz objects). Each quiz object must have 'question', 'answer', 'type' ('multiple_choice', 'true_false', or 'short_answer'), and an 'options' array for multiple_choice. For 'short_answer', the 'answer' is CRITICAL for automated grading. It MUST be a comma-separated string of keywords. Be flexible and forgiving: include technical terms, synonyms, and simple descriptive words. For example, for a question about "data redundancy", a good answer string would be "Unnecessary repetition,redundant,repetitive". This ensures a user who answers "it's repetitive" is graded correctly. For answers that are a list of items (e.g., "a and e"), provide only the core items separated by a comma (e.g., "a,e").`;
            promptParts.push({ text: instructionPrompt });
            
            const result = await callApiWithRetries({ contents: [{ role: "user", parts: promptParts }] });
            
            quizData = result.quizQuestions;
            studyGuideMarkdown = result.studyGuide;

            if (studyGuideMarkdown && studyGuideMarkdown.trim() !== '') {
                dom.studyGuideContent.innerHTML = marked.parse(studyGuideMarkdown);
            } else {
                dom.studyGuideContent.innerHTML = `<p>A study guide could not be generated from the provided content, but a quiz is available.</p>`;
            }

            dom.studyGuideArea.classList.remove('hidden');
            dom.startQuizArea.classList.remove('hidden');
            showMessage(`Study guide and quiz generated successfully!`, 'info');
            
            saveState();

        } catch (error) {
            console.error('Error:', error);
            showMessage(`Failed to generate content: ${error.message}`, 'error');
        } finally {
            clearInterval(interval);
            dom.loadingBar.style.width = '100%';
            setTimeout(() => { dom.loadingBarContainer.style.display = 'none'; dom.loadingBar.style.width = '0%'; }, 500);
        }
    };

    const startQuiz = () => {
        userAnswers = new Array(quizData.length).fill(null);
        currentQuestionIndex = 0;
        dom.generatorContainer.classList.add('hidden');
        dom.interactiveQuizContainer.classList.remove('hidden');
        renderInteractiveQuestion(currentQuestionIndex);
    };

    const exitQuiz = () => {
        dom.interactiveQuizContainer.classList.add('hidden');
        dom.interactiveQuizContainer.innerHTML = '';
        dom.generatorContainer.classList.remove('hidden');
    };

    const renderInteractiveQuestion = (index) => {
        dom.interactiveQuizContainer.innerHTML = '';
        const questionData = quizData[index];

        const questionDisplay = document.createElement('div');
        questionDisplay.className = 'quiz-question-display';
        questionDisplay.innerHTML = `<h3>Question ${index + 1} of ${quizData.length}</h3><p>${questionData.question}</p>`;
        
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'quiz-options-container';

        let options = [];
        if (questionData.type === 'true_false') {
            options = ['True', 'False'];
        } else if (questionData.type === 'multiple_choice' && questionData.options) {
            options = questionData.options;
        }

        if (options.length > 0) {
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option-btn';
                btn.textContent = option;
                if (userAnswers[index] === option) btn.classList.add('selected');
                btn.addEventListener('click', () => {
                    userAnswers[index] = option;
                    optionsContainer.querySelectorAll('.quiz-option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
                optionsContainer.appendChild(btn);
            });
        } else if (questionData.type === 'short_answer') {
            const textarea = document.createElement('textarea');
            textarea.placeholder = "Type your answer here...";
            textarea.value = userAnswers[index] || '';
            textarea.addEventListener('input', () => { userAnswers[index] = textarea.value; });
            optionsContainer.appendChild(textarea);
        }

        const navigation = document.createElement('div');
        navigation.className = 'quiz-navigation';
        const prevBtn = document.createElement('button');
        prevBtn.className = 'nav-button';
        prevBtn.textContent = 'Previous';
        prevBtn.disabled = index === 0;
        prevBtn.addEventListener('click', () => renderInteractiveQuestion(index - 1));

        const nextBtn = document.createElement('button');
        nextBtn.className = 'nav-button';
        if (index === quizData.length - 1) {
            nextBtn.textContent = 'Submit Quiz';
            nextBtn.addEventListener('click', submitQuiz);
        } else {
            nextBtn.textContent = 'Next';
            nextBtn.addEventListener('click', () => renderInteractiveQuestion(index + 1));
        }
        
        // --- NEW: Create and add the Copy Quiz and Exit Quiz buttons ---
        const buttonContainer = document.createElement('div');
        buttonContainer.style.marginTop = '1rem';
        buttonContainer.style.display = 'flex';
        buttonContainer.style.flexDirection = 'column';
        buttonContainer.style.gap = '10px';

        const copyQuizBtn = document.createElement('button');
        copyQuizBtn.className = 'copy-button small';
        copyQuizBtn.id = 'copyQuizButton';
        copyQuizBtn.textContent = 'Copy Quiz';
        copyQuizBtn.addEventListener('click', copyQuiz);

        const exitBtn = document.createElement('button');
        exitBtn.className = 'exit-quiz-button';
        exitBtn.textContent = 'Exit Quiz';
        exitBtn.addEventListener('click', exitQuiz);

        buttonContainer.append(copyQuizBtn, exitBtn);
        navigation.append(prevBtn, nextBtn);
        questionDisplay.appendChild(optionsContainer);
        dom.interactiveQuizContainer.append(questionDisplay, navigation, buttonContainer);
    };

    const gradeShortAnswer = (userAnswer, correctAnswer) => {
        if (!userAnswer || !correctAnswer) return false;

        const normalizedUserAnswer = userAnswer
            .toLowerCase()
            .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ")
            .replace(/\s+/g, ' ')
            .trim();

        const keywords = correctAnswer
            .toLowerCase()
            .split(',')
            .map(k => k.trim())
            .filter(k => k);

        if (keywords.length === 0) return false;

        const isComponentBased = keywords.every(k => k.length <= 3);

        if (isComponentBased) {
            const userAnswerParts = normalizedUserAnswer.split(' ');
            return keywords.every(key => userAnswerParts.includes(key));
        } else {
            return keywords.some(key => normalizedUserAnswer.includes(key));
        }
    };

    const submitQuiz = () => {
        let score = 0;
        quizData.forEach((q, i) => {
            if (q.type === 'short_answer') {
                if (gradeShortAnswer(userAnswers[i], q.answer)) score++;
            } else {
                if (userAnswers[i] && q.answer && userAnswers[i].toLowerCase() === q.answer.toLowerCase()) {
                    score++;
                }
            }
        });

        dom.interactiveQuizContainer.innerHTML = '';
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'quiz-results';
        resultsDiv.innerHTML = `<h2>Quiz Complete!</h2><p style="text-align: center; font-size: 1.2rem; margin-bottom: 2rem;">You scored ${score} out of ${quizData.length}</p>`;
        
        quizData.forEach((q, i) => {
            const isCorrect = q.type === 'short_answer' 
                ? gradeShortAnswer(userAnswers[i], q.answer) 
                : (userAnswers[i] && q.answer && userAnswers[i].toLowerCase() === q.answer.toLowerCase());
            
            const item = document.createElement('div');
            item.className = isCorrect ? 'result-item correct' : 'result-item incorrect';
            
            let displayAnswer = q.answer;
            if (q.type === 'true_false') {
                displayAnswer = displayAnswer.charAt(0).toUpperCase() + displayAnswer.slice(1);
            } else if (q.type === 'short_answer') {
                displayAnswer = displayAnswer.replace(/,/g, ' / ');
            }

            item.innerHTML = `
                <p><strong>Q:</strong> ${q.question}</p>
                <p><strong>Your Answer:</strong> ${userAnswers[i] || 'No answer'}</p>
                <p><strong>Correct Answer:</strong> ${displayAnswer}</p>
            `;
            resultsDiv.appendChild(item);
        });

        // --- NEW: Add Copy Quiz and Exit buttons to the results page ---
        const buttonContainer = document.createElement('div');
        buttonContainer.style.marginTop = '1rem';
        buttonContainer.style.display = 'flex';
        buttonContainer.style.flexDirection = 'column';
        buttonContainer.style.gap = '10px';

        const copyQuizBtn = document.createElement('button');
        copyQuizBtn.className = 'copy-button small';
        copyQuizBtn.id = 'copyQuizButton';
        copyQuizBtn.textContent = 'Copy Quiz';
        copyQuizBtn.addEventListener('click', copyQuiz);

        const exitBtn = document.createElement('button');
        exitBtn.className = 'nav-button';
        exitBtn.textContent = 'Back to Generator';
        exitBtn.addEventListener('click', exitQuiz);

        buttonContainer.append(copyQuizBtn, exitBtn);
        resultsDiv.appendChild(buttonContainer);
        dom.interactiveQuizContainer.appendChild(resultsDiv);
    };

    // --- NEW: Function to copy the study guide ---
    const copyStudyGuide = async () => {
        if (!studyGuideMarkdown) return;
        try {
            await navigator.clipboard.writeText(studyGuideMarkdown);
            dom.copyGuideButton.textContent = 'Copied!';
            setTimeout(() => dom.copyGuideButton.textContent = 'Copy Guide', 2000);
        } catch (err) {
            showMessage('Failed to copy guide.', 'error');
        }
    };

    // --- NEW: Function to format and copy the quiz ---
    const copyQuiz = async (event) => {
        if (!quizData || quizData.length === 0) return;
        
        let quizText = "Study Guide Quiz\n====================\n\n";
        quizData.forEach((q, index) => {
            quizText += `Question ${index + 1}: ${q.question}\n`;
            if (q.type === 'multiple_choice' && q.options) {
                q.options.forEach(opt => {
                    quizText += `- ${opt}\n`;
                });
            }
            quizText += `\nCorrect Answer: ${q.answer}\n`;
            quizText += "--------------------\n\n";
        });

        try {
            await navigator.clipboard.writeText(quizText);
            const button = event.target;
            button.textContent = 'Copied!';
            setTimeout(() => button.textContent = 'Copy Quiz', 2000);
        } catch (err) {
            showMessage('Failed to copy quiz.', 'error');
        }
    };

    // --- Event Listeners ---
    dom.fileInput.addEventListener('change', async (e) => {
        for (const file of e.target.files) {
            try {
                const { type, content } = await readFileContent(file);
                uploadedFilesData.push({ id: Date.now() + Math.random(), name: file.name, type, content });
                showMessage(`Loaded "${file.name}"`, 'info');
            } catch (error) { showMessage(`Error loading "${file.name}": ${error.message}`, 'error'); }
        }
        updateFileListDisplay();
        e.target.value = '';
    });

    dom.toggleFileListButton.addEventListener('click', () => dom.fileList.classList.toggle('expanded'));
    dom.fileList.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            uploadedFilesData = uploadedFilesData.filter(f => f.id !== parseFloat(e.target.dataset.id));
            updateFileListDisplay();
        }
    });
    dom.clearFileButton.addEventListener('click', () => { uploadedFilesData = []; updateFileListDisplay(); });
    dom.inputText.addEventListener('paste', (e) => {
        for (const item of e.clipboardData.items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                e.preventDefault();
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedFilesData.push({ id: Date.now(), name: 'Pasted Image', type: blob.type, content: event.target.result.split(',')[1] });
                    updateFileListDisplay();
                    showMessage('Image pasted.', 'info');
                };
                reader.readAsDataURL(blob);
                return;
            }
        }
    });

    dom.inputPrevButton.addEventListener('click', () => showInputStep(currentInputStepIndex - 1));
    dom.inputNextButton.addEventListener('click', () => showInputStep(currentInputStepIndex + 1));
    dom.generateButton.addEventListener('click', generateStudyGuide);
    dom.startQuizButton.addEventListener('click', startQuiz);
    
    dom.clearButton.addEventListener('click', clearState);
    dom.inputText.addEventListener('input', saveState);
    dom.customInstructions.addEventListener('input', saveState);
    
    // --- NEW: Add event listener for the copy guide button ---
    dom.copyGuideButton.addEventListener('click', copyStudyGuide);

    // Initialization
    showInputStep(0);
    updateFileListDisplay();
    loadState();
}

document.addEventListener('DOMContentLoaded', () => {
    loadHeader();
    initializeStudyGuideApp();
});
</script>
</body>
</html>
